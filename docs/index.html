<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PockeTech — Field Tools v0.83</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115">

  <style>
  /* ====== THEME TOKENS ====== */
:root { color-scheme: light dark; }
:root{
  --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0;
  --card:#151922; --border:#2a2f3a; --accent:#3a7afe;
  --btn:#2b3240; --btn-fg:#e8e8e8;
  --accentSoft: rgba(58,122,254,.20);  /* NEW */
}
html[data-theme="light"]{
  --bg:#f6f8fc; --fg:#0c1116; --muted:#5a6572;
  --card:#ffffff; --border:#d6dbe3; --accent:#1f6bff;
  --btn:#eef2f7; --btn-fg:#0c1116;
  --accentSoft: rgba(31,107,255,.18);  /* NEW */
}
html[data-theme="dark"]{
  --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0;
  --card:#151922; --border:#2a2f3a; --accent:#3a7afe;
  --btn:#2b3240; --btn-fg:#e8e8e8;
  --accentSoft: rgba(58,122,254,.20);  /* NEW */
}
@media (prefers-color-scheme: light){
  html[data-theme="auto"]{
    --bg:#f6f8fc; --fg:#0c1116; --muted:#5a6572;
    --card:#ffffff; --border:#d6dbe3; --accent:#1f6bff;
    --btn:#eef2f7; --btn-fg:#0c1116;
    --accentSoft: rgba(31,107,255,.18);  /* NEW */
  }
}
@media (prefers-color-scheme: dark){
  html[data-theme="auto"]{
    --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0;
    --card:#151922; --border:#2a2f3a; --accent:#3a7afe;
    --btn:#2b3240; --btn-fg:#e8e8e8;
    --accentSoft: rgba(58,122,254,.20);  /* NEW */
  }
}

  /* ====== BASE ====== */
  *{ box-sizing:border-box }
  body{
    margin:0;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--fg);
  }
  header{
    background:var(--card); padding:12px;
    border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center;
  }
  header h1{ margin:0; font-size:18px }
  .toggle{
    padding:6px 10px; border:1px solid var(--border);
    border-radius:8px; background:var(--card); color:var(--fg); cursor:pointer;
  }
  nav{
    display:flex; flex-wrap:wrap; gap:8px; padding:10px;
    border-bottom:1px solid var(--border); background:var(--card);
    position:sticky; top:0; z-index:5;
  }
  nav button{
    background:var(--btn); color:var(--btn-fg);
    border:1px solid var(--border); padding:10px 12px;
    border-radius:10px; cursor:pointer; font-size:15px;
  }
  nav button.active{ outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(58,122,254,.15) }
  main{ padding:12px; max-width:1100px; margin:0 auto }
  section{
    display:none; background:var(--card); padding:12px;
    border:1px solid var(--border); border-radius:10px
  }
  section.active{ display:block }

  input,select,button,textarea{ padding:.65em .75em; font-size:16px; border-radius:8px }
  input,select,textarea{ width:100%; border:1px solid var(--border); background:transparent; color:var(--fg) }
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  .col{ flex:1 1 240px; min-width:240px }
  .btn{ background:var(--btn); color:var(--btn-fg); border:1px solid var(--border); cursor:pointer }
  .ok{ background:#166534; border-color:#166534 }
  .danger{ background:#8b1e1e; border-color:#8b1e1e }
  .muted{ color:var(--muted); font-size:12px }
  .hr{ height:1px; background:var(--border); margin:12px 0 }
  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px }
  th,td{ border:1px solid var(--border); padding:8px; text-align:left }
  th{ background:rgba(128,128,128,.08) }
  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:10px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px }
  .big{ font-size:28px; font-weight:600 }
  .rowline{ display:flex; align-items:center; gap:8px }
  .copy{
    cursor:pointer; border:1px dashed var(--border); padding:4px 8px;
    border-radius:8px; font-size:12px; color:var(--muted)
  }
  input[type="range"]{ width:100% }
  .steps button{ padding:.55em .7em; border-radius:999px; margin-right:6px }
  footer{ text-align:center; color:var(--muted); font-size:12px; padding:12px }

    /* Level helper hints */
#level .hint { font-size:.85rem; color: var(--muted,#6b7280); margin-top:4px }
#level .hint.error { color: #b91c1c } /* red-700 */
#level .result.big { font-size:1.15rem; font-weight:600 }

    /* ====== HOME GRID ====== */
  #home{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px }
  .home-grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:10px; margin-top:10px;
  }
  .tile{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; padding:14px 10px;
    background:var(--btn); color:var(--btn-fg);
    border:1px solid var(--border); border-radius:12px; cursor:pointer; font-size:16px;
  }
  .tile:hover{ outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(58,122,254,.15) }
  .tile:active{ transform:translateY(1px) }
  .tile span{ font-size:14px; opacity:.9 }
  /* FIXED: was `.tile::first-child` (pseudo-element). Use child selector: */
  .tile > :first-child{ font-size:22px } /* emoji size */

  /* ====== BADGES / CHIPS ====== */
  .badge{ border:1px solid var(--border); border-radius:6px; padding:.1rem .35rem; margin-left:.5rem; font-size:.8rem; opacity:.9 }
  .chipbar{ display:flex; gap:.5rem; margin:.5rem 0 }
  .chip{ padding:.25rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:.85rem }
  .chip.green{ background:rgba(0,200,0,.12) }
  .chip.red{ background:rgba(200,0,0,.12) }
  .pill{ padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border) }
  .pill-yellow{ background:rgba(255,200,0,.15) }
  .pill-green{ background:rgba(0,200,0,.12) }
  .pill-red{ background:rgba(200,0,0,.12) }

  /* ====== FLOATING NUMPAD ====== */
  .numpad{
    position:fixed; display:none; z-index:50; background:var(--card);
    border:1px solid var(--border); border-radius:12px; padding:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  .numpad.show{ display:block }
  .numpad::after{
    content:''; position:absolute; width:14px; height:14px; background:var(--card);
    border-left:1px solid var(--border); border-top:1px solid var(--border); transform:rotate(45deg)
  }
  .numpad-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; min-width:260px; max-width:min(520px,96vw) }
  .np-btn{ padding:16px; font-size:18px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--btn-fg); text-align:center; user-select:none }
  .np-wide{ grid-column:span 2 }
  .kbd-toggle{ margin-top:6px; font-size:12px; border:1px dashed var(--border); background:transparent; color:var(--muted) }

  /* ====== PERCENT PAGE (sqrt toggle) ====== */
  .percent-opts{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .percent-opts label{ display:flex; align-items:center; gap:8px; margin:6px 0 0 }
  .percent-note{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.3 }

  /* ====== LOOP RANGE HELPER (wide table on mobile) ====== */
  .scroll-x{ overflow-x:auto; -webkit-overflow-scrolling:touch }
  #lp_range_tbl{ min-width:520px }
  #lp_range_tbl th, #lp_range_tbl td{ white-space:nowrap }
  </style>
</head>

<body>

<header>
  <div class="row" style="gap:6px;align-items:center">
    <button id="backBtn" class="toggle">← Back</button>
    <h1 id="appTitle" style="margin:0;font-size:18px">PockeTech — Field Tools</h1>
  </div>
  <div class="row" style="gap:6px">
    <button id="installBtn" class="toggle">⬇️ Install</button>
    <button id="themeToggle" class="toggle">🌓 Theme</button>
    <button id="checkUpdate" class="toggle">🔄 Update</button>
    <button id="resetApp" class="toggle">🧨 Reset</button>
    <span class="badge" id="build-badge">v0.83</span>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="home">
    <h2>Field Tools</h2>
    <div class="home-grid">
  <button class="tile" data-go="percent">🧮<span>Percent</span></button>
  <button class="tile" data-go="signal">📈<span>4–20 mA</span></button>
  <button class="tile" data-go="level">🫙<span>Level</span></button>
  <button class="tile" data-go="pressure">⛽<span>Pressure</span></button>
  <button class="tile" data-go="temp">🌡️<span>Temp</span></button>
  <button class="tile" data-go="ip">🎛️<span>I/P 3–15</span></button>
  <button class="tile" data-go="jrtech">👩‍🔧<span>Jr Tech</span></button>
  <button class="tile" data-go="field_lingo">📻<span>Field Lingo</span></button>
  <button class="tile" data-go="ohm_drop">⚡<span>Ohm’s Law</span></button>
  <button class="tile" data-go="cal">📝<span>Calibration</span></button>
  <button class="tile" data-go="loop">🔄<span>Loop Log</span></button>
  <button class="tile" data-go="tickets">🎫<span>Tickets</span></button>
  <button class="tile" data-go="qr">📷<span>QR Scan</span></button>
  <button class="tile" data-go="backup">💾<span>Backup</span></button>
  <button class="tile" data-go="settings">⚙️<span>Settings</span></button>
</div>
  </section>

  <!-- PERCENT -->
  <section id="percent">
    <h2>Percent → EU Steps</h2>
    <div class="card">
      <!-- Inputs -->
      <div class="row">
        <div class="col">
          <label>LRV
            <input id="pc_lrv" class="num" inputmode="decimal" placeholder="e.g., 0">
          </label>
          <button class="kbd-toggle" data-for="pc_lrv">kbd</button>
        </div>
        <div class="col">
          <label>URV
            <input id="pc_urv" class="num" inputmode="decimal" placeholder="e.g., 250">
          </label>
          <button class="kbd-toggle" data-for="pc_urv">kbd</button>
        </div>
        <div class="col">
          <label>EU Units
            <input id="pc_eu_units" placeholder="psi, °F, %RH, etc.">
          </label>
        </div>
      </div>

      <!-- Square Root + Build/Export -->
      <div class="row" style="align-items:flex-end">
        <div class="col">
          <label class="rowline" style="flex-wrap:wrap">
            <input type="checkbox" id="pc_sqrt">
            <span>Square-root (flow DP)</span>
          </label>
          <p class="muted percent-note" style="white-space:normal">
           EU = LRV + (URV − LRV) · √(%/100)
         </p>
          <p class="muted" id="pc_span_note" style="margin:.25rem 0 0">Span: —</p>
        </div>
        <div class="col"><button class="btn" id="pc_build">Build Steps</button></div>
        <div class="col"><button class="btn" id="pc_export">Export CSV</button></div>
      </div>

      <!-- Table -->
      <div class="scroll-x" style="margin-top:10px">
        <table id="percentTable">
          <thead>
            <tr><th>%</th><th>EU</th><th>mA</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:6px">mA is always linear to % (4–20 mA). Square-root only affects EU.</p>
    </div>
  </section>
  
<!-- 4–20 mA HELPER -->
<section id="signal">
  <h2>4–20 mA Helper (Pro)</h2>

  <!-- Range & label -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>LRV (EU)
          <input id="sh_lrv" class="num" inputmode="decimal" placeholder="0">
        </label>
        <button class="kbd-toggle" data-for="sh_lrv">kbd</button>
      </div>
      <div class="col">
        <label>URV (EU)
          <input id="sh_urv" class="num" inputmode="decimal" placeholder="100">
        </label>
        <button class="kbd-toggle" data-for="sh_urv">kbd</button>
      </div>
      <div class="col">
        <label>EU Label
          <input id="sh_eulbl" placeholder="psi, °F, gpm…">
        </label>
      </div>
    </div>

    <div class="row" style="align-items:flex-end">
      <div class="col">
        <label class="rowline" style="flex-wrap:wrap">
          <input type="checkbox" id="sh_sqrt">
          <span>square-root (flow)</span>
        </label>
        <p class="muted" id="sh_span_note" style="margin:.25rem 0 0">Span: —</p>
      </div>
      <div class="col"><button class="btn" id="sh_build">Build 0/25/50/75/100</button></div>
      <div class="col"><button class="btn" id="sh_export">Export CSV</button></div>
    </div>
  </div>

  <!-- Inputs (like mini calc) -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>mA
          <input id="sh_ma" class="num" inputmode="decimal" placeholder="12">
        </label>
        <button class="kbd-toggle" data-for="sh_ma">kbd</button>
      </div>
      <div class="col">
        <label>%
          <input id="sh_pct" class="num" inputmode="decimal" placeholder="50">
        </label>
        <button class="kbd-toggle" data-for="sh_pct">kbd</button>
      </div>
      <div class="col">
        <label>EU
          <input id="sh_eu" class="num" inputmode="decimal" placeholder="—">
        </label>
        <button class="kbd-toggle" data-for="sh_eu">kbd</button>
      </div>
    </div>

    <div class="row">
      <div class="col"><button class="btn" id="sh_from_ma">From mA</button></div>
      <div class="col"><button class="btn" id="sh_from_pct">From %</button></div>
      <div class="col"><button class="btn" id="sh_from_eu">From EU</button></div>
    </div>

    <div class="hr"></div>

    <!-- Readouts + steps + slider -->
    <div class="grid">
      <div class="card">
        <div class="rowline">
          <div class="big" id="sh_read_ma">—</div>
          <span class="copy" data-copy="#sh_read_ma">copy</span>
        </div>
        <div class="muted">mA</div>
      </div>

      <div class="card">
        <div class="rowline">
          <div class="big" id="sh_read_pct">—</div>
          <span class="copy" data-copy="#sh_read_pct">copy</span>
        </div>
        <div class="muted">Percent</div>
        <div class="steps" style="margin-top:8px">
          <button class="btn sh_step" data-p="0">0%</button>
          <button class="btn sh_step" data-p="25">25%</button>
          <button class="btn sh_step" data-p="50">50%</button>
          <button class="btn sh_step" data-p="75">75%</button>
          <button class="btn sh_step" data-p="100">100%</button>
        </div>
      </div>

      <div class="card">
        <div class="rowline">
          <div class="big" id="sh_read_eu">—</div>
          <span class="copy" data-copy="#sh_read_eu">copy</span>
        </div>
        <div class="muted">Eng Units</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><input id="sh_slider" type="range" min="0" max="100" step="0.1" value="50"></div>
    </div>
    <p class="muted">Slider drives % ⇄ mA ⇄ EU live.</p>
  </div>

  <!-- Steps table -->
  <div class="card">
    <div class="scroll-x">
      <table id="sh_tbl">
        <thead><tr><th>%</th><th>mA</th><th>EU</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>
  
<!-- LEVEL (Unified) -->
<section id="level">
  <h2>Level Helper (Open / Closed)</h2>

  <!-- Guided Mode -->
  <div class="card" id="lvl_guided">
    <h3 style="margin-top:0">Guided Mode</h3>
    <div class="row">
      <div class="col">
        <label>Tank Type
          <select id="lv_type">
            <option value="open">Open tank</option>
            <option value="closed_dry">Closed — dry leg (gas)</option>
            <option value="closed_wet">Closed — wet leg</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>Tap-to-tap span
          <input id="lv_span" class="num" inputmode="decimal" placeholder="72">
        </label>
        <button class="kbd-toggle" data-for="lv_span">kbd</button>
        <div class="hint" id="hint_span">Vertical distance between the two taps.</div>
      </div>
      <div class="col">
        <label>Units
          <select id="lv_units">
            <option value="in">in</option>
            <option value="ft">ft</option>
            <option value="m">m</option>
          </select>
        </label>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Liquid SG
          <input id="lv_sg_proc" class="num" inputmode="decimal" value="1.0">
        </label>
        <button class="kbd-toggle" data-for="lv_sg_proc">kbd</button>
        <div class="hint">How heavy vs water. Water=1.00. Brine≈1.2; light solvent≈0.8.</div>
      </div>
      <div class="col only-wet" style="display:none">
        <label>Wet leg height (in)
          <input id="lv_wet_h" class="num" inputmode="decimal" placeholder="e.g., same as span">
        </label>
        <button class="kbd-toggle" data-for="lv_wet_h">kbd</button>
        <div class="hint">Filled reference leg height on the top (LP) side.</div>
      </div>
      <div class="col only-wet" style="display:none">
        <label>Wet leg SG
          <input id="lv_wet_sg" class="num" inputmode="decimal" value="1.0">
        </label>
        <button class="kbd-toggle" data-for="lv_wet_sg">kbd</button>
        <div class="hint">Often water = 1.00.</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>dP Units
          <select id="lv_dpU">
            <option value="inh2o">inH₂O</option>
            <option value="psi">psi</option>
            <option value="kpa">kPa</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>LRV (optional)
          <input id="lv_lrv" class="num" inputmode="decimal" placeholder="auto">
        </label>
        <button class="kbd-toggle" data-for="lv_lrv">kbd</button>
        <div class="hint">TX reading at 0%. Leave blank to auto.</div>
      </div>
      <div class="col">
        <label>URV (optional)
          <input id="lv_urv" class="num" inputmode="decimal" placeholder="auto">
        </label>
        <button class="kbd-toggle" data-for="lv_urv">kbd</button>
        <div class="hint">TX reading at 100%. Leave blank to auto.</div>
      </div>
    </div>

    <div class="row">
      <div class="col"><button class="btn ok" id="lv_fill">Fill the form</button></div>
    </div>
  </div>

  <!-- Advanced / Action -->
  <div class="card">
    <h3 style="margin-top:0">Calculator</h3>
    <div class="row">
      <div class="col">
        <label>Level
          <input id="lv_level" class="num" inputmode="decimal" placeholder="same units as span">
        </label>
        <button class="kbd-toggle" data-for="lv_level">kbd</button>
        <div class="hint" id="hint_level"></div>
      </div>
      <div class="col"><button class="btn" id="lv_btn_lvl2ma" disabled>Level → mA</button></div>
      <div class="col">
        <label>mA
          <input id="lv_ma" class="num" inputmode="decimal" placeholder="12">
        </label>
        <button class="kbd-toggle" data-for="lv_ma">kbd</button>
        <div class="hint" id="hint_ma"></div>
      </div>
      <div class="col"><button class="btn" id="lv_btn_ma2lvl" disabled>mA → Level</button></div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <div class="col">
        <div class="result big" id="lv_result">—</div>
        <div class="muted" id="lv_equations" style="margin-top:6px"></div>
      </div>
      <div class="col" style="max-width:160px">
        <div id="lv_tankviz" style="border:1px solid var(--border);border-radius:8px;height:140px;position:relative;background:linear-gradient(to top,var(--accentSoft) var(--fill,50%),transparent 0)"></div>
        <div class="muted" style="text-align:center;margin-top:4px" id="lv_pct_label">—</div>
      </div>
    </div>

    <div class="row"><div class="col"><button class="btn" id="lv_buildSteps">Build 0/25/50/75/100 Table</button></div></div>
    <table id="lv_steps"><thead><tr><th>%</th><th>Level</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
  </div>
</section>
  
  <!-- PRESSURE -->
  <section id="pressure">
    <h2>Pressure</h2>
    <h3>Quick Convert — “This → That”</h3>
    <div class="row">
      <div class="col"><label>Value <input id="pc_val_in" class="num" inputmode="decimal" placeholder="15"></label><button class="kbd-toggle" data-for="pc_val_in">kbd</button></div>
      <div class="col"><label>From <select id="pc_unit_in"><option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option><option value="pa">Pa</option><option value="mpa">MPa</option><option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option><option value="inhg">inHg</option><option value="mmhg">mmHg</option></select></label></div>
      <div class="col"><label>To <select id="pc_unit_out"><option value="kpa">kPa</option><option value="psi">psi</option><option value="bar">bar</option><option value="pa">Pa</option><option value="mpa">MPa</option><option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option><option value="inhg">inHg</option><option value="mmhg">mmHg</option></select></label></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" id="pc_convert">Convert</button></div>
      <div class="col"><button class="btn" id="pc_swap">Swap</button></div>
      <div class="col"><label>Result <input id="pc_val_out" readonly placeholder="—"></label></div>
    </div>
    <p class="muted">inH₂O/mmH₂O@4 °C; inHg/mmHg@0 °C (field standards).</p>

    <div class="hr"></div><h3>Gauge ↔ Absolute</h3>
    <div class="row">
      <div class="col"><label>Atmospheric (psia) <input id="atm" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="atm">kbd</button></div>
      <div class="col"><label>Gauge (psig) <input id="psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psig">kbd</button></div>
      <div class="col"><label>Absolute (psia) <input id="psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psia">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" onclick="psigToPsia()">psig → psia</button></div>
      <div class="col"><button class="btn" onclick="psiaToPsig()">psia → psig</button></div>
    </div>

    <div class="hr"></div><h3>psi ↔ kPa ↔ bar</h3>
    <div class="row">
      <div class="col"><label>psi <input id="u_psi" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_psi">kbd</button></div>
      <div class="col"><label>kPa <input id="u_kpa" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_kpa">kbd</button></div>
      <div class="col"><label>bar <input id="u_bar" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_bar">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" onclick="fromPSI()">From psi</button></div>
      <div class="col"><button class="btn" onclick="fromKPA()">From kPa</button></div>
      <div class="col"><button class="btn" onclick="fromBAR()">From bar</button></div>
    </div>

    <div class="hr"></div><h3>Pressure Switch</h3>
    <div class="row">
      <div class="col"><label>Setpoint (psig) <input id="sw_set" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_set">kbd</button></div>
      <div class="col"><label>Deadband (psig) <input id="sw_db" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_db">kbd</button></div>
      <div class="col"><label>Mode <select id="sw_mode"><option value="nc">NC (opens on rise)</option><option value="no">NO (closes on rise)</option></select></label></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="calcSwitch()">Calculate</button></div></div>
    <table id="sw_out"><tbody></tbody></table>

    <div class="hr"></div><h3>Vacuum helpers</h3>
    <div class="row">
      <div class="col"><label>Vacuum (inHg) <input id="vac_inhg" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_inhg">kbd</button></div>
      <div class="col"><label>psia <input id="vac_psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psia">kbd</button></div>
      <div class="col"><label>psig <input id="vac_psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psig">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" onclick="fromInHg()">From inHg</button></div>
      <div class="col"><button class="btn" onclick="fromPSIA()">From psia</button></div>
      <div class="col"><button class="btn" onclick="fromPSIG()">From psig</button></div>
    </div>
    <p class="muted">Assumes sea-level 14.7 psia ≈ 29.92 inHg.</p>
  </section>

  <!-- TEMP -->
  <section id="temp">
  <div class="card">
    <h2>Temp ↔ Ohms Converter</h2>

    <div class="row">
      <div class="col">
        <label for="to_sensor">Sensor Type</label>
        <select id="to_sensor">
          <option value="pt100">Pt100</option>
          <option value="pt1000">Pt1000</option>
          <option value="ntc10k">10 kΩ NTC (B=3950)</option>
        </select>
      </div>
      <div class="col">
        <label for="to_units">Units</label>
        <select id="to_units">
          <option value="F">°F</option>
          <option value="C">°C</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <h3>Temp → Ohms</h3>
    <div class="row">
      <div class="col">
        <label>Temperature</label>
        <input id="to_temp_in" type="number" placeholder="Enter temperature">
      </div>
      <div class="col">
        <label>Resistance (Ω)</label>
        <div class="rowline">
          <input id="to_ohms_out" type="text" readonly>
          <span class="copy" data-copy="#to_ohms_out">copy</span>
        </div>
      </div>
    </div>
    <button id="to_temp_convert" class="btn ok">Convert Temp → Ω</button>

    <div class="hr"></div>

    <h3>Ohms → Temp</h3>
    <div class="row">
      <div class="col">
        <label>Resistance (Ω)</label>
        <input id="to_ohms_in" type="number" placeholder="Enter resistance">
      </div>
      <div class="col">
        <label>Temperature</label>
        <div class="rowline">
          <input id="to_temp_out" type="text" readonly>
          <span class="copy" data-copy="#to_temp_out">copy</span>
        </div>
      </div>
    </div>
    <button id="to_ohms_convert" class="btn ok">Convert Ω → Temp</button>

    <p class="muted" style="margin-top:8px;">
      ℹ️ RTDs go <b>up</b> in resistance with heat. Thermistors go <b>down</b>.
    </p>
  </div>

  <div class="card" style="margin-top:10px">
    <h2>Temperature Converter</h2>
    <div class="row">
      <div class="col">
        <label>Value</label>
        <input id="tc_val" type="number" placeholder="e.g., 68">
      </div>
      <div class="col">
        <label>From</label>
        <select id="tc_from">
          <option value="F">°F</option>
          <option value="C">°C</option>
          <option value="K">K</option>
        </select>
      </div>
      <div class="col">
        <label>To</label>
        <select id="tc_to">
          <option value="C">°C</option>
          <option value="F">°F</option>
          <option value="K">K</option>
        </select>
      </div>
      <div class="col">
        <label>Result</label>
        <div class="rowline">
          <input id="tc_out" type="text" readonly placeholder="—">
          <span class="copy" data-copy="#tc_out">copy</span>
        </div>
      </div>
    </div>
    <button id="tc_conv_btn" class="btn ok">Convert</button>
  </div>

  <div class="card" style="margin-top:10px">
    <h2>Delta (Δ) Converter</h2>
    <div class="row">
      <div class="col">
        <label>ΔValue</label>
        <input id="td_val" type="number" placeholder="e.g., 10">
      </div>
      <div class="col">
        <label>From</label>
        <select id="td_from">
          <option value="C">Δ°C</option>
          <option value="F">Δ°F</option>
          <option value="K">ΔK</option>
        </select>
      </div>
      <div class="col">
        <label>To</label>
        <select id="td_to">
          <option value="C">Δ°C</option>
          <option value="F">Δ°F</option>
          <option value="K">ΔK</option>
        </select>
      </div>
      <div class="col">
        <label>Result</label>
        <div class="rowline">
          <input id="td_out" type="text" readonly placeholder="—">
          <span class="copy" data-copy="#td_out">copy</span>
        </div>
      </div>
    </div>
    <button id="td_conv_btn" class="btn ok">Convert Δ</button>
    <p class="muted" style="margin-top:6px">
      Δ = change. Example: a 10 °C rise equals an 18 °F rise (×9/5). Δ°C and ΔK are the same size.
    </p>
  </div>
</section>
  
  <!-- I/P -->
  <section id="ip">
    <h2>I/P 3–15 psi Helper</h2>
    <div class="row">
      <div class="col"><label>% <input id="ip_pct" class="num" inputmode="decimal" placeholder="50"></label><button class="kbd-toggle" data-for="ip_pct">kbd</button></div>
      <div class="col"><label>psi <input id="ip_psi" class="num" inputmode="decimal" placeholder="9"></label><button class="kbd-toggle" data-for="ip_psi">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" id="ip_from_pct">From %</button></div>
      <div class="col"><button class="btn" id="ip_from_psi">From psi</button></div>
    </div>
    <div class="hr"></div>
    <div class="grid">
      <div class="card">
        <div class="rowline"><div class="big" id="ip_read_pct">—</div><span class="copy" data-copy="#ip_read_pct">copy</span></div>
        <div class="muted">Percent</div>
        <div class="steps" style="margin-top:8px">
          <button class="btn ipstep" data-p="0">0%</button>
          <button class="btn ipstep" data-p="25">25%</button>
          <button class="btn ipstep" data-p="50">50%</button>
          <button class="btn ipstep" data-p="75">75%</button>
          <button class="btn ipstep" data-p="100">100%</button>
        </div>
      </div>
      <div class="card">
        <div class="rowline"><div class="big" id="ip_read_psi">—</div><span class="copy" data-copy="#ip_read_psi">copy</span></div>
        <div class="muted">psi (3–15)</div>
      </div>
    </div>
  </section>

  <!-- JR TECH -->
  <section id="jrtech">
    <h2>Jr Tech Quick Reference</h2>

    <!-- Search -->
    <div class="row">
      <div class="col">
        <label>Search this page
          <input id="jt_search" placeholder="filter tables and notes…">
        </label>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <!-- Thermocouple & RTD Color Codes -->
      <div class="card jt-card">
        <h3 style="margin-top:0">Thermocouple &amp; RTD Color Codes</h3>
        <div class="row">
          <div class="col">
            <label>Standard
              <select id="tc_std">
                <option value="ANSI">ANSI (US)</option>
                <option value="IEC">IEC (International)</option>
              </select>
            </label>
          </div>
        </div>
        <table id="tc_tbl">
          <thead>
            <tr><th>Type</th><th>+ Lead</th><th>– Lead</th><th>Notes</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted" style="margin-top:6px">
          Tip: Red is <strong>negative</strong> in ANSI thermocouples. Always follow site standards/drawings if they differ.
        </div>
        <div class="hr"></div>
        <h4 style="margin-bottom:6px">RTD (Pt100) common wiring</h4>
        <table id="rtd_tbl">
          <thead>
            <tr><th>Wires</th><th>Common Colors</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>2-wire</td><td>Any pair (vendor specific)</td><td>Lead resistance adds error; rarely used for precision.</td></tr>
            <tr><td>3-wire</td><td>ANSI: Red, Red, White • IEC: Red, Red, White (or Red, White, White)</td><td>Controller compensates one lead.</td></tr>
            <tr><td>4-wire</td><td>Pairs of same colors</td><td>Best accuracy; two sense, two drive.</td></tr>
          </tbody>
        </table>
        <p class="muted">Vendors vary; check the instrument datasheet.</p>
      </div>

      <!-- Temperature Element Ranges -->
      <div class="card jt-card" id="tr_card">
        <h3 style="margin-top:0">Temperature Element Ranges</h3>

        <div class="row">
          <div class="col">
            <label>Element Type
              <select id="tr_type">
                <optgroup label="Thermocouples">
                  <option value="TC_J">Type J</option>
                  <option value="TC_K" selected>Type K</option>
                  <option value="TC_T">Type T</option>
                  <option value="TC_E">Type E</option>
                  <option value="TC_N">Type N</option>
                  <option value="TC_R">Type R</option>
                  <option value="TC_S">Type S</option>
                  <option value="TC_B">Type B</option>
                </optgroup>
                <optgroup label="RTDs">
                  <option value="RTD_Pt100_A">Pt100 (Class A)</option>
                  <option value="RTD_Pt100_B">Pt100 (Class B)</option>
                  <option value="RTD_Pt1000_A">Pt1000 (Class A)</option>
                  <option value="RTD_Pt1000_B">Pt1000 (Class B)</option>
                </optgroup>
              </select>
            </label>
          </div>
          <div class="col">
            <label>Notes <input id="tr_notes_out" readonly></label>
          </div>
          <div class="col">
            <button class="btn" id="tr_export">Export CSV</button>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <table id="tr_tbl">
              <thead>
                <tr>
                  <th>Min (°C)</th><th>Max (°C)</th>
                  <th>Min (°F)</th><th>Max (°F)</th>
                  <th>Typical Use</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <p class="muted" style="margin:.5rem 0 0">
              Ranges are typical/practical values. Always check the specific sensor &amp; sheath rating.
            </p>
          </div>
        </div>
      </div>

      <!-- 24 VDC Loop Wiring Cheats -->
      <div class="card jt-card">
        <h3 style="margin-top:0">24 VDC Loop Wiring Cheats</h3>
        <ul>
          <li><strong>4–20 mA 2-wire TX:</strong> +24V → <em>TX +</em> → <em>TX –</em> → AI+</li>
          <li><strong>Insert ammeter (series):</strong> break the loop on the <strong>positive</strong> side and wire meter <strong>in series</strong> (observe polarity).</li>
          <li><strong>Shields:</strong> land at one end only (typically at the marshaling/DAI end) unless your site spec says otherwise.</li>
          <li><strong>Source vs Sink AIs:</strong> check card manual; wrong polarity = flatline 0 or card fault.</li>
        </ul>
        <pre class="muted" style="white-space:pre; overflow:auto; padding:8px; border:1px dashed var(--border); border-radius:8px;">
+24V ──┬─────────────┐
       │             │
       │         ( + ) Transmitter ( – )
       │             │
      AI+           AI–
       │             │
      0V ────────────┘
(Series meter goes between +24V and TX+ when measuring loop current)
        </pre>
      </div>

      <!-- Control Valve Actions -->
      <div class="card jt-card">
        <h3 style="margin-top:0">Control Valve Actions</h3>
        <table>
          <thead>
            <tr><th>Action</th><th>Fail Position</th><th>Controller Tuning Hint</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Air-to-Open (ATO)</td>
              <td>Fail Close (FC)</td>
              <td>Controller often <strong>reverse-acting</strong></td>
              <td>As air ↑, valve opens. Spring pushes it closed on air loss.</td>
            </tr>
            <tr>
              <td>Air-to-Close (ATC)</td>
              <td>Fail Open (FO)</td>
              <td>Controller often <strong>direct-acting</strong></td>
              <td>As air ↑, valve closes. Spring opens on air loss.</td>
            </tr>
          </tbody>
        </table>
        <p class="muted">Bench set typically around 3–15 psi via I/P. Confirm action/fail in P&amp;ID or actuator tag.</p>
      </div>

      <!-- Instrument Tag Abbreviations -->
      <div class="card jt-card">
        <h3 style="margin-top:0">Instrument Tag Abbreviations (ISA-style)</h3>
        <table id="isa_tbl">
          <thead><tr><th>Tag</th><th>Plain English</th></tr></thead>
          <tbody>
            <tr><td>LIC</td><td>Level Indicating Controller</td></tr>
            <tr><td>FIC</td><td>Flow Indicating Controller</td></tr>
            <tr><td>PIC</td><td>Pressure Indicating Controller</td></tr>
            <tr><td>TIC</td><td>Temperature Indicating Controller</td></tr>
            <tr><td>PSV</td><td>Pressure Safety Valve (relief)</td></tr>
            <tr><td>LSHH / LSLL</td><td>Level Switch High-High / Low-Low</td></tr>
            <tr><td>LT / PT / TT / FT</td><td>Level / Pressure / Temperature / Flow Transmitter</td></tr>
            <tr><td>XV / CV</td><td>On/Off Valve / Control Valve</td></tr>
          </tbody>
        </table>
        <p class="muted">Local site conventions can differ. Always follow the legend on the project’s P&amp;IDs.</p>
      </div>

      <!-- Common Signal Sanity Checks -->
      <div class="card jt-card">
        <h3 style="margin-top:0">Common Signal Sanity Checks</h3>
        <ul>
          <li><strong>4–20 mA → %:</strong> (mA − 4) / 16 × 100</li>
          <li><strong>% → 4–20 mA:</strong> 4 + 16 × (% / 100)</li>
          <li><strong>0–10 V → %:</strong> V / 10 × 100</li>
          <li><strong>3–15 psi (I/P):</strong> 3 + 12 × (% / 100)</li>
          <li><strong>Square-root?</strong> Use for DP-flow; level/pressure are linear.</li>
        </ul>
        <div class="row">
          <div class="col"><button class="btn" data-jt-nav="#signal">Open 4–20 mA Helper</button></div>
        </div>
        <p class="muted">If reading is off: verify TX range (LRV/URV), wiring polarity, loop power, and card type (source/sink).</p>
      </div>
   </div>
  </section>
      
  
    <!-- Field Lingo -->
  <section id="field_lingo">
    <h2>Field Lingo</h2>
    <div class="row">
      <div class="col"><label>Quick Search <input id="fl_search" placeholder="type to filter…"></label></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Spelling Alphabet</h3>
        <table id="fl_alpha">
          <thead><tr><th>Char</th><th>Word</th><th>Note</th></tr></thead>
          <tbody>
            <tr><td>A</td><td>Alpha</td><td></td></tr>
            <tr><td>B</td><td>Bravo</td><td>B vs P: pause</td></tr>
            <tr><td>C</td><td>Charlie</td><td></td></tr>
            <tr><td>D</td><td>Delta</td><td></td></tr>
            <tr><td>E</td><td>Echo</td><td></td></tr>
            <tr><td>F</td><td>Foxtrot</td><td>F vs S: enunciate</td></tr>
            <tr><td>G</td><td>Golf</td><td></td></tr>
            <tr><td>H</td><td>Hotel</td><td></td></tr>
            <tr><td>I</td><td>India</td><td></td></tr>
            <tr><td>J</td><td>Juliett</td><td></td></tr>
            <tr><td>K</td><td>Kilo</td><td></td></tr>
            <tr><td>L</td><td>Lima</td><td></td></tr>
            <tr><td>M</td><td>Mike</td><td>M vs N: slow</td></tr>
            <tr><td>N</td><td>November</td><td></td></tr>
            <tr><td>O</td><td>Oscar</td><td></td></tr>
            <tr><td>P</td><td>Papa</td><td></td></tr>
            <tr><td>Q</td><td>Quebec</td><td></td></tr>
            <tr><td>R</td><td>Romeo</td><td></td></tr>
            <tr><td>S</td><td>Sierra</td><td></td></tr>
            <tr><td>T</td><td>Tango</td><td></td></tr>
            <tr><td>U</td><td>Uniform</td><td></td></tr>
            <tr><td>V</td><td>Victor</td><td></td></tr>
            <tr><td>W</td><td>Whiskey</td><td></td></tr>
            <tr><td>X</td><td>X-ray</td><td></td></tr>
            <tr><td>Y</td><td>Yankee</td><td></td></tr>
            <tr><td>Z</td><td>Zulu</td><td></td></tr>
            <tr><td>0</td><td>Zero</td><td>say “zero”</td></tr>
            <tr><td>1</td><td>One</td><td></td></tr>
            <tr><td>2</td><td>Two</td><td>say “too” clearly</td></tr>
            <tr><td>3</td><td>Tree</td><td>radio “three”</td></tr>
            <tr><td>4</td><td>Fower</td><td>radio “four”</td></tr>
            <tr><td>5</td><td>Fife</td><td>radio “five”</td></tr>
            <tr><td>6</td><td>Six</td><td></td></tr>
            <tr><td>7</td><td>Seven</td><td></td></tr>
            <tr><td>8</td><td>Eight</td><td></td></tr>
            <tr><td>9</td><td>Niner</td><td>radio “nine”</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Radio Prowords</h3>
        <table id="fl_prowords">
          <thead><tr><th>Word</th><th>Meaning</th></tr></thead>
          <tbody>
            <tr><td>Affirmative</td><td>Yes</td></tr>
            <tr><td>Negative</td><td>No</td></tr>
            <tr><td>Say again</td><td>Repeat</td></tr>
            <tr><td>Standby</td><td>Wait</td></tr>
            <tr><td>Copy</td><td>Received/understood</td></tr>
            <tr><td>Over</td><td>My turn done; your turn</td></tr>
            <tr><td>Out</td><td>Conversation complete</td></tr>
            <tr><td>Wilco</td><td>Will comply</td></tr>
            <tr><td>Break</td><td>New subject or separation</td></tr>
          </tbody>
        </table>
        <p class="muted">Avoid “yeah/uh-huh”. Use clear numbers and “point” for decimals.</p>
      </div>

      <div class="card">
        <h3 style="margin-top:0">SI Prefixes</h3>
        <table id="fl_prefix">
          <thead><tr><th>Prefix</th><th>Symbol</th><th>×10^</th><th>Example</th></tr></thead>
          <tbody>
            <tr><td>nano</td><td>n</td><td>−9</td><td>nA</td></tr>
            <tr><td>micro</td><td>µ</td><td>−6</td><td>µA</td></tr>
            <tr><td>milli</td><td>m</td><td>−3</td><td>mA, mV</td></tr>
            <tr><td>kilo</td><td>k</td><td>+3</td><td>kPa, kΩ</td></tr>
            <tr><td>mega</td><td>M</td><td>+6</td><td>MW, MΩ</td></tr>
            <tr><td>giga</td><td>G</td><td>+9</td><td>GΩ</td></tr>
            <tr><td>tera</td><td>T</td><td>+12</td><td>TΩ</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Unit Shorthands</h3>
        <p class="muted">psi, kPa, bar, °F, °C, V, mA, mV, Ω, kΩ, kW, rpm, gpm, inH₂O, inHg, mmHg</p>
      </div>
    </div>
  </section>

  <!-- Ohm’s Law & Voltage Drop -->
  <section id="ohm_drop">
    <h2>Ohm’s Law & Voltage Drop</h2>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Ohm’s Law Solver</h3>
        <div class="row">
          <div class="col"><label>V (volts) <input id="ol_v" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="ol_v">kbd</button></div>
          <div class="col"><label>I (amps) <input id="ol_i" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="ol_i">kbd</button></div>
          <div class="col"><label>R (ohms) <input id="ol_r" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="ol_r">kbd</button></div>
          <div class="col"><label>P (watts) <input id="ol_p" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="ol_p">kbd</button></div>
        </div>
        <div class="row">
          <div class="col"><button class="btn" id="ol_solve">Solve</button></div>
          <div class="col"><button class="btn danger" id="ol_clear">Clear</button></div>
        </div>
        <div class="grid" style="margin-top:8px">
          <div class="card"><div class="rowline"><div class="big" id="ol_out_v">—</div><span class="copy" data-copy="#ol_out_v">copy</span></div><div class="muted">V</div></div>
          <div class="card"><div class="rowline"><div class="big" id="ol_out_i">—</div><span class="copy" data-copy="#ol_out_i">copy</span></div><div class="muted">I</div></div>
          <div class="card"><div class="rowline"><div class="big" id="ol_out_r">—</div><span class="copy" data-copy="#ol_out_r">copy</span></div><div class="muted">R</div></div>
          <div class="card"><div class="rowline"><div class="big" id="ol_out_p">—</div><span class="copy" data-copy="#ol_out_p">copy</span></div><div class="muted">P</div></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Voltage Drop</h3>
        <div class="row">
          <div class="col">
            <label>System
              <select id="vd_sys"><option value="dc">DC / 1-φ</option><option value="3ph">3-phase</option></select>
            </label>
          </div>
          <div class="col"><label>Supply V <input id="vd_v" class="num" inputmode="decimal" placeholder="24"></label><button class="kbd-toggle" data-for="vd_v">kbd</button></div>
          <div class="col"><label>Load I (A) <input id="vd_i" class="num" inputmode="decimal" placeholder="0.02"></label><button class="kbd-toggle" data-for="vd_i">kbd</button></div>
        </div>
        <div class="row">
          <div class="col"><label>Run length <input id="vd_len" class="num" inputmode="decimal" placeholder="200"></label><button class="kbd-toggle" data-for="vd_len">kbd</button></div>
          <div class="col">
            <label>Units
              <select id="vd_units"><option value="ft">ft</option><option value="m">m</option></select>
            </label>
          </div>
          <div class="col">
            <label>Material
              <select id="vd_mat"><option value="cu">Copper</option><option value="al">Aluminum</option></select>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Conductor size
              <select id="vd_awg">
                <option>18</option><option>16</option><option>14</option><option selected>12</option>
                <option>10</option><option>8</option><option>6</option><option>4</option>
                <option>2</option><option>1</option><option>1/0</option><option>2/0</option>
                <option>3/0</option><option>4/0</option>
              </select>
            </label>
          </div>
          <div class="col"><label>Target drop (%) <input id="vd_target" class="num" inputmode="decimal" placeholder="3"></label><button class="kbd-toggle" data-for="vd_target">kbd</button></div>
        </div>
        <div class="row">
          <div class="col"><button class="btn" id="vd_calc">Calculate</button></div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div class="card"><div class="rowline"><div class="big" id="vd_out_vd">—</div><span class="copy" data-copy="#vd_out_vd">copy</span></div><div class="muted">Drop (V)</div></div>
          <div class="card"><div class="rowline"><div class="big" id="vd_out_pct">—</div><span class="copy" data-copy="#vd_out_pct">copy</span></div><div class="muted">% Drop</div></div>
          <div class="card"><div class="rowline"><div class="big" id="vd_out_end">—</div><span class="copy" data-copy="#vd_out_end">copy</span></div><div class="muted">End Voltage (V)</div></div>
        </div>
        <p class="muted" id="vd_suggest"></p>
      </div>
    </div>
  </section>

  <!-- Calibration -->
  <section id="cal">
    <h2>Calibration Tracker</h2>
    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="col"><label>Date <input id="cal_date" type="date"></label></div>
          <div class="col"><label>Tag <input id="cal_tag" placeholder="PT-101"></label></div>
          <div class="col"><label>Device <input id="cal_dev" placeholder="3051, I/P, Thermo"></label></div>
        </div>
        <div class="row">
          <div class="col"><label>LRV <input id="cal_lrv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_lrv">kbd</button></div>
          <div class="col"><label>URV <input id="cal_urv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_urv">kbd</button></div>
          <div class="col"><label>As-Found <input id="cal_af" class="num" inputmode="decimal" placeholder="error % or EU"></label><button class="kbd-toggle" data-for="cal_af">kbd</button></div>
        </div>
        <div class="row">
          <div class="col"><label>As-Left <input id="cal_al" class="num" inputmode="decimal" placeholder="error % or EU"></label><button class="kbd-toggle" data-for="cal_al">kbd</button></div>
          <div class="col"><label>Tech <input id="cal_tech" placeholder="Initials"></label></div>
          <div class="col"><label>Interval
            <select id="cal_interval">
              <option value="0">None</option>
              <option value="3">3 months</option>
              <option value="6">6 months</option>
              <option value="12">12 months</option>
            </select></label>
          </div>
        </div>
        <div class="row">
          <div class="col"><label>Notes <input id="cal_notes" placeholder="optional note"></label></div>
          <div class="col"><button class="btn ok" id="cal_add">Add</button></div>
          <div class="col"><button class="btn" id="cal_export">Export CSV</button></div>
          <div class="col"><button class="btn danger" id="cal_clear">Clear All</button></div>
        </div>
      </div>
      <div class="card">
        <table id="cal_tbl"><thead>
          <tr><th>Date</th><th>Tag</th><th>Device</th><th>LRV</th><th>URV</th><th>As-Found</th><th>As-Left</th><th>Tech</th><th>Notes</th><th>Next Due</th><th>Status</th><th></th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Loop Log -->
  <section id="loop">
    <h2>Loop Check Log</h2>

    <!-- Mini 4–20 mA Quick Calc (always visible) -->
    <div class="card" id="ll_calc_card">
      <h3 style="margin-top:0">4–20 mA Quick Calc</h3>
      <div class="row">
        <div class="col">
          <label>LRV (EU)
            <input id="ll_lrv" class="num" inputmode="decimal" placeholder="0">
          </label>
          <button class="kbd-toggle" data-for="ll_lrv">kbd</button>
        </div>
        <div class="col">
          <label>URV (EU)
            <input id="ll_urv" class="num" inputmode="decimal" placeholder="100">
          </label>
          <button class="kbd-toggle" data-for="ll_urv">kbd</button>
        </div>
        <div class="col">
          <label>EU Label
            <input id="ll_eulbl" placeholder="psi, °F, gpm…">
          </label>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>% <input id="ll_pct" class="num" inputmode="decimal" placeholder="50"></label>
          <button class="kbd-toggle" data-for="ll_pct">kbd</button>
        </div>
        <div class="col">
          <label>mA <input id="ll_ma" class="num" inputmode="decimal" placeholder="12"></label>
          <button class="kbd-toggle" data-for="ll_ma">kbd</button>
        </div>
        <div class="col">
          <label>EU <input id="ll_eu" class="num" inputmode="decimal" placeholder="—"></label>
          <button class="kbd-toggle" data-for="ll_eu">kbd</button>
        </div>
      </div>

      <div class="row">
        <div class="col"><button class="btn" id="ll_from_pct">From %</button></div>
        <div class="col"><button class="btn" id="ll_from_ma">From mA</button></div>
        <div class="col"><button class="btn" id="ll_from_eu">From EU</button></div>
      </div>

      <div class="hr"></div>
      <div class="grid">
        <div class="card"><div class="rowline"><div class="big" id="ll_read_ma">—</div><span class="copy" data-copy="#ll_read_ma">copy</span></div><div class="muted">mA</div></div>
        <div class="card">
          <div class="rowline"><div class="big" id="ll_read_pct">—</div><span class="copy" data-copy="#ll_read_pct">copy</span></div>
          <div class="muted">Percent</div>
          <div class="steps" style="margin-top:8px">
            <button class="btn ll_step" data-p="0">0%</button>
            <button class="btn ll_step" data-p="25">25%</button>
            <button class="btn ll_step" data-p="50">50%</button>
            <button class="btn ll_step" data-p="75">75%</button>
            <button class="btn ll_step" data-p="100">100%</button>
          </div>
        </div>
        <div class="card">
          <div class="rowline"><div class="big" id="ll_read_eu">—</div><span class="copy" data-copy="#ll_read_eu">copy</span></div>
          <div class="muted">Eng Units</div>
          <label class="rowline" style="margin-top:8px;flex-wrap:wrap">
            <input type="checkbox" id="ll_sqrt_mode"><span style="flex:1 1 140px;min-width:0">square-root (flow)</span>
          </label>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="col"><input id="ll_slider" type="range" min="0" max="100" step="0.1" value="50"></div>
      </div>
      <p class="muted">This quick calc is just for convenience while logging loops; it doesn’t overwrite your main 4–20 tool.</p>
    </div>

    <!-- Range & Alarms (for the loop/device context snapshot) -->
<div class="card">
  <h3 style="margin-top:0">Range & Alarms (Snapshot)</h3>

  <div class="row">
    <div class="col"><label>LRV <input id="lp_lrv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_lrv">kbd</button></div>
    <div class="col"><label>URV <input id="lp_urv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_urv">kbd</button></div>
    <div class="col"><label>EU Units <input id="lp_eu_units" placeholder="psi, °F, etc."></label></div>
  </div>

  <div class="row">
    <div class="col"><label>LLL <input id="lp_lll" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_lll">kbd</button></div>
    <div class="col"><label>LL <input id="lp_ll" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_ll">kbd</button></div>
    <div class="col"><label>L <input id="lp_l" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_l">kbd</button></div>
  </div>

  <div class="row">
    <div class="col"><label>H <input id="lp_h" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_h">kbd</button></div>
    <div class="col"><label>HH <input id="lp_hh" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_hh">kbd</button></div>
    <div class="col"><label>HHH <input id="lp_hhh" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_hhh">kbd</button></div>
  </div>

  <div class="row">
    <div class="col"><label>Device Range <input id="lp_dev" placeholder="e.g., 0–250 psi"></label></div>
  </div>

  <div class="row">
    <div class="col">
      <label>Device Serial #
        <input id="lp_dev_sn" placeholder="e.g., 12345ABC">
      </label>
      <button class="kbd-toggle" data-for="lp_dev_sn">kbd</button>
    </div>
    <div class="col">
      <label>Device Model #
        <input id="lp_dev_model" placeholder="e.g., Rosemount 3051">
      </label>
      <button class="kbd-toggle" data-for="lp_dev_model">kbd</button>
    </div>
  </div>
</div>

    <!-- Entry form (Expected/Measured removed) -->
    <div class="card">
      <h3 style="margin-top:0">Add Loop Entry</h3>
      <div class="row">
        <div class="col"><label>Date <input id="lp_date" type="date"></label></div>
        <div class="col"><label>Tag <input id="lp_tag" placeholder="LT-204"></label></div>
        <div class="col"><label>Point (AI/AO/DI/DO) <input id="lp_point" placeholder="AI-101"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Units
          <select id="lp_units">
            <option value="%">%</option><option value="mA">mA</option><option value="psi">psi</option>
            <option value="°F">°F</option><option value="EU">EU</option>
          </select></label>
        </div>
        <div class="col"><label>OK? <select id="lp_ok"><option value="YES">YES</option><option value="NO">NO</option></select></label></div>
        <div class="col"><label>Notes <input id="lp_notes" placeholder="optional note"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn ok" id="lp_add">Add</button></div>
        <div class="col"><button class="btn" id="lp_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="lp_clear">Clear All</button></div>
      </div>
      <div class="chipbar">
        <span class="chip green" id="loop-pass">Pass: 0</span>
        <span class="chip red" id="loop-fail">Fail: 0</span>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <table id="lp_tbl">
        <thead>
          <tr>
            <th>Date</th><th>Tag</th><th>Point</th><th>Units</th><th>OK</th><th>Notes</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Tickets -->
  <section id="tickets">
    <h2>Tickets</h2>
    <div class="card">
      <div class="row">
        <div class="col"><label>Date <input id="tk_date" type="date"></label></div>
        <div class="col"><label>Area/Unit <input id="tk_area" placeholder="Unit A"></label></div>
        <div class="col"><label>Tag <input id="tk_tag" placeholder="PT-101"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Summary <input id="tk_sum" placeholder="Short description"></label></div>
        <div class="col"><label>Status <select id="tk_status"><option>OPEN</option><option>WIP</option><option>CLOSED</option></select></label></div>
        <div class="col"><label>Photo <input id="tk_photo" type="file" accept="image/*"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn ok" id="tk_add">Add</button></div>
        <div class="col"><button class="btn" id="tk_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="tk_clear">Clear All</button></div>
      </div>
    </div>
    <div class="card">
      <table id="tk_tbl"><thead>
        <tr><th>Date</th><th>Area</th><th>Tag</th><th>Summary</th><th>Status</th><th>Photo</th><th></th></tr>
      </thead><tbody></tbody></table>
    </div>
  </section>

  <!-- QR -->
  <section id="qr">
    <h2>QR Scan</h2>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn" id="qr_live_btn">Start Live Scan</button></div>
        <div class="col"><label>or Import Photo <input id="qr_file" type="file" accept="image/*"></label></div>
      </div>
      <video id="qr_video" playsinline style="width:100%;max-height:260px;border:1px solid var(--border);border-radius:8px;display:none"></video>
      <canvas id="qr_canvas" style="display:none"></canvas>
      <div class="hr"></div>
      <div class="rowline"><div class="big" id="qr_out">—</div><span class="copy" data-copy="#qr_out">copy</span></div>
      <p class="muted">If your browser doesn’t support live QR, use “Import Photo”.</p>
    </div>
  </section>

  <!-- Backup -->
  <section id="backup">
    <h2>Backup & Restore</h2>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn" id="bk_export">Export All (JSON)</button></div>
        <div class="col"><label>Restore JSON <input id="bk_file" type="file" accept="application/json"></label></div>
        <div class="col"><button class="btn danger" id="bk_wipe">Wipe All Data</button></div>
      </div>
      <p class="muted">Included: Settings, Calibration, Loop Log, Tickets (with embedded photos).</p>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings">
    <h2>Settings</h2>
    <div class="row">
      <div class="col"><label>Default Atmosphere (psia) <input id="s_atm" class="num" inputmode="decimal" placeholder="14.7"></label><button class="kbd-toggle" data-for="s_atm">kbd</button></div>
      <div class="col"><label>Default Pressure Unit <select id="s_punit"><option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option></select></label></div>
      <div class="col"><label>Default Level Unit <select id="s_lunit"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
    </div>
    <div class="row"><div class="col"><label class="rowline"><input type="checkbox" id="s_haptics"> Haptics on keypad taps</label></div></div>
    <div class="row"><div class="col"><button class="btn ok" id="s_save">Save</button></div><div class="col"><button class="btn danger" id="s_reset">Reset to defaults</button></div></div>
  </section>
</main>

<!-- Number pad -->
<div id="numpad" class="numpad" aria-hidden="true">
  <div class="numpad-grid">
    <div class="np-btn">7</div><div class="np-btn">8</div><div class="np-btn">9</div><div class="np-btn" data-act="back">⌫</div>
    <div class="np-btn">4</div><div class="np-btn">5</div><div class="np-btn">6</div><div class="np-btn" data-act="clear">C</div>
    <div class="np-btn">1</div><div class="np-btn">2</div><div class="np-btn">3</div><div class="np-btn" data-val="-">−</div>
    <div class="np-btn np-wide">0</div><div class="np-btn">.</div><div class="np-btn np-wide" data-act="done">Done</div>
  </div>
</div>

<footer class="muted">PockeTech — v0.83</footer>

<!-- iOS Add-to-Home instructions modal -->
<div id="iosInstallTip" style="display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,.55);align-items:center;justify-content:center">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;max-width:520px;padding:16px">
    <h3 style="margin-top:0">Add to Home Screen</h3>
    <ol style="line-height:1.6">
      <li>Tap the <strong>Share</strong> icon in Safari.</li>
      <li>Choose <strong>Add to Home Screen</strong>.</li>
      <li>Tap <strong>Add</strong>.</li>
    </ol>
    <p class="muted">On iPhone/iPad, installation is via Share → Add to Home Screen.</p>
    <div style="text-align:right;margin-top:10px"><button class="btn" id="iosTipClose">Close</button></div>
  </div>
</div>

<script>
/* ========= SETTINGS + THEME ========= */
const SKEY='pocketech.settings';
const DEF={atm:14.7,punit:'psi',lunit:'in',haptics:false,theme:'auto'};
const getS=()=>({...DEF, ...(JSON.parse(localStorage.getItem(SKEY)||'{}'))});
const setS=o=>localStorage.setItem(SKEY, JSON.stringify(o));
function applyTheme(){ document.documentElement.setAttribute('data-theme', getS().theme||'auto'); }
applyTheme();
matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{ if(getS().theme==='auto') applyTheme(); });

// Theme toggle (auto → light → dark)
const themeBtn=document.getElementById('themeToggle');
function setThemeBtnLabel(){
  const t=getS().theme||'auto';
  if(!themeBtn) return;
  themeBtn.textContent = (t==='dark') ? '🌙 Dark'
                        : (t==='light')? '☀️ Light'
                        : '🌓 Theme';
}
function cycleTheme(){
  const order=['auto','light','dark'];
  const s=getS();
  const idx=Math.max(0, order.indexOf(s.theme||'auto'));
  s.theme=order[(idx+1)%order.length];
  setS(s); applyTheme(); setThemeBtnLabel();
}
setThemeBtnLabel();
themeBtn?.addEventListener('click', cycleTheme);

/* ========= STORAGE + UTILS (define ONCE) ========= */
const load=(k)=>{ try{return JSON.parse(localStorage.getItem(k))||[]}catch{return[]} };
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
function fmt(v){
  if(v===null||v===undefined||v==='')return '';
  const n=Number(v);
  if(!Number.isFinite(n)) return String(v);
  return (Math.abs(n)>=1000||n===0) ? n.toFixed(2).replace(/\.00$/,'')
                                   : n.toFixed(4).replace(/0+$/,'').replace(/\.$/,'');
}
function toCSV(rows){return rows.map(r=>r.map(c=>{const s=(c??'').toString();return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n');}
function downloadCSV(name,rows){const blob=new Blob([toCSV(rows)],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);}
const val=id=>document.getElementById(id)?.value||''; const setVal=(id,v)=>{const el=document.getElementById(id); if(el) el.value=v};

/* ========= FLOATING NUMBER PAD ========= */
const numpad=document.getElementById('numpad'); let npTarget=null;
function buzz(ms=10){try{ if(getS().haptics && navigator.vibrate) navigator.vibrate(ms);}catch{}}
function padRect(){const r=numpad.getBoundingClientRect();return {w:r.width||320,h:r.height||260};}
function placePad(el){
  const r=el.getBoundingClientRect(), pad=padRect(), gap=8, vw=innerWidth, vh=innerHeight;
  const idealW=Math.min(Math.max(r.width,260), Math.min(520,vw-16)); numpad.style.width=idealW+'px';
  let left=Math.max(8, Math.min(r.left, vw-idealW-8));
  let top=r.bottom+gap, flip=false; if(top+pad.h+12>vh){top=r.top-pad.h-gap;flip=true;}
  numpad.style.left=Math.round(left)+'px'; numpad.style.top=Math.round(top)+'px';
  const caretPos=Math.round(Math.min(Math.max(16,(r.left-left)+Math.min(r.width,idealW)/2), idealW-16));
  numpad.style.setProperty('--caret-left', caretPos+'px'); numpad.style.setProperty('--caret-top', flip? (pad.h-7)+'px':'-7px'); numpad.style.setProperty('--caret-rotate', flip?'225deg':'45deg');
}
const caretStyle=document.createElement('style');
caretStyle.textContent=`#numpad::after{left:var(--caret-left,24px);top:var(--caret-top,-7px);transform:rotate(var(--caret-rotate,45deg));}`;
document.head.appendChild(caretStyle);
function showPad(el){npTarget=el; try{el.focus({preventScroll:true});}catch{} numpad.classList.add('show'); requestAnimationFrame(()=>placePad(el)); const v=el.value; try{el.setSelectionRange(v.length,v.length);}catch{}}
function hidePad(){numpad.classList.remove('show'); npTarget=null;}
numpad?.addEventListener('click',e=>{
  const b=e.target.closest('.np-btn'); if(!b||!npTarget) return;
  const act=b.dataset.act, set=b.dataset.val||b.textContent.trim();
  if(act==='done'){hidePad();return;}
  if(act==='back'){const el=npTarget; const s=el.selectionStart??el.value.length; const epos=el.selectionEnd??el.value.length; if(s!==epos){el.value=el.value.slice(0,s)+el.value.slice(epos);} else if(s>0){el.value=el.value.slice(0,s-1)+el.value.slice(s);} try{el.setSelectionRange(Math.max(0,s-1),Math.max(0,s-1));}catch{} el.dispatchEvent(new Event('input',{bubbles:true})); return;}
  if(act==='clear'){npTarget.value=''; npTarget.dispatchEvent(new Event('input',{bubbles:true})); return;}
  if(set==='-'){npTarget.value = npTarget.value.startsWith('-')?npTarget.value.slice(1):('-'+npTarget.value); npTarget.dispatchEvent(new Event('input',{bubbles:true})); return;}
  const el=npTarget; const s=el.selectionStart??el.value.length; const epos=el.selectionEnd??el.value.length; let v=el.value; if(set==='.' && v.includes('.')) return; el.value=v.slice(0,s)+set+v.slice(epos); const pos=s+set.length; try{el.setSelectionRange(pos,pos);}catch{} el.dispatchEvent(new Event('input',{bubbles:true})); buzz(8);
});
document.addEventListener('pointerdown',e=>{ if(!numpad?.classList.contains('show')) return; if(!e.target.closest('#numpad') && !e.target.closest('input.num')) hidePad(); });
addEventListener('scroll',()=>{ if(npTarget && numpad?.classList.contains('show')) placePad(npTarget); }, {passive:true});
addEventListener('resize',()=>{ if(npTarget && numpad?.classList.contains('show')) placePad(npTarget); });
document.querySelectorAll('input.num').forEach(inp=>{ inp.readOnly=true; inp.addEventListener('focus',()=>showPad(inp)); inp.addEventListener('click',()=>showPad(inp)); });

/* ===== Mini calc (IDs prefixed ll_) — SILENT INIT ===== */
function ll_getRange(silent = true){
  const l = parseFloat(document.getElementById('ll_lrv').value);
  const u = parseFloat(document.getElementById('ll_urv').value);
  if (!Number.isFinite(l) || !Number.isFinite(u) || l===u){
    if (!silent) alert('Enter valid LRV & URV for the mini calc.');
    return null;
  }
  return {l,u};
}
function ll_euLabel(){
  const s=(document.getElementById('ll_eulbl').value||'').trim();
  return s?(' '+s):'';
}
function ll_updateFromPct(p){
  const r = ll_getRange(true);       // ← silent during typing/init
  if(!r) return;
  const pct = Math.min(Math.max(Number(p)||0,0),100);
  const sqrt = document.getElementById('ll_sqrt_mode').checked;
  const ma = 4 + 16*(pct/100);
  const eu = r.l + (r.u-r.l) * (sqrt ? Math.sqrt(pct/100) : (pct/100));
  document.getElementById('ll_pct').value = FMT(pct);
  document.getElementById('ll_ma').value  = FMT(ma);
  document.getElementById('ll_eu').value  = FMT(eu);
  document.getElementById('ll_read_pct').textContent = FMT(pct) + '%';
  document.getElementById('ll_read_ma').textContent  = FMT(ma);
  document.getElementById('ll_read_eu').textContent  = FMT(eu) + ll_euLabel();
  const slider=document.getElementById('ll_slider'); if(slider) slider.value=pct;
}
function ll_fromMA(){
  const r = ll_getRange(false);      // ← alert only on explicit action
  if(!r) return;
  const m = parseFloat(document.getElementById('ll_ma').value);
  if(!Number.isFinite(m)){ alert('Enter mA'); return; }
  ll_updateFromPct(Math.min(Math.max((m-4)/16*100,0),100));
}
function ll_fromPct(){
  const p = parseFloat(document.getElementById('ll_pct').value);
  if(!Number.isFinite(p)){ alert('Enter %'); return; }
  ll_updateFromPct(p);
}
function ll_fromEU(){
  const r = ll_getRange(false);      // ← alert only on explicit action
  if(!r) return;
  const e = parseFloat(document.getElementById('ll_eu').value);
  if(!Number.isFinite(e)){ alert('Enter EU'); return; }
  const sqrt = document.getElementById('ll_sqrt_mode').checked;
  const en = (e-r.l)/(r.u-r.l);
  const pct = Math.min(Math.max((sqrt? Math.pow(Math.max(en,0),2) : en)*100,0),100);
  ll_updateFromPct(pct);
}
document.getElementById('ll_from_pct')?.addEventListener('click', ll_fromPct);
document.getElementById('ll_from_ma')?.addEventListener('click', ll_fromMA);
document.getElementById('ll_from_eu')?.addEventListener('click', ll_fromEU);
document.getElementById('ll_slider')?.addEventListener('input', e=> ll_updateFromPct(e.target.value));
document.getElementById('ll_sqrt_mode')?.addEventListener('change', ()=>{
  const s=document.getElementById('ll_slider'); ll_updateFromPct(s?s.value:50);
});
document.querySelectorAll('.ll_step').forEach(b=> b.addEventListener('click', ()=> ll_updateFromPct(b.dataset.p)));
document.querySelectorAll('#ll_calc_card .copy').forEach(c=>c.addEventListener('click', async ()=>{
  const sel=c.getAttribute('data-copy'); const el=document.querySelector(sel); if(!el) return;
  try{ await navigator.clipboard.writeText(el.textContent.trim()); c.textContent='copied'; setTimeout(()=>c.textContent='copy',900);}catch{}
}));

// Silent startup (no nag)
(function(){
  const s=document.getElementById('ll_slider'); if(s) s.value=50;
  ll_updateFromPct(50); // will quietly do nothing until LRV/URV are set
})();
  
/* ===== Percent → EU Steps (Rebuilt) ===== */
(() => {
  function pc_fmt(n){
    if(n===null || n===undefined || n==='') return '';
    const x = Number(n);
    if(!Number.isFinite(x)) return String(n);
    return (Math.abs(x)>=1000 || x===0)
      ? x.toFixed(2).replace(/\.00$/,'')
      : x.toFixed(4).replace(/0+$/,'').replace(/\.$/,'');
  }

  function pc_get(){
    const L = parseFloat(document.getElementById('pc_lrv')?.value);
    const U = parseFloat(document.getElementById('pc_urv')?.value);
    if(!Number.isFinite(L) || !Number.isFinite(U) || L === U){
      alert('Enter valid LRV and URV (cannot be equal).');
      return null;
    }
    const eu = (document.getElementById('pc_eu_units')?.value || '').trim();
    const sqrt = !!document.getElementById('pc_sqrt')?.checked;
    return {L,U,span:U-L,eu,sqrt};
  }

  function pc_build(){
    const cfg = pc_get(); if(!cfg) return;
    const tb = document.querySelector('#percentTable tbody');
    if(!tb) return;
    const spanNote = document.getElementById('pc_span_note');
    if(spanNote) spanNote.textContent = `Span: ${pc_fmt(cfg.span)} ${cfg.eu||'EU'}`;

    tb.innerHTML = '';
    [0,25,50,75,100].forEach(p=>{
      const frac = cfg.sqrt ? Math.sqrt(p/100) : (p/100);
      const euv  = cfg.L + cfg.span*frac;
      const ma   = 4 + 16*(p/100);
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${p}%</td>
          <td>${pc_fmt(euv)} ${cfg.eu}</td>
          <td>${pc_fmt(ma)} mA</td>
        </tr>
      `);
    });
  }

  function pc_export(){
    const cfg = pc_get(); if(!cfg) return;
    const rows = [['%','EU','Units','mA','LRV','URV','Span','SQRT']];
    [0,25,50,75,100].forEach(p=>{
      const frac = cfg.sqrt ? Math.sqrt(p/100) : (p/100);
      const euv  = cfg.L + cfg.span*frac;
      const ma   = 4 + 16*(p/100);
      rows.push([p, pc_fmt(euv), cfg.eu || '', pc_fmt(ma), pc_fmt(cfg.L), pc_fmt(cfg.U), pc_fmt(cfg.span), cfg.sqrt ? 'ON' : 'OFF']);
    });
    const csv = rows.map(r=>r.map(c=>{
      const s=(c??'').toString();
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'percent_steps.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById('pc_build')?.addEventListener('click', pc_build);
  document.getElementById('pc_export')?.addEventListener('click', pc_export);
  ['pc_lrv','pc_urv','pc_eu_units','pc_sqrt'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{ clearTimeout(el._t); el._t = setTimeout(pc_build, 120); });
    el.addEventListener('change', pc_build);
  });

  const L0 = parseFloat(document.getElementById('pc_lrv')?.value);
  const U0 = parseFloat(document.getElementById('pc_urv')?.value);
  if(Number.isFinite(L0) && Number.isFinite(U0) && L0 !== U0) pc_build();
})();
  
/* ===== 4–20 mA (main tool) — combined pro + mini ===== */
function SH_range(){
  const L = parseFloat(document.getElementById('sh_lrv').value);
  const U = parseFloat(document.getElementById('sh_urv').value);
  if (!Number.isFinite(L) || !Number.isFinite(U) || L===U) return null;
  return {L,U};
}
function SH_euLabel(){
  const s = (document.getElementById('sh_eulbl').value||'').trim();
  return s ? (' '+s) : '';
}
function SH_spanNote(){
  const r = SH_range();
  const el = document.getElementById('sh_span_note');
  if (!el){return;}
  if (!r){ el.textContent = 'Span: —'; return; }
  el.textContent = `Span: ${fmt(r.U - r.L)} EU`;
}

// core conversions
const SH_pctToMA = p => 4 + 16*(p/100);
const SH_maToPct = ma => (ma-4)/16*100;

// Update everything from % (handles sqrt EU)
function SH_fromPct(pIn){
  const r = SH_range(); if(!r){ alert('Enter LRV & URV'); return; }
  const pct = Math.min(Math.max(Number(pIn)||0,0),100);
  const sqrt = document.getElementById('sh_sqrt').checked;

  const ma = SH_pctToMA(pct);
  const eu = r.L + (r.U - r.L) * (sqrt ? Math.sqrt(pct/100) : (pct/100));

  // form inputs
  document.getElementById('sh_pct').value = FMT(pct);
  document.getElementById('sh_ma').value  = FMT(ma);
  document.getElementById('sh_eu').value  = FMT(eu);

  // readouts
  document.getElementById('sh_read_pct').textContent = FMT(pct)+'%';
  document.getElementById('sh_read_ma').textContent  = FMT(ma);
  document.getElementById('sh_read_eu').textContent  = FMT(eu) + SH_euLabel();

  // slider
  const s = document.getElementById('sh_slider');
  if (s) s.value = pct;
}

function SH_fromMA(){
  const m = parseFloat(document.getElementById('sh_ma').value);
  if (!Number.isFinite(m)){ alert('Enter mA'); return; }
  SH_fromPct(SH_maToPct(m));
}

function SH_fromEU(){
  const r = SH_range(); if(!r){ alert('Enter LRV & URV'); return; }
  const e = parseFloat(document.getElementById('sh_eu').value);
  if (!Number.isFinite(e)){ alert('Enter EU'); return; }
  const sqrt = document.getElementById('sh_sqrt').checked;

  // normalize EU to 0..1 then invert sqrt if needed
  const en = (e - r.L) / (r.U - r.L);
  const pct = Math.min(Math.max((sqrt ? Math.pow(Math.max(en,0),2) : en)*100,0),100);
  SH_fromPct(pct);
}

// buttons
document.getElementById('sh_from_pct')?.addEventListener('click', ()=> {
  const p = parseFloat(document.getElementById('sh_pct').value);
  if (!Number.isFinite(p)){ alert('Enter %'); return; }
  SH_fromPct(p);
});
document.getElementById('sh_from_ma')?.addEventListener('click', SH_fromMA);
document.getElementById('sh_from_eu')?.addEventListener('click', SH_fromEU);

// slider + sqrt toggle + steps
document.getElementById('sh_slider')?.addEventListener('input', e => SH_fromPct(e.target.value));
document.getElementById('sh_sqrt')?.addEventListener('change', ()=> {
  const s = document.getElementById('sh_slider'); SH_fromPct(s ? s.value : 50);
});
document.querySelectorAll('.sh_step').forEach(b => b.addEventListener('click', ()=> SH_fromPct(b.dataset.p)));

// copy buttons
document.querySelectorAll('#signal .copy').forEach(c=>{
  c.addEventListener('click', async ()=>{
    const sel=c.getAttribute('data-copy'); const el=document.querySelector(sel); if(!el) return;
    try{ await navigator.clipboard.writeText(el.textContent.trim());
      c.textContent='copied'; setTimeout(()=>c.textContent='copy',900);
    }catch{}
  });
});

// build/export table
function SH_buildRows(){
  const r = SH_range(); if(!r){ alert('Enter LRV & URV'); return; }
  const sqrt = document.getElementById('sh_sqrt').checked;
  const tb = document.querySelector('#sh_tbl tbody'); tb.innerHTML='';
  [0,25,50,75,100].forEach(p=>{
    const ma = SH_pctToMA(p);
    const eu = r.L + (r.U - r.L) * (sqrt ? Math.sqrt(p/100) : (p/100));
    tb.insertAdjacentHTML('beforeend',
      `<tr><td>${FMT(p)}%</td><td>${FMT(ma)} mA</td><td>${FMT(eu)}${SH_euLabel()}</td></tr>`);
  });
}
document.getElementById('sh_build')?.addEventListener('click', SH_buildRows);

document.getElementById('sh_export')?.addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#sh_tbl tbody tr'));
  if (!rows.length){ SH_buildRows(); }
  const csvRows = [['%','mA','EU']];
  document.querySelectorAll('#sh_tbl tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    csvRows.push([tds[0].textContent.replace('%',''), tds[1].textContent.replace(' mA',''), tds[2].textContent]);
  });
  const blob = new Blob([csvRows.map(r=>r.join(',')).join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '4-20-steps.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});

// keep span note fresh
['sh_lrv','sh_urv','sh_eulbl'].forEach(id=>{
  document.getElementById(id)?.addEventListener('input', SH_spanNote);
});
SH_spanNote();

// initialize view
(function initSH(){
  const s = document.getElementById('sh_slider'); if (s) s.value = 50;
  SH_fromPct(50);
})();
  
/* ========= PRESSURE ========= */
const KPA_PER_PSI = 6.894757293168;
const P2PA = {
  pa:1,kpa:1000,mpa:1e6,bar:100000,psi:6894.757293168,
  inh2o:249.08891, mmh2o:9.80665, inhg:3386.389, mmhg:133.322387415
};
function convertP(v,from,to){ if(!Number.isFinite(v)) return ''; const pa=v*P2PA[from]; return pa/P2PA[to]; }
document.getElementById('pc_convert')?.addEventListener('click',()=>{
  const v=parseFloat(val('pc_val_in')); if(isNaN(v)){alert('Enter a value');return;}
  const f=document.getElementById('pc_unit_in').value, t=document.getElementById('pc_unit_out').value;
  setVal('pc_val_out', fmt(convertP(v,f,t)));
});
document.getElementById('pc_swap')?.addEventListener('click',()=>{
  const a=document.getElementById('pc_unit_in'), b=document.getElementById('pc_unit_out'); const tmp=a.value; a.value=b.value; b.value=tmp;
});
function psigToPsia(){ const a=parseFloat(val('atm')), g=parseFloat(val('psig')); if(isNaN(a)||isNaN(g)){alert('Enter atm and psig');return;} setVal('psia', fmt(a+g)); }
function psiaToPsig(){ const a=parseFloat(val('atm')), p=parseFloat(val('psia')); if(isNaN(a)||isNaN(p)){alert('Enter atm and psia');return;} setVal('psig', fmt(p-a)); }
function fromPSI(){ const p=parseFloat(val('u_psi')); if(isNaN(p)){alert('Enter psi');return;} setVal('u_kpa', fmt(p*KPA_PER_PSI)); setVal('u_bar', fmt(p*0.06894757)); }
function fromKPA(){ const k=parseFloat(val('u_kpa')); if(isNaN(k)){alert('Enter kPa');return;} const psi=k/KPA_PER_PSI; setVal('u_psi', fmt(psi)); setVal('u_bar', fmt(psi*0.06894757)); }
function fromBAR(){ const b=parseFloat(val('u_bar')); if(isNaN(b)){alert('Enter bar');return;} const psi=b/0.06894757; setVal('u_psi', fmt(psi)); setVal('u_kpa', fmt(psi*KPA_PER_PSI)); }

/* ========= TEMP ↔ OHMS + Temp & Delta ========= */
/* ---------- RTD / Thermistor constants ---------- */
const A = 3.9083e-3;      // Callendar–Van Dusen
const B = -5.775e-7;

function CtoF(c){ return c * 9/5 + 32; }
function FtoC(f){ return (f - 32) * 5/9; }
function CtoK(c){ return c + 273.15; }
function KtoC(k){ return k - 273.15; }
function fmtNum(x){ return Number.isFinite(x) ? x.toFixed(2) : ''; }

/* ---------- RTD (Pt100 / Pt1000) ---------- */
function ptTempToOhms(tempC, type){
  const R0 = (type === 'pt1000') ? 1000 : 100;
  return R0 * (1 + A*tempC + B*tempC*tempC);
}
function ptOhmsToTemp(R, type){
  const R0 = (type === 'pt1000') ? 1000 : 100;
  const a = B*R0, b = A*R0, c = R0 - R;
  const disc = b*b - 4*a*c;
  if (disc < 0) return NaN;
  return (-b + Math.sqrt(disc)) / (2*a);
}

/* ---------- NTC 10k (B=3950) ---------- */
function ntcTempToOhms(tempC){
  const BETA = 3950, R0 = 10000, T0 = 25 + 273.15;
  const T = tempC + 273.15;
  return R0 * Math.exp(BETA * (1/T - 1/T0));
}
function ntcOhmsToTemp(R){
  const BETA = 3950, R0 = 10000, T0 = 25 + 273.15;
  const T = 1 / ((1/T0) + (1/BETA)*Math.log(R/R0));
  return T - 273.15;
}

/* ---------- Temp → Ohms ---------- */
document.getElementById('to_temp_convert')?.addEventListener('click', ()=>{
  const sensor = document.getElementById('to_sensor').value;
  const units  = document.getElementById('to_units').value;
  let t = parseFloat(document.getElementById('to_temp_in').value);
  if (!Number.isFinite(t)) { alert('Enter a valid temperature'); return; }
  if (units === 'F') t = FtoC(t);
  let R = NaN;
  if (sensor === 'pt100' || sensor === 'pt1000') R = ptTempToOhms(t, sensor);
  if (sensor === 'ntc10k') R = ntcTempToOhms(t);
  document.getElementById('to_ohms_out').value = fmtNum(R);
});

/* ---------- Ohms → Temp ---------- */
document.getElementById('to_ohms_convert')?.addEventListener('click', ()=>{
  const sensor = document.getElementById('to_sensor').value;
  const units  = document.getElementById('to_units').value;
  const R = parseFloat(document.getElementById('to_ohms_in').value);
  if (!Number.isFinite(R)) { alert('Enter a valid resistance'); return; }
  let tC = NaN;
  if (sensor === 'pt100' || sensor === 'pt1000') tC = ptOhmsToTemp(R, sensor);
  if (sensor === 'ntc10k') tC = ntcOhmsToTemp(R);
  const tOut = (units === 'F') ? CtoF(tC) : tC;
  document.getElementById('to_temp_out').value = fmtNum(tOut);
});

/* ---------- Absolute Temperature Converter ---------- */
function convertTemp(val, from, to){
  if (!Number.isFinite(val)) return NaN;
  // go via °C
  let c;
  if (from === 'C') c = val;
  else if (from === 'F') c = FtoC(val);
  else if (from === 'K') c = KtoC(val);
  else return NaN;

  if (to === 'C') return c;
  if (to === 'F') return CtoF(c);
  if (to === 'K') return CtoK(c);
  return NaN;
}
document.getElementById('tc_conv_btn')?.addEventListener('click', ()=>{
  const v = parseFloat(document.getElementById('tc_val').value);
  const f = document.getElementById('tc_from').value;
  const t = document.getElementById('tc_to').value;
  if (!Number.isFinite(v)) { alert('Enter a temperature'); return; }
  const out = convertTemp(v, f, t);
  document.getElementById('tc_out').value = fmtNum(out);
});

/* ---------- Delta (difference) Converter ---------- */
function convertDelta(val, from, to){
  if (!Number.isFinite(val)) return NaN;
  // Normalize to Δ°C
  let dC = val;
  if (from === 'F') dC = val * (5/9);
  if (from === 'K') dC = val; // same size as °C
  // From Δ°C to target
  if (to === 'C') return dC;
  if (to === 'F') return dC * (9/5);
  if (to === 'K') return dC;
  return NaN;
}
document.getElementById('td_conv_btn')?.addEventListener('click', ()=>{
  const v = parseFloat(document.getElementById('td_val').value);
  const f = document.getElementById('td_from').value;
  const t = document.getElementById('td_to').value;
  if (!Number.isFinite(v)) { alert('Enter a delta value'); return; }
  const out = convertDelta(v, f, t);
  document.getElementById('td_out').value = fmtNum(out);
});

/* ---------- Copy helpers ---------- */
document.querySelectorAll('.copy').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const sel = btn.getAttribute('data-copy');
    const el = document.querySelector(sel);
    if (!el) return;
    try{
      await navigator.clipboard.writeText((el.value ?? el.textContent ?? '').toString().trim());
      btn.textContent = 'copied';
      setTimeout(()=> btn.textContent = 'copy', 900);
    }catch(e){ console.error(e); }
  });
});
  
/* ======== LEVEL (Unified) ======== */
/* Uses existing global: KPA_PER_PSI (do NOT redeclare here) */
const IN_PER_FT = 12;
const IN_PER_M  = 39.37007874;
const INH2O_PER_PSI = 27.679904842545;

// Safe `$` helper (only define if not present)
if (!window.$) window.$ = sel => document.querySelector(sel);

// Small helpers
const setHint = (id, msg, isErr=false)=>{
  const el = $(id);
  if (!el) return;
  el.textContent = msg || '';
  el.classList.toggle('error', !!isErr);
};
const toInches = (value, units) => {
  let v = parseFloat(value);
  if (!Number.isFinite(v)) return NaN;
  if (units === 'ft') v *= IN_PER_FT;
  if (units === 'm')  v *= IN_PER_M;
  return v;
};
const fromInH2O = (inh2o, outU) => {
  if (outU === 'inh2o') return inh2o;
  if (outU === 'psi')   return inh2o / INH2O_PER_PSI;
  if (outU === 'kpa')   return (inh2o / INH2O_PER_PSI) * KPA_PER_PSI;
  return inh2o;
};

// Show/hide wet-leg inputs based on tank type
function lv_updateTypeUI(){
  const t = $('#lv_type')?.value || 'open';
  document.querySelectorAll('.only-wet').forEach(el=>{
    el.style.display = (t === 'closed_wet') ? '' : 'none';
  });
}
$('#lv_type')?.addEventListener('change', lv_updateTypeUI);
lv_updateTypeUI(); // initialize once after load

// Compute default LRV/URV from guided inputs (returns numbers in chosen dP units)
function lv_computeRange(){
  const t     = $('#lv_type').value;
  const span  = parseFloat($('#lv_span').value);
  const units = $('#lv_units').value;
  const sgP   = parseFloat($('#lv_sg_proc').value);
  const dpU   = $('#lv_dpU').value;

  setHint('#hint_span'); // clear

  if (!Number.isFinite(span) || span <= 0){
    setHint('#hint_span','Enter a positive span',true);
    return null;
  }
  if (!Number.isFinite(sgP) || sgP <= 0){
    return null;
  }

  const spanIn            = toInches(span, units);    // span in inches
  const procHead_inh2o    = sgP * spanIn;             // inH2O across full span

  if (t === 'open' || t === 'closed_dry'){
    const LRV = 0;
    const URV = fromInH2O(procHead_inh2o, dpU);
    return { LRV, URV, spanIn, dpU, t, units, sgP };
  }

  // closed_wet leg
  const wetH  = parseFloat($('#lv_wet_h').value);
  const wetSG = parseFloat($('#lv_wet_sg').value);
  if (!Number.isFinite(wetH)  || wetH  <= 0) return null;
  if (!Number.isFinite(wetSG) || wetSG <= 0) return null;

  const wetHead_inh2o = wetH * wetSG;
  // Assumes HP at bottom, LP at top wet leg:
  // DP = (procSG·level) − (wetSG·wetH)
  const LRV = fromInH2O(-wetHead_inh2o, dpU);
  const URV = fromInH2O(procHead_inh2o - wetHead_inh2o, dpU);
  return { LRV, URV, spanIn, dpU, t, units, sgP, wetH, wetSG };
}

// Fill the form (auto LRV/URV if left blank)
$('#lv_fill')?.addEventListener('click', ()=>{
  const cfg = lv_computeRange();
  if (!cfg) return;

  const L = parseFloat($('#lv_lrv').value);
  const U = parseFloat($('#lv_urv').value);
  if (!Number.isFinite(L)) $('#lv_lrv').value = fmt(cfg.LRV);
  if (!Number.isFinite(U)) $('#lv_urv').value = fmt(cfg.URV);

  // enable action buttons now that range exists
  $('#lv_btn_lvl2ma').disabled = false;
  $('#lv_btn_ma2lvl').disabled = false;

  // clear hints/results
  setHint('#hint_level');
  setHint('#hint_ma');
  $('#lv_result').textContent   = 'Ready. Enter a Level or mA.';
  $('#lv_equations').textContent = '';
  $('#lv_pct_label').textContent = '—';
  $('#lv_tankviz')?.style.setProperty('--fill','0%');
});

// Range getter (reads LRV/URV the user may have overridden)
const lv_getRange = ()=>{
  const L   = parseFloat($('#lv_lrv').value);
  const U   = parseFloat($('#lv_urv').value);
  const dpU = $('#lv_dpU').value;
  if (!Number.isFinite(L) || !Number.isFinite(U) || L === U) return null;
  return { L, U, dpU };
};

const lv_pctToMA = p  => 4 + 16*(p/100);
const lv_maToPct = ma => (ma - 4)/16*100;

// Update the mini tank visualization
function lv_setViz(pct){
  const clamped = Math.max(0, Math.min(100, pct || 0));
  $('#lv_tankviz')?.style.setProperty('--fill', `${clamped}%`);
  $('#lv_pct_label').textContent = fmt(clamped) + '%';
}

// Level → mA
$('#lv_btn_lvl2ma')?.addEventListener('click', ()=>{
  setHint('#hint_level');
  const g = lv_computeRange(); if (!g){ setHint('#hint_level','Fill Guided Mode and press “Fill the form”',true); return; }
  const r = lv_getRange();     if (!r){ setHint('#hint_level','LRV/URV invalid or missing',true); return; }

  const level = parseFloat($('#lv_level').value);
  if (!Number.isFinite(level)){ setHint('#hint_level','Enter level',true); return; }

  let levelIn = toInches(level, g.units);
  if (!Number.isFinite(levelIn)){ setHint('#hint_level','Level must use same units as span',true); return; }

  const pct = Math.max(0, Math.min(100, (levelIn / g.spanIn) * 100));
  const dp  = r.L + (r.U - r.L) * (pct/100);   // already in chosen dP units
  const ma  = lv_pctToMA(pct);

  $('#lv_ma').value = fmt(ma);
  $('#lv_result').textContent =
    `Level ${fmt(level)} ${g.units} → ${fmt(pct)}% → ${fmt(dp)} ${r.dpU} → ${fmt(ma)} mA`;
  $('#lv_equations').textContent =
    `Used: % = level/span·100; dP = LRV + (URV−LRV)·(%/100); mA = 4 + 16·(%/100)`;
  lv_setViz(pct);
});

// mA → Level
$('#lv_btn_ma2lvl')?.addEventListener('click', ()=>{
  setHint('#hint_ma');
  const g = lv_computeRange(); if (!g){ setHint('#hint_ma','Fill Guided Mode and press “Fill the form”',true); return; }
  const r = lv_getRange();     if (!r){ setHint('#hint_ma','LRV/URV invalid or missing',true); return; }

  const ma = parseFloat($('#lv_ma').value);
  if (!Number.isFinite(ma)){ setHint('#hint_ma','Enter mA',true); return; }

  const pct    = Math.max(0, Math.min(100, lv_maToPct(ma)));
  const dp     = r.L + (r.U - r.L) * (pct/100);
  let levelIn  = (pct/100) * g.spanIn;

  // convert back to UI units
  let level = levelIn;
  if (g.units === 'ft') level = levelIn / IN_PER_FT;
  if (g.units === 'm')  level = levelIn / IN_PER_M;

  $('#lv_level').value = fmt(level);
  $('#lv_result').textContent =
    `${fmt(ma)} mA → ${fmt(pct)}% → ${fmt(dp)} ${r.dpU} → Level ${fmt(level)} ${g.units}`;
  $('#lv_equations').textContent =
    `Used: % = (mA−4)/16·100; dP = LRV + (URV−LRV)·(%/100); level = %·span/100`;
  lv_setViz(pct);
});

// Build 0/25/50/75/100 table
$('#lv_buildSteps')?.addEventListener('click', ()=>{
  const g  = lv_computeRange(); if (!g) return;
  const r  = lv_getRange();     if (!r) return;
  const tb = $('#lv_steps tbody'); if (!tb) return;

  tb.innerHTML = '';
  [0,25,50,75,100].forEach(p=>{
    const dp  = r.L + (r.U - r.L) * (p/100);
    const lvl = (p/100) * (
      g.units === 'ft' ? g.spanIn / IN_PER_FT :
      g.units === 'm'  ? g.spanIn / IN_PER_M  :
                         g.spanIn
    );
    const ma  = lv_pctToMA(p);
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td>${p}%</td>
      <td>${fmt(lvl)} ${g.units}</td>
      <td>${fmt(dp)} ${r.dpU}</td>
      <td>${fmt(ma)} mA</td>
    </tr>`);
  });
});
  
/* ========= I/P ========= */
function ip_fromPct(p){const psi=3+12*(p/100); setVal('ip_psi',fmt(psi)); document.getElementById('ip_read_pct').textContent=fmt(p)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi';}
function ip_fromPsi(psi){const p=(psi-3)/12*100; setVal('ip_pct',fmt(p)); document.getElementById('ip_read_pct').textContent=fmt(p)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi';}
document.getElementById('ip_from_pct')?.addEventListener('click',()=>{const p=parseFloat(val('ip_pct')); if(isNaN(p)){alert('Enter %');return;} ip_fromPct(p);});
document.getElementById('ip_from_psi')?.addEventListener('click',()=>{const x=parseFloat(val('ip_psi')); if(isNaN(x)){alert('Enter psi');return;} ip_fromPsi(x);});
document.querySelectorAll('.ipstep').forEach(b=>b.addEventListener('click',()=>ip_fromPct(parseFloat(b.dataset.p))));

/* ========= JR TECH (T/C + RTD table + search) ========= */
const TCTABLE={
  ANSI:[
    ['J','White','Red','Iron/Constantan'],
    ['K','Yellow','Red','Chromel/Alumel'],
    ['T','Blue','Red','Copper/Constantan'],
    ['E','Purple','Red','Chromel/Constantan'],
    ['N','Orange','Red','Nicrosil/Nisil'],
    ['R','Black','Red','PtRh/Pt (high temp)'],
    ['S','Black','Red','PtRh/Pt (high temp)'],
    ['B','Grey','Red','PtRh/Pt (very high temp)']
  ],
  IEC :[
    ['J','Black','White','Iron/Constantan'],
    ['K','Green','White','Chromel/Alumel'],
    ['T','Brown','White','Copper/Constantan'],
    ['E','Purple','White','Chromel/Constantan'],
    ['N','Pink','White','Nicrosil/Nisil'],
    ['R','Orange','White','PtRh/Pt (high temp)'],
    ['S','Orange','White','PtRh/Pt (high temp)'],
    ['B','Grey','White','PtRh/Pt (very high temp)']
  ]
};
function renderTC(){
  const std=document.getElementById('tc_std')?.value||'ANSI';
  const tb=document.querySelector('#tc_tbl tbody');
  if(!tb) return;
  tb.innerHTML='';
  (TCTABLE[std]||[]).forEach(r=>{
    tb.insertAdjacentHTML('beforeend', `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`);
  });
}
document.getElementById('tc_std')?.addEventListener('change',renderTC);
renderTC();
document.getElementById('jt_search')?.addEventListener('input',e=>{
  const q=e.target.value.trim().toLowerCase();
  document.querySelectorAll('#jrtech .jt-card, #jrtech table tbody tr').forEach(el=>{
    const text=el.textContent.toLowerCase();
    el.style.display = text.includes(q)?'':'none';
  });
});

/* ========= JR TECH — Temperature Element Ranges ========= */
function c2f(c){ return (c*9/5)+32; }
const TEMP_RANGES = {
  TC_J: {name:'Type J',   cmin:-210, cmax:760,  note:'Iron/Constantan; avoid oxidizing >~540°C',           use:'General purpose, mid-range'},
  TC_K: {name:'Type K',   cmin:-200, cmax:1260, note:'Chromel/Alumel; most common general-purpose',        use:'General purpose, wide range'},
  TC_T: {name:'Type T',   cmin:-200, cmax:400,  note:'Copper/Constantan; stable at low temps',             use:'Cryogenic/low-temp'},
  TC_E: {name:'Type E',   cmin:-200, cmax:900,  note:'Chromel/Constantan; high mV output',                 use:'Low temp, higher sensitivity'},
  TC_N: {name:'Type N',   cmin:-200, cmax:1300, note:'Nicrosil/Nisil; better high-temp stability vs K',    use:'High-temp general purpose'},
  TC_R: {name:'Type R',   cmin:-50,  cmax:1760, note:'PtRh/Pt; noble metal',                               use:'High-temp furnaces'},
  TC_S: {name:'Type S',   cmin:-50,  cmax:1760, note:'PtRh/Pt; noble metal',                               use:'High-temp furnaces'},
  TC_B: {name:'Type B',   cmin:0,    cmax:1820, note:'PtRh/Pt; low output below ~600°C',                   use:'Very high-temp, glass/steel'},
  RTD_Pt100_A:  {name:'Pt100 (Class A)',   cmin:-200, cmax:650, note:'±(0.15 + 0.002|t|)°C', use:'Process general purpose'},
  RTD_Pt100_B:  {name:'Pt100 (Class B)',   cmin:-200, cmax:850, note:'±(0.30 + 0.005|t|)°C', use:'Wider range / lower accuracy'},
  RTD_Pt1000_A: {name:'Pt1000 (Class A)',  cmin:-200, cmax:650, note:'Higher R → better lead-wire immunity', use:'HVAC/low-current loops'},
  RTD_Pt1000_B: {name:'Pt1000 (Class B)',  cmin:-200, cmax:850, note:'Higher R → better lead-wire immunity', use:'HVAC/long runs'}
};
function tr_renderOne(key){
  const d = TEMP_RANGES[key];
  if(!d) return;
  const tbody = document.querySelector('#tr_tbl tbody');
  if(!tbody) return;
  const fmin = c2f(d.cmin);
  const fmax = c2f(d.cmax);
  tbody.innerHTML = `
    <tr>
      <td>${d.cmin}</td>
      <td>${d.cmax}</td>
      <td>${fmin.toFixed(1)}</td>
      <td>${fmax.toFixed(1)}</td>
      <td>${d.use}</td>
    </tr>
  `;
  const notes = document.getElementById('tr_notes_out');
  if(notes) notes.value = `${d.name} — ${d.note}`;
}
function tr_exportCSV(){
  const sel = document.getElementById('tr_type');
  const key = sel?.value || 'TC_K';
  const d = TEMP_RANGES[key];
  if(!d) return;
  const rows = [
    ['Element','Min (°C)','Max (°C)','Min (°F)','Max (°F)','Notes','Typical Use'],
    [d.name, d.cmin, d.cmax, c2f(d.cmin).toFixed(1), c2f(d.cmax).toFixed(1), d.note, d.use]
  ];
  const csv = rows.map(r=>r.map(c=>{
    const s=(c??'').toString();
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `temp_range_${d.name.replace(/\s+/g,'_')}.csv`; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('tr_type')?.addEventListener('change', e=> tr_renderOne(e.target.value));
document.getElementById('tr_export')?.addEventListener('click', tr_exportCSV);
tr_renderOne(document.getElementById('tr_type')?.value || 'TC_K');

/* ========= OHM’S LAW ========= */
function solveOhms(){
  let V=parseFloat(val('ol_v')), I=parseFloat(val('ol_i')), R=parseFloat(val('ol_r')), P=parseFloat(val('ol_p'));
  const known=[!isNaN(V),!isNaN(I),!isNaN(R),!isNaN(P)].filter(Boolean).length;
  if(known<2){ alert('Enter any two values'); return; }
  if(isNaN(V) && !isNaN(I) && !isNaN(R)) V=I*R;
  if(isNaN(V) && !isNaN(P) && !isNaN(I)) V=P/I;
  if(isNaN(V) && !isNaN(P) && !isNaN(R)) V=Math.sqrt(P*R);
  if(isNaN(I) && !isNaN(V) && !isNaN(R)) I=V/R;
  if(isNaN(I) && !isNaN(P) && !isNaN(V)) I=P/V;
  if(isNaN(I) && !isNaN(P) && !isNaN(R)) I=Math.sqrt(P/R);
  if(isNaN(R) && !isNaN(V) && !isNaN(I)) R=V/I;
  if(isNaN(R) && !isNaN(V) && !isNaN(P)) R=V*V/P;
  if(isNaN(R) && !isNaN(P) && !isNaN(I)) R=P/(I*I);
  if(isNaN(P) && !isNaN(V) && !isNaN(I)) P=V*I;
  if(isNaN(P) && !isNaN(V) && !isNaN(R)) P=V*V/R;
  if(isNaN(P) && !isNaN(I) && !isNaN(R)) P=I*I*R;
  document.getElementById('ol_out_v').textContent=fmt(V);
  document.getElementById('ol_out_i').textContent=fmt(I);
  document.getElementById('ol_out_r').textContent=fmt(R);
  document.getElementById('ol_out_p').textContent=fmt(P);
}
function clearOhms(){ ['ol_v','ol_i','ol_r','ol_p'].forEach(id=>setVal(id,'')); ['ol_out_v','ol_out_i','ol_out_r','ol_out_p'].forEach(id=>document.getElementById(id).textContent='—'); }
document.getElementById('ol_solve')?.addEventListener('click',solveOhms);
document.getElementById('ol_clear')?.addEventListener('click',clearOhms);

/* ========= VOLTAGE DROP ========= */
const AWG_OHM_1000FT_CU={'18':6.385,'16':4.016,'14':2.525,'12':1.588,'10':0.999,'8':0.6282,'6':0.3951,'4':0.2485,'2':0.1563,'1':0.1239,'1/0':0.0983,'2/0':0.0779,'3/0':0.0618,'4/0':0.0490};
const AWG_OHM_1000FT_AL={'12':2.57,'10':1.62,'8':1.02,'6':0.64,'4':0.40,'2':0.25,'1':0.20,'1/0':0.16,'2/0':0.13,'3/0':0.10,'4/0':0.08};
function ohmPerLength(awg,mat,units,len){
  const tbl=(mat==='al')?AWG_OHM_1000FT_AL:AWG_OHM_1000FT_CU;
  let ohm1000=tbl[awg]; if(!ohm1000){ alert('AWG not in table for selected material'); return NaN; }
  let ft = (units==='m') ? (len*3.28084) : len;
  return ohm1000*(ft/1000);
}
function vd_calc(){
  const sys=document.getElementById('vd_sys').value;
  const Vs=parseFloat(val('vd_v')), I=parseFloat(val('vd_i')), L=parseFloat(val('vd_len'));
  const units=document.getElementById('vd_units').value;
  const mat=document.getElementById('vd_mat').value;
  const awg=document.getElementById('vd_awg').value;
  const target=parseFloat(val('vd_target'));
  if([Vs,I,L].some(isNaN)){ alert('Enter supply V, current, and run length'); return; }
  const R_one=ohmPerLength(awg,mat,units,L); if(!isFinite(R_one)) return;
  const factor=(sys==='3ph')?Math.sqrt(3):2;
  const Vdrop = I * R_one * factor;
  const pct = (Vdrop/ Vs) * 100;
  const Vend = Vs - Vdrop;
  document.getElementById('vd_out_vd').textContent=fmt(Vdrop);
  document.getElementById('vd_out_pct').textContent=fmt(pct);
  document.getElementById('vd_out_end').textContent=fmt(Vend);
  const s=document.getElementById('vd_suggest');
  if(!isNaN(target)){
    s.textContent = pct>target ? `Drop exceeds target ${target}%. Consider shorter run, larger wire, or lower current.` : `Within target ${target}%.`;
  }else s.textContent='';
}
document.getElementById('vd_calc')?.addEventListener('click',vd_calc);

/* ========= LOOP LOG + Mini 4–20 inside (no Expected/Measured) ========= */
const K_LOOP='pocketech.loop';
const FMT = v => {
  if (v===null || v===undefined || v==='') return '';
  const n = Number(v);
  return Number.isFinite(n)
    ? (Math.abs(n)>=1000||n===0 ? n.toFixed(2).replace(/\.00$/,'')
                                : n.toFixed(4).replace(/0+$/,'').replace(/\.$/,''))
    : v;
};

/* Mini calc (IDs prefixed ll_) — quiet until LRV/URV exist */
function ll_getRange({warn=true}={}) {
  const l = parseFloat(document.getElementById('ll_lrv')?.value);
  const u = parseFloat(document.getElementById('ll_urv')?.value);
  const ok = Number.isFinite(l) && Number.isFinite(u) && l !== u;
  if (!ok) { if (warn) alert('Enter valid LRV & URV for the mini calc.'); return null; }
  return { l, u };
}
function ll_euLabel(){ const s=(document.getElementById('ll_eulbl')?.value||'').trim(); return s?(' '+s):''; }
function ll_updateFromPct(p){
  const r = ll_getRange({warn:false}); if(!r) return;
  const pct=Math.min(Math.max(Number(p)||0,0),100);
  const sqrt=document.getElementById('ll_sqrt_mode').checked;
  const ma = 4 + 16*(pct/100);
  const eu = r.l + (r.u-r.l) * (sqrt ? Math.sqrt(pct/100) : (pct/100));
  document.getElementById('ll_pct').value = FMT(pct);
  document.getElementById('ll_ma').value  = FMT(ma);
  document.getElementById('ll_eu').value  = FMT(eu);
  document.getElementById('ll_read_pct').textContent = FMT(pct)+'%';
  document.getElementById('ll_read_ma').textContent  = FMT(ma);
  document.getElementById('ll_read_eu').textContent  = FMT(eu)+ll_euLabel();
  const slider=document.getElementById('ll_slider'); if(slider) slider.value=pct;
}
function ll_fromMA(){ const r=ll_getRange(); if(!r) return;
  const m=parseFloat(document.getElementById('ll_ma').value);
  if(!Number.isFinite(m)){ alert('Enter mA'); return; }
  ll_updateFromPct(Math.min(Math.max((m-4)/16*100,0),100));
}
function ll_fromPct(){ const r=ll_getRange(); if(!r) return;
  const p=parseFloat(document.getElementById('ll_pct').value);
  if(!Number.isFinite(p)){ alert('Enter %'); return; }
  ll_updateFromPct(p);
}
function ll_fromEU(){ const r=ll_getRange(); if(!r) return;
  const e=parseFloat(document.getElementById('ll_eu').value);
  if(!Number.isFinite(e)){ alert('Enter EU'); return; }
  const sqrt=document.getElementById('ll_sqrt_mode').checked;
  const en=(e-r.l)/(r.u-r.l);
  const pct=Math.min(Math.max((sqrt? Math.pow(Math.max(en,0),2):en)*100,0),100);
  ll_updateFromPct(pct);
}
document.getElementById('ll_from_pct')?.addEventListener('click', ll_fromPct);
document.getElementById('ll_from_ma')?.addEventListener('click', ll_fromMA);
document.getElementById('ll_from_eu')?.addEventListener('click', ll_fromEU);
document.getElementById('ll_slider')?.addEventListener('input', e=> ll_updateFromPct(e.target.value));
document.getElementById('ll_sqrt_mode')?.addEventListener('change', ()=>{ const s=document.getElementById('ll_slider'); ll_updateFromPct(s?s.value:50); });
document.querySelectorAll('.ll_step').forEach(b=> b.addEventListener('click', ()=> ll_updateFromPct(b.dataset.p)));
document.querySelectorAll('#ll_calc_card .copy').forEach(c=>c.addEventListener('click', async ()=>{
  const sel=c.getAttribute('data-copy'); const el=document.querySelector(sel); if(!el) return;
  try{ await navigator.clipboard.writeText(el.textContent.trim()); c.textContent='copied'; setTimeout(()=>c.textContent='copy',900);}catch{}
}));
(function(){
  const s=document.getElementById('ll_slider'); if(s) s.value=50;
  if (!document.getElementById('ll_lrv').value) setVal('ll_lrv','0');
  if (!document.getElementById('ll_urv').value) setVal('ll_urv','100');
  ll_updateFromPct(50);
})();

/* ===== Loop add/render/CSV (now includes Device Serial/Model) ===== */
function loop_add(){
  const safe = id => document.getElementById(id)?.value ?? "";
  const rec = {
    date: safe('lp_date') || new Date().toISOString().slice(0,10),
    tag:  safe('lp_tag'),
    point:safe('lp_point'),
    units:safe('lp_units'),
    ok:   safe('lp_ok'),
    notes:safe('lp_notes'),
    lrv:  parseFloat(safe('lp_lrv')),
    urv:  parseFloat(safe('lp_urv')),
    euUnits: safe('lp_eu_units'),
    lll:  parseFloat(safe('lp_lll')),
    ll:   parseFloat(safe('lp_ll')),
    l:    parseFloat(safe('lp_l')),
    h:    parseFloat(safe('lp_h')),
    hh:   parseFloat(safe('lp_hh')),
    hhh:  parseFloat(safe('lp_hhh')),
    devRange: safe('lp_dev'),
    devSN:    safe('lp_dev_sn'),     // NEW
    devModel: safe('lp_dev_model'),  // NEW
    sqrt: !!document.getElementById('ll_sqrt_mode')?.checked
  };
  const rows=load(K_LOOP); rows.push(rec); save(K_LOOP, rows); loop_render();
}

function loop_render(){
  const rows=load(K_LOOP);
  const tb=document.querySelector('#lp_tbl tbody');
  if(!tb) return;
  tb.innerHTML='';
  let pass=0, fail=0;

  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.tag||''}</td>
      <td>${r.point||''}</td>
      <td>${r.units||''}</td>
      <td><span class="pill ${r.ok==='YES'?'pill-green':'pill-red'}">${r.ok||''}</span></td>
      <td>${r.notes||''}</td>
      <td>
        <button class="btn" onclick="toggleDetails(${i}, this)">▶ Details</button>
        <button class="btn danger" onclick="loop_delete(${i})">✖</button>
      </td>`;
    tb.appendChild(tr);

    const detailRow=document.createElement('tr');
    detailRow.style.display='none';
    detailRow.innerHTML = `
      <td colspan="7">
        <div class="grid">
          <div class="kv"><span>LRV</span><strong>${FMT(r.lrv)||'—'}</strong></div>
          <div class="kv"><span>URV</span><strong>${FMT(r.urv)||'—'}</strong></div>
          <div class="kv"><span>EU</span><strong>${r.euUnits||'—'}</strong></div>
          <div class="kv"><span>Device Range</span><strong>${r.devRange||'—'}</strong></div>
          <div class="kv"><span>Device Serial #</span><strong>${r.devSN||'—'}</strong></div>
          <div class="kv"><span>Device Model #</span><strong>${r.devModel||'—'}</strong></div>
          <div class="kv"><span>LLL</span><strong>${FMT(r.lll)||'—'}</strong></div>
          <div class="kv"><span>LL</span><strong>${FMT(r.ll)||'—'}</strong></div>
          <div class="kv"><span>L</span><strong>${FMT(r.l)||'—'}</strong></div>
          <div class="kv"><span>H</span><strong>${FMT(r.h)||'—'}</strong></div>
          <div class="kv"><span>HH</span><strong>${FMT(r.hh)||'—'}</strong></div>
          <div class="kv"><span>HHH</span><strong>${FMT(r.hhh)||'—'}</strong></div>
          <div class="kv"><span>SQRT</span><strong>${r.sqrt?'ON':'OFF'}</strong></div>
        </div>
      </td>`;
    tb.appendChild(detailRow);

    if(r.ok==='YES') pass++; else fail++;
  });

  document.getElementById('loop-pass')!.textContent = `Pass: ${pass}`;
  document.getElementById('loop-fail')!.textContent = `Fail: ${fail}`;
}

function toggleDetails(index, btn){
  const row = btn.closest('tr').nextElementSibling;
  const open = row.style.display === 'table-row';
  row.style.display = open ? 'none' : 'table-row';
  btn.textContent = open ? '▶ Details' : '▼ Hide';
}

function loop_delete(i){
  const rows=load(K_LOOP);
  rows.splice(i,1);
  save(K_LOOP,rows);
  loop_render();
}

function loop_csv(){
  const rows=load(K_LOOP);
  const out=[[
    'Date','Tag','Point','Units','OK','Notes',
    'LRV','URV','EU Units','LLL','LL','L','H','HH','HHH',
    'Device Range','Device Serial #','Device Model #','SQRT'
  ]];
  rows.forEach(r=>out.push([
    r.date||'', r.tag||'', r.point||'', r.units||'', r.ok||'', r.notes||'',
    FMT(r.lrv), FMT(r.urv), r.euUnits||'',
    FMT(r.lll), FMT(r.ll), FMT(r.l), FMT(r.h), FMT(r.hh), FMT(r.hhh),
    r.devRange||'', r.devSN||'', r.devModel||'', r.sqrt?'ON':'OFF'
  ]));
  downloadCSV('loop_log.csv', out);
}

document.getElementById('lp_add')?.addEventListener('click', loop_add);
document.getElementById('lp_export')?.addEventListener('click', loop_csv);
document.getElementById('lp_clear')?.addEventListener('click', ()=>{ if(confirm('Clear all loop rows?')){ save(K_LOOP,[]); loop_render(); }});
loop_render();

/* ========= TICKETS ========= */
const K_TIX='pocketech.tix';
async function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file);});}
function tix_render(){const rows=load(K_TIX); const tb=document.querySelector('#tk_tbl tbody'); if(!tb) return; tb.innerHTML=''; rows.forEach((r,i)=>{const img=r.photo?`<img src="${r.photo}" alt="photo" style="max-height:36px;border-radius:6px;border:1px solid var(--border)">`:''; tb.insertAdjacentHTML('beforeend',`<tr><td>${r.date||''}</td><td>${r.area||''}</td><td>${r.tag||''}</td><td>${r.sum||''}</td><td>${r.status||''}</td><td>${img}</td><td><button class="btn danger" data-tk-del="${i}">✖</button></td></tr>`);});}
async function tix_add(){const f=document.getElementById('tk_photo').files[0]; const photo=f?await fileToDataURL(f):''; const rec={date: val('tk_date')||new Date().toISOString().slice(0,10), area: val('tk_area'), tag: val('tk_tag'), sum: val('tk_sum'), status: document.getElementById('tk_status').value, photo}; const rows=load(K_TIX); rows.push(rec); save(K_TIX,rows); tix_render();}
function tix_csv(){const rows=load(K_TIX); const out=[['Date','Area','Tag','Summary','Status','Photo(dataURL)']]; rows.forEach(r=>out.push([r.date,r.area,r.tag,r.sum,r.status,r.photo?('[embedded]'):''])); downloadCSV('tickets.csv',out);}
document.addEventListener('click',e=>{const d=e.target.getAttribute('data-tk-del'); if(d!==null){const rows=load(K_TIX); rows.splice(parseInt(d),1); save(K_TIX,rows); tix_render();}});
document.getElementById('tk_add')?.addEventListener('click',tix_add);
document.getElementById('tk_export')?.addEventListener('click',tix_csv);
document.getElementById('tk_clear')?.addEventListener('click',()=>{if(confirm('Clear all tickets?')){save(K_TIX,[]); tix_render();}});
tix_render();

/* ========= QR SCAN ========= */
const qrVideo=document.getElementById('qr_video'), qrCanvas=document.getElementById('qr_canvas'), qrOut=document.getElementById('qr_out');
let qrStream=null, qrTimer=null;
async function startLiveQR(){
  if(!('BarcodeDetector' in window)){ alert('Live QR not supported in this browser. Use “Import Photo”.'); return; }
  try{
    qrVideo.style.display='block';
    qrStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    qrVideo.srcObject=qrStream; await qrVideo.play();
    const det=new BarcodeDetector({formats:['qr_code']});
    qrTimer=setInterval(async()=>{
      const w=qrVideo.videoWidth,h=qrVideo.videoHeight; if(!w||!h) return;
      qrCanvas.width=w; qrCanvas.height=h; const ctx=qrCanvas.getContext('2d'); ctx.drawImage(qrVideo,0,0,w,h);
      const bmp=await createImageBitmap(qrCanvas); const codes=await det.detect(bmp);
      if(codes&&codes[0]){ qrOut.textContent=codes[0].rawValue; navigator.clipboard?.writeText(codes[0].rawValue).catch(()=>{}); stopLiveQR(); document.getElementById('qr_live_btn').textContent='Start Live Scan'; }
    },300);
  }catch{ alert('Camera blocked or unavailable'); }
}
function stopLiveQR(){ if(qrTimer){clearInterval(qrTimer);qrTimer=null;} if(qrStream){qrStream.getTracks().forEach(t=>t.stop()); qrStream=null;} qrVideo.pause(); qrVideo.removeAttribute('src'); qrVideo.style.display='none'; }
document.getElementById('qr_live_btn')?.addEventListener('click',()=>{ if(qrStream){ stopLiveQR(); document.getElementById('qr_live_btn').textContent='Start Live Scan'; } else { startLiveQR(); document.getElementById('qr_live_btn').textContent='Stop Live Scan'; }});
document.getElementById('qr_file')?.addEventListener('change',async(e)=>{const f=e.target.files[0]; if(!f)return; if(!('BarcodeDetector' in window)){alert('QR not supported for images on this browser');return;} const det=new BarcodeDetector({formats:['qr_code']}); const img=await createImageBitmap(f); const codes=await det.detect(img); if(codes&&codes[0]){qrOut.textContent=codes[0].rawValue; navigator.clipboard?.writeText(codes[0].rawValue).catch(()=>{});} else alert('No QR found in image');});

/* ========= BACKUP / RESTORE + SETTINGS UI ========= */
const K_CAL='pocketech.cal';
function snapshotAll(){ return {version:'0.83',settings:getS(),calibration:load(K_CAL),loop:load(K_LOOP),tickets:load(K_TIX)}; }
document.getElementById('bk_export')?.addEventListener('click',()=>{const blob=new Blob([JSON.stringify(snapshotAll(),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pocketech_backup.json'; a.click(); URL.revokeObjectURL(url);});
document.getElementById('bk_file')?.addEventListener('change',async(e)=>{const f=e.target.files[0]; if(!f)return; try{const txt=await f.text(); const data=JSON.parse(txt); if(data.settings) setS({...DEF,...data.settings}); if(Array.isArray(data.calibration)) save(K_CAL,data.calibration); if(Array.isArray(data.loop)) save(K_LOOP,data.loop); if(Array.isArray(data.tickets)) save(K_TIX,data.tickets); loadSettingsUI(); cal_render(); loop_render(); tix_render(); alert('Restore complete');}catch{alert('Invalid backup file');}});
document.getElementById('bk_wipe')?.addEventListener('click',()=>{if(!confirm('Wipe ALL app data (settings, logs, tickets)?')) return; localStorage.removeItem(SKEY); localStorage.removeItem(K_CAL); localStorage.removeItem(K_LOOP); localStorage.removeItem(K_TIX); loadSettingsUI(); cal_render(); loop_render(); tix_render(); alert('Wiped');});

function addMonthsISO(iso,m){ if(!m||m<=0) return ""; const d=new Date(iso); const day=d.getDate(); d.setMonth(d.getMonth()+m); if(d.getDate()<day) d.setDate(0); return d.toISOString().slice(0,10); }
function dueStatus(nextISO){ if(!nextISO) return ""; const today=new Date(); today.setHours(0,0,0,0); const next=new Date(nextISO); const diffDays=Math.floor((next-today)/(1000*60*60*24)); if(diffDays<0) return "OVERDUE"; if(diffDays<=30) return "DUE SOON"; return "OK"; }
function cal_add(){ const date=val('cal_date')||new Date().toISOString().slice(0,10); const intervalM=parseInt(document.getElementById('cal_interval').value||"0",10); const nextDueISO=intervalM?addMonthsISO(date, intervalM):""; const status=dueStatus(nextDueISO); const rec={date, tag:val('cal_tag'), dev:val('cal_dev'), lrv:parseFloat(val('cal_lrv')), urv:parseFloat(val('cal_urv')), af:val('cal_af'), al:val('cal_al'), tech:val('cal_tech'), notes:val('cal_notes'), intervalM, nextDueISO, status}; const rows=load(K_CAL); rows.push(rec); save(K_CAL,rows); cal_render(); }
function cal_csv(){ const rows=load(K_CAL); const out=[['Date','Tag','Device','LRV','URV','As-Found','As-Left','Tech','Notes','NextDue','Status','IntervalMonths']]; rows.forEach(r=>out.push([r.date,r.tag,r.dev,r.lrv,r.urv,r.af,r.al,r.tech,r.notes,r.intervalM?(r.nextDueISO||''):'',r.intervalM?(r.status||''):'',r.intervalM||0])); downloadCSV('calibration.csv',out);}
function cal_render(){ const rows=load(K_CAL); const tb=document.querySelector('#cal_tbl tbody'); if(!tb) return; tb.innerHTML=''; let mutated=false; rows.forEach(r=>{ const ns=dueStatus(r.nextDueISO||""); if(ns!==(r.status||"")){r.status=ns; mutated=true;} }); if(mutated) save(K_CAL,rows);
  rows.forEach((r,i)=>{ const pill=r.status==="OVERDUE"?"pill pill-red":(r.status==="DUE SOON"?"pill pill-yellow":"pill"); tb.insertAdjacentHTML('beforeend', `<tr><td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.dev||''}</td><td>${fmt(r.lrv)}</td><td>${fmt(r.urv)}</td><td>${r.af||''}</td><td>${r.al||''}</td><td>${r.tech||''}</td><td>${r.notes||''}</td><td>${r.intervalM?(r.nextDueISO||''):''}</td><td>${r.intervalM?`<span class="${pill}">${r.status||''}</span>`:''}</td><td><button class="btn danger" data-cal-del="${i}">✖</button></td></tr>`); });
}
document.addEventListener('click',e=>{ const d=e.target.getAttribute('data-cal-del'); if(d!==null){ const rows=load(K_CAL); rows.splice(parseInt(d,10),1); save(K_CAL,rows); cal_render(); }});
document.getElementById('cal_add')?.addEventListener('click',cal_add);
document.getElementById('cal_export')?.addEventListener('click',cal_csv);
document.getElementById('cal_clear')?.addEventListener('click',()=>{if(confirm('Clear all calibration records?')){save(K_CAL,[]); cal_render();}});
cal_render();

/* ========= FIELD LINGO FILTER ========= */
function filterTableRows(tbody, q){
  const rows=[...tbody.querySelectorAll('tr')];
  rows.forEach(tr=>{ const text=tr.textContent.toLowerCase(); tr.style.display = text.includes(q) ? '' : 'none'; });
}
document.getElementById('fl_search')?.addEventListener('input',e=>{
  const q=e.target.value.trim().toLowerCase();
  ['fl_alpha','fl_prowords','fl_prefix'].forEach(id=>{
    const tb=document.querySelector('#'+id+' tbody'); if(tb) filterTableRows(tb,q);
  });
});

/* ========= INSTALL / PWA + UPDATE / RESET (polished) ========= */
(function(){
  const installBtn = document.getElementById('installBtn');
  const updateBtn  = document.getElementById('checkUpdate');
  const resetBtn   = document.getElementById('resetApp');
  const iosTip     = document.getElementById('iosInstallTip');
  const iosTipClose= document.getElementById('iosTipClose');

  let deferredPrompt = null;

  const isIOS    = () => /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = () => /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  function setBtnBusy(btn, text){
    if (!btn) return () => {};
    const prev = btn.textContent;
    btn.disabled = true;
    if (text) btn.textContent = text;
    return () => { btn.disabled = false; btn.textContent = prev; };
  }

  // Hide install button if already installed
  if (isStandalone && installBtn) installBtn.style.display = 'none';

  // Capture install prompt (Chromium)
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    if (installBtn) installBtn.disabled = false;
  });

  // iOS Safari doesn’t fire beforeinstallprompt — show tip instead
  if (isIOS() && isSafari() && installBtn) installBtn.disabled = false;

  // After a successful install, hide the button
  window.addEventListener('appinstalled', ()=>{
    if (installBtn) installBtn.style.display = 'none';
    deferredPrompt = null;
  });

  // Install button
  installBtn?.addEventListener('click', async ()=>{
    if (deferredPrompt){
      try{
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
      }catch{}
      deferredPrompt = null;
      if (installBtn) installBtn.disabled = true;
      return;
    }
    if (isIOS() && isSafari()){
      if (iosTip) iosTip.style.display = 'flex'; // show your “Add to Home Screen” tip (if you have it)
      return;
    }
    // Fallback
    alert('Your browser may not support direct install. Try Chrome/Edge or use “Add to Home Screen”.');
  });

  iosTipClose?.addEventListener('click', ()=>{
    if (iosTip) iosTip.style.display = 'none';
  });

  // Service worker registration
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').then(reg=>{
      // When a new SW is found, move it to waiting, then tell it to activate
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw?.addEventListener('statechange', ()=>{
          if (nw.state === 'installed' && navigator.serviceWorker.controller){
            reg.waiting?.postMessage({type:'SKIP_WAITING'});
          }
        });
      });
      // When the controller changes, the new SW took over — reload once
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        // Avoid infinite loops
        if (!window._swReloaded){ window._swReloaded = true; window.location.reload(); }
      });
    }).catch(()=>{ /* ignore */ });
  }

  // “Check update” – no alert, just temporary button text
  updateBtn?.addEventListener('click', async ()=>{
    const done = setBtnBusy(updateBtn, 'Checking…');
    try{
      const reg = await navigator.serviceWorker.getRegistration();
      await reg?.update();
      // If an update installed into waiting, nudge it to activate
      reg?.waiting?.postMessage({type:'SKIP_WAITING'});
    }catch{}
    setTimeout(done, 600); // brief visual feedback
  });

  // Reset (clear caches + unregister SW)
  resetBtn?.addEventListener('click', async ()=>{
    if (!confirm('This will clear the app cache and unregister the service worker. Continue?')) return;
    const done = setBtnBusy(resetBtn, 'Resetting…');
    try{
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n)));
      const reg = await navigator.serviceWorker.getRegistration();
      await reg?.unregister();
    }catch{}
    done();
    alert('Cache reset complete. Reloading…');
    location.reload();
  });
})();

/* ========= SETTINGS UI + DEFAULTS (safe init) ========= */
function loadSettingsUI(){
  const s = getS?.() || {};
  if (document.getElementById('s_atm'))    setVal('s_atm', s.atm);
  if (document.getElementById('s_punit'))  document.getElementById('s_punit').value = s.punit || 'psi';
  if (document.getElementById('s_lunit'))  document.getElementById('s_lunit').value = s.lunit || 'in';
  if (document.getElementById('s_haptics')) document.getElementById('s_haptics').checked = !!s.haptics;
  if (document.getElementById('atm'))      setVal('atm', s.atm);
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadSettingsUI();

  document.getElementById('s_save')?.addEventListener('click', ()=>{
    const s = getS();
    const a = parseFloat(val('s_atm'));
    if (!isNaN(a)) s.atm = a;
    const pu = document.getElementById('s_punit'); if (pu) s.punit = pu.value;
    const lu = document.getElementById('s_lunit'); if (lu) s.lunit = lu.value;
    const hh = document.getElementById('s_haptics'); if (hh) s.haptics = hh.checked;
    setS(s);
    if (document.getElementById('atm')) setVal('atm', s.atm);
    alert('Saved');
  });

  document.getElementById('s_reset')?.addEventListener('click', ()=>{
    setS(DEF); loadSettingsUI(); setThemeBtnLabel?.(); applyTheme?.(); alert('Reset');
  });

  // Optional defaults (guarded)
  const slider = document.getElementById('pct_slider'); if (slider) slider.value = 50;
  if (document.getElementById('sh_pct')) setVal('sh_pct', 50);
  if (document.getElementById('read_pct')) document.getElementById('read_pct').textContent = '50%';
  if (document.getElementById('read_ma'))  document.getElementById('read_ma').textContent  = '12';
});

/* ========= MINI ROUTER (hardened) ========= */
(function () {
  const ALIAS = { jr: 'jrtech', ohms: 'ohm_drop', lingo: 'field_lingo', level_open: 'level', level_closed: 'level' };
  const backBtn = document.getElementById('backBtn');
  const titleEl = document.getElementById('appTitle');

  const allSections = () => Array.from(document.querySelectorAll('section[id]'));
  const exists  = id => allSections().some(s => s.id === id);
  const resolve = id => ALIAS[id] || id;

  function show(id){
    const tgtId = resolve(id);
    const sections = allSections();
    const targetEl = sections.find(s => s.id === tgtId) || sections.find(s => s.id === 'home');
    if (!targetEl) return;

    sections.forEach(s => {
      const on = (s === targetEl);
      s.classList.toggle('active', on);
      s.style.display = on ? 'block' : 'none';
    });

    if (backBtn) backBtn.style.display = (targetEl.id === 'home') ? 'none' : 'inline-block';
    const h2 = targetEl.querySelector('h2');
    if (titleEl) titleEl.textContent = h2 ? `PockeTech — ${h2.textContent}` : 'PockeTech — Field Tools';

    const wantHash = '#' + targetEl.id;
    if (location.hash !== wantHash) history.replaceState({id: targetEl.id}, '', wantHash);
    window.scrollTo(0, 0);
  }

  document.addEventListener('click', e => {
    const btn = e.target.closest?.('[data-go]');
    if (!btn) return;
    e.preventDefault();
    show(btn.getAttribute('data-go'));
  });

  backBtn?.addEventListener('click', e => { e.preventDefault(); show('home'); });

  window.addEventListener('popstate', e => {
    const id = e.state?.id || (location.hash || '#home').slice(1);
    show(exists(resolve(id)) ? id : 'home');
  });

  const wanted = (location.hash || '#home').slice(1);
  show(exists(resolve(wanted)) ? wanted : 'home');
})();

</script>
</body>
</html>
