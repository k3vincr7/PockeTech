<!DOCTYPE html><html lang="en" data-theme="auto"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PockeTech — Field Tools v0.82</title>
<link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#0f1115">
<style>
:root{--bg:#0f1115;--fg:#e8e8e8;--muted:#a0a0a0;--card:#151922;--border:#2a2f3a;--accent:#3a7afe;--btn:#2b3240;--btn-fg:#e8e8e8}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
header{background:var(--card);padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
header h1{margin:0;font-size:18px}
.toggle{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg);cursor:pointer}
nav{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:5}
nav button{background:var(--btn);color:var(--btn-fg);border:1px solid var(--border);padding:10px 12px;border-radius:10px;cursor:pointer;font-size:15px}
nav button.active{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(58,122,254,.15)}
main{padding:12px;max-width:1100px;margin:0 auto}
section{display:none;background:var(--card);padding:12px;border:1px solid var(--border);border-radius:10px}
section.active{display:block}
input,select,button,textarea{padding:.65em .75em;font-size:16px;border-radius:8px}
input,select,textarea{width:100%;border:1px solid var(--border);background:transparent;color:var(--fg)}
.row{display:flex;gap:10px;flex-wrap:wrap}.col{flex:1 1 240px;min-width:240px}
.btn{background:var(--btn);color:var(--btn-fg);border:1px solid var(--border);cursor:pointer}
.ok{background:#166534;border-color:#166534}.danger{background:#8b1e1e;border-color:#8b1e1e}
.muted{color:var(--muted);font-size:12px}.hr{height:1px;background:var(--border);margin:12px 0}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}th,td{border:1px solid var(--border);padding:8px;text-align:left}th{background:rgba(128,128,128,.08)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.big{font-size:28px;font-weight:600}.rowline{display:flex;align-items:center;gap:8px}
.copy{cursor:pointer;border:1px dashed var(--border);padding:4px 8px;border-radius:8px;font-size:12px;color:var(--muted)}
input[type="range"]{width:100%}.steps button{padding:.55em .7em;border-radius:999px;margin-right:6px}
footer{text-align:center;color:var(--muted);font-size:12px;padding:12px}

/* number pad — floating under active input (flips if needed) */
.numpad{position:fixed;display:none;z-index:50;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.numpad.show{display:block}
.numpad::after{content:'';position:absolute;width:14px;height:14px;background:var(--card);border-left:1px solid var(--border);border-top:1px solid var(--border);transform:rotate(45deg)}
.numpad-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;min-width:260px;max-width:min(520px,96vw)}
.np-btn{padding:16px;font-size:18px;border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--btn-fg);text-align:center;user-select:none}
.np-wide{grid-column:span 2}
.kbd-toggle{margin-top:6px;font-size:12px;border:1px dashed var(--border);background:transparent;color:var(--muted)}
</style>
</head><body>
<header>
  <h1>PockeTech — Field Tools</h1>
  <div class="row" style="gap:6px">
    <button id="installBtn" class="toggle">⬇️ Install</button>
    <button id="themeToggle" class="toggle">🌓 Theme</button>
  </div>
</header>

<nav>
  <button data-target="percent" class="active">🧮 Percent</button>
  <button data-target="signal">📈 Signal</button>
  <button data-target="level_open">🫙 Level — Open</button>
  <button data-target="level_closed">🔒 Level — Closed</button>
  <button data-target="pressure">⛽ Pressure</button>
  <button data-target="temp">🌡️ Temp</button>
  <button data-target="ip">🎛️ I/P 3–15</button>
  <button data-target="cal">📝 Calibration</button>
  <button data-target="loop">🔄 Loop Log</button>
  <button data-target="tickets">🎫 Tickets</button>
  <button data-target="qr">📷 QR Scan</button>
  <button data-target="backup">💾 Backup</button>
  <button data-target="settings">⚙️ Settings</button>
</nav>

<main>
  <!-- Percent -->
  <section id="percent" class="active">
    <h2>Percent Steps</h2>
    <div class="row">
      <div class="col"><label>LRV <input id="lrv" class="num" inputmode="decimal" placeholder="0"></label><button class="kbd-toggle" data-for="lrv">kbd</button></div>
      <div class="col"><label>URV <input id="urv" class="num" inputmode="decimal" placeholder="200"></label><button class="kbd-toggle" data-for="urv">kbd</button></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="calcPercent()">Calculate</button></div><div class="col"><button class="btn" onclick="exportPercentCSV()">Export CSV</button></div></div>
    <table id="percentTable"></table>
    <p class="muted">Outputs 0, 25, 50, 75, 100% of your range.</p>
  </section>

  <!-- Signal (nice) -->
  <section id="signal">
    <h2>4–20 mA Helper (Pro)</h2>
    <div class="row">
      <div class="col"><label>LRV (EU) <input id="sh_lrv" class="num" inputmode="decimal" placeholder="0"></label><button class="kbd-toggle" data-for="sh_lrv">kbd</button></div>
      <div class="col"><label>URV (EU) <input id="sh_urv" class="num" inputmode="decimal" placeholder="200"></label><button class="kbd-toggle" data-for="sh_urv">kbd</button></div>
      <div class="col"><label>EU Label <input id="sh_eulbl" placeholder="e.g., gpm, °F, psi"></label></div>
    </div>
    <div class="row">
      <div class="col"><label>mA <input id="sh_ma" class="num" inputmode="decimal" placeholder="12"></label><button class="kbd-toggle" data-for="sh_ma">kbd</button></div>
      <div class="col"><label>% <input id="sh_pct" class="num" inputmode="decimal" placeholder="50"></label><button class="kbd-toggle" data-for="sh_pct">kbd</button></div>
      <div class="col"><label>EU <input id="sh_eu" class="num" inputmode="decimal" placeholder="100"></label><button class="kbd-toggle" data-for="sh_eu">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><button class="btn" id="sh_from_ma">From mA</button></div>
      <div class="col"><button class="btn" id="sh_from_pct">From %</button></div>
      <div class="col"><button class="btn" id="sh_from_eu">From EU</button></div>
    </div>
    <div class="hr"></div>
    <div class="grid">
      <div class="card"><div class="rowline"><div class="big" id="read_ma">—</div><span class="copy" data-copy="#read_ma">copy</span></div><div class="muted">mA</div></div>
      <div class="card">
        <div class="rowline"><div class="big" id="read_pct">—</div><span class="copy" data-copy="#read_pct">copy</span></div>
        <div class="muted">Percent</div>
        <div class="steps" style="margin-top:8px">
          <button class="btn step" data-p="0">0%</button><button class="btn step" data-p="25">25%</button>
          <button class="btn step" data-p="50">50%</button><button class="btn step" data-p="75">75%</button><button class="btn step" data-p="100">100%</button>
        </div>
      </div>
      <div class="card">
        <div class="rowline"><div class="big" id="read_eu">—</div><span class="copy" data-copy="#read_eu">copy</span></div>
        <div class="muted">Eng Units</div>
        <label class="rowline" style="margin-top:8px"><input type="checkbox" id="sqrt_mode"> square-root (flow)</label>
      </div>
    </div>
    <div class="row" style="margin-top:10px"><div class="col"><input id="pct_slider" type="range" min="0" max="100" step="0.1" value="50"></div></div>
    <p class="muted">Slider drives % ⇄ mA ⇄ EU live.</p>
  </section>

  <!-- Level — Open -->
  <section id="level_open">
    <h2>Level — Open Tank (tap-to-tap)</h2>
    <div class="row">
      <div class="col"><label>Tap-to-tap span <input id="lo_span" class="num" inputmode="decimal" placeholder="72"></label><button class="kbd-toggle" data-for="lo_span">kbd</button></div>
      <div class="col"><label>Units <select id="lo_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
      <div class="col"><label>Specific Gravity <input id="lo_sg" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lo_sg">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><label>dP Units <select id="lo_dpU"><option value="inh2o">inH₂O</option><option value="psi">psi</option><option value="kpa">kPa</option></select></label></div>
      <div class="col"><label>LRV <input id="lo_lrv" class="num" inputmode="decimal" placeholder="0"></label><button class="kbd-toggle" data-for="lo_lrv">kbd</button></div>
      <div class="col"><label>URV <input id="lo_urv" class="num" inputmode="decimal" placeholder="auto"></label><button class="kbd-toggle" data-for="lo_urv">kbd</button></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="col"><label>Level <input id="lo_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label><button class="kbd-toggle" data-for="lo_lvl">kbd</button></div>
      <div class="col"><button class="btn" onclick="LO_levelToMa()">Level → mA</button></div>
      <div class="col"><label>mA <input id="lo_ma" class="num" inputmode="decimal" placeholder="12"></label><button class="kbd-toggle" data-for="lo_ma">kbd</button></div>
      <div class="col"><button class="btn" onclick="LO_maToLevel()">mA → Level</button></div>
    </div>
    <p id="lo_result" class="muted"></p>
    <div class="row"><div class="col"><button class="btn" onclick="LO_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
    <table id="lo_steps"><thead><tr><th>%</th><th>Level</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
  </section>

  <!-- Level — Closed -->
  <section id="level_closed">
    <h2>Level — Closed Tank (tap-to-tap)</h2>
    <div class="row">
      <div class="col"><label>Tap-to-tap span <input id="lc_span" class="num" inputmode="decimal" placeholder="72"></label><button class="kbd-toggle" data-for="lc_span">kbd</button></div>
      <div class="col"><label>Units <select id="lc_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
      <div class="col"><label>Liquid SG <input id="lc_sgL" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lc_sgL">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><label>Leg Type <select id="lc_leg"><option value="dry">Dry leg (gas)</option><option value="wet">Wet leg</option></select></label></div>
      <div class="col"><label>Wet leg height (in) <input id="lc_wetH" class="num" inputmode="decimal" placeholder="if wet"></label><button class="kbd-toggle" data-for="lc_wetH">kbd</button></div>
      <div class="col"><label>Wet leg SG <input id="lc_sgW" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lc_sgW">kbd</button></div>
    </div>
    <div class="row">
      <div class="col"><label>dP Units <select id="lc_dpU"><option value="inh2o">inH₂O</option><option value="psi">psi</option><option value="kpa">kPa</option></select></label></div>
      <div class="col"><label>LRV <input id="lc_lrv" class="num" inputmode="decimal" placeholder="auto"></label><button class="kbd-toggle" data-for="lc_lrv">kbd</button></div>
      <div class="col"><label>URV <input id="lc_urv" class="num" inputmode="decimal" placeholder="auto"></label><button class="kbd-toggle" data-for="lc_urv">kbd</button></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="col"><label>Level <input id="lc_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label><button class="kbd-toggle" data-for="lc_lvl">kbd</button></div>
      <div class="col"><button class="btn" onclick="LC_levelToMa()">Level → mA</button></div>
      <div class="col"><label>mA <input id="lc_ma" class="num" inputmode="decimal" placeholder="12"></label><button class="kbd-toggle" data-for="lc_ma">kbd</button></div>
      <div class="col"><button class="btn" onclick="LC_maToLevel()">mA → Level</button></div>
    </div>
    <p id="lc_result" class="muted"></p>
    <div class="row"><div class="col"><button class="btn" onclick="LC_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
    <table id="lc_steps"><thead><tr><th>%</th><th>Level</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
  </section>

  <!-- Pressure -->
  <section id="pressure">
    <h2>Pressure</h2>
    <h3>Quick Convert — “This → That”</h3>
    <div class="row">
      <div class="col"><label>Value <input id="pc_val_in" class="num" inputmode="decimal" placeholder="15"></label><button class="kbd-toggle" data-for="pc_val_in">kbd</button></div>
      <div class="col"><label>From <select id="pc_unit_in"><option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option><option value="pa">Pa</option><option value="mpa">MPa</option><option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option><option value="inhg">inHg</option><option value="mmhg">mmHg</option></select></label></div>
      <div class="col"><label>To <select id="pc_unit_out"><option value="kpa">kPa</option><option value="psi">psi</option><option value="bar">bar</option><option value="pa">Pa</option><option value="mpa">MPa</option><option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option><option value="inhg">inHg</option><option value="mmhg">mmHg</option></select></label></div>
    </div>
    <div class="row"><div class="col"><button class="btn" id="pc_convert">Convert</button></div><div class="col"><button class="btn" id="pc_swap">Swap</button></div><div class="col"><label>Result <input id="pc_val_out" readonly placeholder="—"></label></div></div>
    <p class="muted">inH₂O/mmH₂O@4 °C; inHg/mmHg@0 °C (field standards).</p>

    <div class="hr"></div><h3>Gauge ↔ Absolute</h3>
    <div class="row">
      <div class="col"><label>Atmospheric (psia) <input id="atm" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="atm">kbd</button></div>
      <div class="col"><label>Gauge (psig) <input id="psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psig">kbd</button></div>
      <div class="col"><label>Absolute (psia) <input id="psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psia">kbd</button></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="psigToPsia()">psig → psia</button></div><div class="col"><button class="btn" onclick="psiaToPsig()">psia → psig</button></div></div>

    <div class="hr"></div><h3>psi ↔ kPa ↔ bar</h3>
    <div class="row">
      <div class="col"><label>psi <input id="u_psi" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_psi">kbd</button></div>
      <div class="col"><label>kPa <input id="u_kpa" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_kpa">kbd</button></div>
      <div class="col"><label>bar <input id="u_bar" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_bar">kbd</button></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="fromPSI()">From psi</button></div><div class="col"><button class="btn" onclick="fromKPA()">From kPa</button></div><div class="col"><button class="btn" onclick="fromBAR()">From bar</button></div></div>

    <div class="hr"></div><h3>Pressure Switch</h3>
    <div class="row">
      <div class="col"><label>Setpoint (psig) <input id="sw_set" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_set">kbd</button></div>
      <div class="col"><label>Deadband (psig) <input id="sw_db" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_db">kbd</button></div>
      <div class="col"><label>Mode <select id="sw_mode"><option value="nc">NC (opens on rise)</option><option value="no">NO (closes on rise)</option></select></label></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="calcSwitch()">Calculate</button></div></div>
    <table id="sw_out"><tbody></tbody></table>

    <div class="hr"></div><h3>Vacuum helpers</h3>
    <div class="row">
      <div class="col"><label>Vacuum (inHg) <input id="vac_inhg" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_inhg">kbd</button></div>
      <div class="col"><label>psia <input id="vac_psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psia">kbd</button></div>
      <div class="col"><label>psig <input id="vac_psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psig">kbd</button></div>
    </div>
    <div class="row"><div class="col"><button class="btn" onclick="fromInHg()">From inHg</button></div><div class="col"><button class="btn" onclick="fromPSIA()">From psia</button></div><div class="col"><button class="btn" onclick="fromPSIG()">From psig</button></div></div>
    <p class="muted">Assumes sea-level 14.7 psia ≈ 29.92 inHg.</p>
  </section>

  <!-- Temp -->
  <section id="temp">
    <h2>Temperature</h2>
    <h3>Convert — “This → That”</h3>
    <div class="row">
      <div class="col"><label>Value <input id="tc_val" class="num" inputmode="decimal" placeholder="68"></label><button class="kbd-toggle" data-for="tc_val">kbd</button></div>
      <div class="col"><label>From <select id="tc_from"><option value="F">°F</option><option value="C">°C</option><option value="K">K</option></select></label></div>
      <div class="col"><label>To <select id="tc_to"><option value="C">°C</option><option value="F">°F</option><option value="K">K</option></select></label></div>
    </div>
    <div class="row"><div class="col"><button class="btn" id="tc_conv_btn">Convert</button></div><div class="col"><label>Result <input id="tc_out" readonly placeholder="—"></label></div></div>
    <div class="hr"></div>
    <h3>Delta T</h3>
    <div class="row">
      <div class="col"><label>ΔValue <input id="td_val" class="num" inputmode="decimal" placeholder="10"></label><button class="kbd-toggle" data-for="td_val">kbd</button></div>
      <div class="col"><label>From <select id="td_from"><option value="F">Δ°F</option><option value="C">Δ°C</option><option value="K">ΔK</option></select></label></div>
      <div class="col"><label>To <select id="td_to"><option value="C">Δ°C</option><option value="F">Δ°F</option><option value="K">ΔK</option></select></label></div>
    </div>
    <div class="row"><div class="col"><button class="btn" id="td_conv_btn">Convert Δ</button></div><div class="col"><label>Result <input id="td_out" readonly placeholder="—"></label></div></div>
  </section>

  <!-- I/P -->
  <section id="ip">
    <h2>I/P 3–15 psi Helper</h2>
    <div class="row">
      <div class="col"><label>% <input id="ip_pct" class="num" inputmode="decimal" placeholder="50"></label><button class="kbd-toggle" data-for="ip_pct">kbd</button></div>
      <div class="col"><label>psi <input id="ip_psi" class="num" inputmode="decimal" placeholder="9"></label><button class="kbd-toggle" data-for="ip_psi">kbd</button></div>
    </div>
    <div class="row"><div class="col"><button class="btn" id="ip_from_pct">From %</button></div><div class="col"><button class="btn" id="ip_from_psi">From psi</button></div></div>
    <div class="hr"></div>
    <div class="grid">
      <div class="card"><div class="rowline"><div class="big" id="ip_read_pct">—</div><span class="copy" data-copy="#ip_read_pct">copy</span></div><div class="muted">Percent</div>
        <div class="steps" style="margin-top:8px"><button class="btn ipstep" data-p="0">0%</button><button class="btn ipstep" data-p="25">25%</button><button class="btn ipstep" data-p="50">50%</button><button class="btn ipstep" data-p="75">75%</button><button class="btn ipstep" data-p="100">100%</button></div>
      </div>
      <div class="card"><div class="rowline"><div class="big" id="ip_read_psi">—</div><span class="copy" data-copy="#ip_read_psi">copy</span></div><div class="muted">psi (3–15)</div></div>
    </div>
  </section>

  <!-- Calibration -->
  <section id="cal">
    <h2>Calibration Tracker</h2>
    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="col"><label>Date <input id="cal_date" type="date"></label></div>
          <div class="col"><label>Tag <input id="cal_tag" placeholder="PT-101"></label></div>
          <div class="col"><label>Device <input id="cal_dev" placeholder="3051, I/P, Thermo"></label></div>
        </div>
        <div class="row">
          <div class="col"><label>LRV <input id="cal_lrv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_lrv">kbd</button></div>
          <div class="col"><label>URV <input id="cal_urv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_urv">kbd</button></div>
          <div class="col"><label>As-Found <input id="cal_af" class="num" inputmode="decimal" placeholder="error % or EU"></label><button class="kbd-toggle" data-for="cal_af">kbd</button></div>
        </div>
        <div class="row">
          <div class="col"><label>As-Left <input id="cal_al" class="num" inputmode="decimal" placeholder="error % or EU"></label><button class="kbd-toggle" data-for="cal_al">kbd</button></div>
          <div class="col"><label>Tech <input id="cal_tech" placeholder="Initials"></label></div>
          <div class="col"><label>Notes <input id="cal_notes" placeholder="optional note"></label></div>
        </div>
        <div class="row">
          <div class="col"><button class="btn ok" id="cal_add">Add</button></div>
          <div class="col"><button class="btn" id="cal_export">Export CSV</button></div>
          <div class="col"><button class="btn danger" id="cal_clear">Clear All</button></div>
        </div>
      </div>
      <div class="card">
        <table id="cal_tbl"><thead>
          <tr><th>Date</th><th>Tag</th><th>Device</th><th>LRV</th><th>URV</th><th>As-Found</th><th>As-Left</th><th>Tech</th><th>Notes</th><th></th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- Loop Log -->
  <section id="loop">
    <h2>Loop Check Log</h2>
    <div class="card">
      <div class="row">
        <div class="col"><label>Date <input id="lp_date" type="date"></label></div>
        <div class="col"><label>Tag <input id="lp_tag" placeholder="LT-204"></label></div>
        <div class="col"><label>Point (AI/AO/DI/DO) <input id="lp_point" placeholder="AI-101"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Expected <input id="lp_exp" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_exp">kbd</button></div>
        <div class="col"><label>Measured <input id="lp_meas" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="lp_meas">kbd</button></div>
        <div class="col"><label>OK? <select id="lp_ok"><option value="YES">YES</option><option value="NO">NO</option></select></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Notes <input id="lp_notes" placeholder="optional note"></label></div>
        <div class="col"><button class="btn ok" id="lp_add">Add</button></div>
        <div class="col"><button class="btn" id="lp_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="lp_clear">Clear All</button></div>
      </div>
    </div>
    <div class="card">
      <table id="lp_tbl"><thead>
        <tr><th>Date</th><th>Tag</th><th>Point</th><th>Expected</th><th>Measured</th><th>OK</th><th>Notes</th><th></th></tr>
      </thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Tickets -->
  <section id="tickets">
    <h2>Tickets</h2>
    <div class="card">
      <div class="row">
        <div class="col"><label>Date <input id="tk_date" type="date"></label></div>
        <div class="col"><label>Area/Unit <input id="tk_area" placeholder="Unit A"></label></div>
        <div class="col"><label>Tag <input id="tk_tag" placeholder="PT-101"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Summary <input id="tk_sum" placeholder="Short description"></label></div>
        <div class="col"><label>Status <select id="tk_status"><option>OPEN</option><option>WIP</option><option>CLOSED</option></select></label></div>
        <div class="col"><label>Photo <input id="tk_photo" type="file" accept="image/*"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn ok" id="tk_add">Add</button></div>
        <div class="col"><button class="btn" id="tk_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="tk_clear">Clear All</button></div>
      </div>
    </div>
    <div class="card">
      <table id="tk_tbl"><thead>
        <tr><th>Date</th><th>Area</th><th>Tag</th><th>Summary</th><th>Status</th><th>Photo</th><th></th></tr>
      </thead><tbody></tbody></table>
    </div>
  </section>

  <!-- QR -->
  <section id="qr">
    <h2>QR Scan</h2>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn" id="qr_live_btn">Start Live Scan</button></div>
        <div class="col"><label>or Import Photo <input id="qr_file" type="file" accept="image/*"></label></div>
      </div>
      <video id="qr_video" playsinline style="width:100%;max-height:260px;border:1px solid var(--border);border-radius:8px;display:none"></video>
      <canvas id="qr_canvas" style="display:none"></canvas>
      <div class="hr"></div>
      <div class="rowline"><div class="big" id="qr_out">—</div><span class="copy" data-copy="#qr_out">copy</span></div>
      <p class="muted">If your browser doesn’t support live QR, use “Import Photo”.</p>
    </div>
  </section>

  <!-- Backup -->
  <section id="backup">
    <h2>Backup & Restore</h2>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn" id="bk_export">Export All (JSON)</button></div>
        <div class="col"><label>Restore JSON <input id="bk_file" type="file" accept="application/json"></label></div>
        <div class="col"><button class="btn danger" id="bk_wipe">Wipe All Data</button></div>
      </div>
      <p class="muted">Included: Settings, Calibration, Loop Log, Tickets (with embedded photos).</p>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings">
    <h2>Settings</h2>
    <div class="row">
      <div class="col"><label>Default Atmosphere (psia) <input id="s_atm" class="num" inputmode="decimal" placeholder="14.7"></label><button class="kbd-toggle" data-for="s_atm">kbd</button></div>
      <div class="col"><label>Default Pressure Unit <select id="s_punit"><option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option></select></label></div>
      <div class="col"><label>Default Level Unit <select id="s_lunit"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
    </div>
    <div class="row"><div class="col"><label class="rowline"><input type="checkbox" id="s_haptics"> Haptics on keypad taps</label></div></div>
    <div class="row"><div class="col"><button class="btn ok" id="s_save">Save</button></div><div class="col"><button class="btn danger" id="s_reset">Reset to defaults</button></div></div>
  </section>
</main>

<!-- Number pad -->
<div id="numpad" class="numpad" aria-hidden="true">
  <div class="numpad-grid">
    <div class="np-btn">7</div><div class="np-btn">8</div><div class="np-btn">9</div><div class="np-btn" data-act="back">⌫</div>
    <div class="np-btn">4</div><div class="np-btn">5</div><div class="np-btn">6</div><div class="np-btn" data-act="clear">C</div>
    <div class="np-btn">1</div><div class="np-btn">2</div><div class="np-btn">3</div><div class="np-btn" data-val="-">−</div>
    <div class="np-btn np-wide">0</div><div class="np-btn">.</div><div class="np-btn np-wide" data-act="done">Done</div>
  </div>
</div>

<footer class="muted">PockeTech — v0.82</footer>

<script>
/* ---------- Settings store + theme ---------- */
const SKEY='pocketech.settings', DEF={atm:14.7,punit:'psi',lunit:'in',haptics:false,theme:'auto'};
const getS=()=>({...DEF, ...(JSON.parse(localStorage.getItem(SKEY)||'{}'))});
const setS=o=>localStorage.setItem(SKEY, JSON.stringify(o));
function syncTheme(){document.documentElement.setAttribute('data-theme', getS().theme);} syncTheme();
document.getElementById('themeToggle').addEventListener('click',()=>{const s=getS();s.theme=s.theme==='auto'?'dark':(s.theme==='dark'?'light':'auto');setS(s);syncTheme();});

/* ---------- PWA install ---------- */
let deferredPrompt=null; const installBtn=document.getElementById('installBtn'); installBtn.disabled=true;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.disabled=false;});
installBtn.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.disabled=true;});
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}

/* ---------- Nav ---------- */
document.querySelectorAll('nav button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active'); document.getElementById(btn.dataset.target).classList.add('active');
  });
});

/* ---------- Helpers ---------- */
const fmt=n=>{const x=Number(n); if(!Number.isFinite(x)) return ''; return (Math.abs(x)>=1000||x===0)?x.toFixed(2).replace(/\.00$/,''):x.toFixed(4).replace(/0+$/,'').replace(/\.$/,'');};
function toCSV(rows){return rows.map(r=>r.map(c=>{const s=(c??'').toString();return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n');}
function downloadCSV(name,rows){const blob=new Blob([toCSV(rows)],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);}
const val=id=>document.getElementById(id).value, setVal=(id,v)=>document.getElementById(id).value=v;

/* ---------- Number pad (floating dock) ---------- */
const numpad=document.getElementById('numpad'); let npTarget=null;
function buzz(ms=10){try{ if(getS().haptics && navigator.vibrate) navigator.vibrate(ms);}catch{}}
function padRect(){const r=numpad.getBoundingClientRect();return {w:r.width||320,h:r.height||260};}
function placePad(el){
  const r=el.getBoundingClientRect(), pad=padRect(), gap=8, vw=innerWidth, vh=innerHeight;
  let left=Math.max(8, Math.min(r.left, vw-pad.w-8));
  const idealW=Math.min(Math.max(r.width,260), Math.min(520,vw-16)); numpad.style.width=idealW+'px';
  let top=r.bottom+gap, flip=false; if(top+pad.h+12>vh){top=r.top-pad.h-gap;flip=true;}
  numpad.style.left=Math.round(left)+'px'; numpad.style.top=Math.round(top)+'px';
  const caretPos=Math.round(Math.min(Math.max(16,(r.left-left)+Math.min(r.width,idealW)/2), idealW-16));
  numpad.style.setProperty('--caret-left', caretPos+'px'); numpad.style.setProperty('--caret-top', flip? (pad.h-7)+'px':'-7px'); numpad.style.setProperty('--caret-rotate', flip?'225deg':'45deg');
}
const style=document.createElement('style'); style.textContent=`#numpad::after{left:var(--caret-left,24px);top:var(--caret-top,-7px);transform:rotate(var(--caret-rotate,45deg));}`; document.head.appendChild(style);
function showPad(el){npTarget=el; try{el.focus({preventScroll:true});}catch{} numpad.classList.add('show'); requestAnimationFrame(()=>placePad(el)); const v=el.value; try{el.setSelectionRange(v.length,v.length);}catch{}}
function hidePad(){numpad.classList.remove('show'); npTarget=null;}
numpad.addEventListener('click',e=>{
  const b=e.target.closest('.np-btn'); if(!b||!npTarget) return;
  const act=b.dataset.act, set=b.dataset.val||b.textContent.trim();
  if(act==='done'){hidePad();return;}
  if(act==='back'){const el=npTarget; const s=el.selectionStart??el.value.length; const epos=el.selectionEnd??el.value.length; if(s!==epos){el.value=el.value.slice(0,s)+el.value.slice(epos);} else if(s>0){el.value=el.value.slice(0,s-1)+el.value.slice(s);} try{el.setSelectionRange(Math.max(0,s-1),Math.max(0,s-1));}catch{} el.dispatchEvent(new Event('input',{bubbles:true})); return;}
  if(act==='clear'){npTarget.value=''; npTarget.dispatchEvent(new Event('input',{bubbles:true})); return;}
  if(set==='-'){npTarget.value = npTarget.value.startsWith('-')?npTarget.value.slice(1):('-'+npTarget.value); npTarget.dispatchEvent(new Event('input',{bubbles:true})); return;}
  const el=npTarget; const s=el.selectionStart??el.value.length; const epos=el.selectionEnd??el.value.length; let v=el.value; if(set==='.' && v.includes('.')) return; el.value=v.slice(0,s)+set+v.slice(epos); const pos=s+set.length; try{el.setSelectionRange(pos,pos);}catch{} el.dispatchEvent(new Event('input',{bubbles:true})); buzz(8);
});
document.addEventListener('pointerdown',e=>{ if(!numpad.classList.contains('show')) return; if(!e.target.closest('#numpad') && !e.target.closest('input.num')) hidePad(); });
addEventListener('scroll',()=>{ if(npTarget && numpad.classList.contains('show')) placePad(npTarget); }, {passive:true});
addEventListener('resize',()=>{ if(npTarget && numpad.classList.contains('show')) placePad(npTarget); });
document.querySelectorAll('input.num').forEach(inp=>{ inp.readOnly=true; inp.addEventListener('focus',()=>showPad(inp)); inp.addEventListener('click',()=>showPad(inp)); });

/* ---------- Percent ---------- */
function calcPercent(){const L=parseFloat(val('lrv')),U=parseFloat(val('urv')); if(isNaN(L)||isNaN(U)||L===U){alert('Enter valid LRV/URV');return;} const steps=[0,25,50,75,100]; const rows=[['%','EU']]; steps.forEach(p=>rows.push([p+'%',fmt(L+(U-L)*(p/100))])); document.getElementById('percentTable').innerHTML=rows.map((r,i)=>`<tr>${r.map(c=>`<${i?'td':'th'}>${c}</${i?'td':'th'}>`).join('')}</tr>`).join('');}
function exportPercentCSV(){const L=parseFloat(val('lrv')),U=parseFloat(val('urv')); if(isNaN(L)||isNaN(U)||L===U){alert('Enter valid LRV/URV');return;} downloadCSV('percent_steps.csv', [['%','EU'],['0%',L],['25%',L+(U-L)*.25],['50%',L+(U-L)*.5],['75%',L+(U-L)*.75],['100%',U]]);}

/* ---------- Signal (nice) ---------- */
function sh_getRange(){const l=parseFloat(val('sh_lrv')),u=parseFloat(val('sh_urv')); if(isNaN(l)||isNaN(u)||l===u){alert('Enter valid LRV/URV');return null;} return {l,u};}
const EUlbl=()=>{const s=document.getElementById('sh_eulbl').value.trim();return s?(' '+s):'';}
function sh_updateFromPct(p){const r=sh_getRange(); if(!r) return; const sqrt=document.getElementById('sqrt_mode').checked; const pct=Math.min(Math.max(Number(p),0),100); const ma=4+16*(pct/100); let eu; if(!sqrt){eu=r.l+(r.u-r.l)*(pct/100);} else {eu=r.l+(r.u-r.l)*Math.sqrt(pct/100);} setVal('sh_pct',fmt(pct)); setVal('sh_ma',fmt(ma)); setVal('sh_eu',fmt(eu)); document.getElementById('read_ma').textContent=fmt(ma); document.getElementById('read_pct').textContent=fmt(pct)+'%'; document.getElementById('read_eu').textContent=fmt(eu)+EUlbl(); document.getElementById('pct_slider').value=pct;}
function sh_fromMA(){const r=sh_getRange(); if(!r)return; const m=parseFloat(val('sh_ma')); if(isNaN(m)){alert('Enter mA');return;} sh_updateFromPct(Math.min(Math.max((m-4)/16*100,0),100));}
function sh_fromPct(){const p=parseFloat(val('sh_pct')); if(isNaN(p)){alert('Enter %');return;} sh_updateFromPct(p);}
function sh_fromEU(){const r=sh_getRange(); if(!r)return; const e=parseFloat(val('sh_eu')); if(isNaN(e)){alert('Enter EU');return;} const sqrt=document.getElementById('sqrt_mode').checked; let pct; if(!sqrt){pct=(e-r.l)/(r.u-r.l)*100;} else {const en=(e-r.l)/(r.u-r.l); pct=Math.pow(Math.max(en,0),2)*100;} sh_updateFromPct(pct);}
document.getElementById('sh_from_ma').addEventListener('click',sh_fromMA);
document.getElementById('sh_from_pct').addEventListener('click',sh_fromPct);
document.getElementById('sh_from_eu').addEventListener('click',sh_fromEU);
document.getElementById('pct_slider').addEventListener('input',e=>sh_updateFromPct(e.target.value));
document.getElementById('sqrt_mode').addEventListener('change',()=>{const p=parseFloat(document.getElementById('pct_slider').value||'0'); sh_updateFromPct(p);});
document.querySelectorAll('.step').forEach(b=>b.addEventListener('click',()=>sh_updateFromPct(b.dataset.p)));
document.querySelectorAll('.copy').forEach(c=>c.addEventListener('click',async()=>{const sel=c.getAttribute('data-copy');const el=document.querySelector(sel); if(!el)return; try{await navigator.clipboard.writeText(el.textContent.trim()); c.textContent='copied'; setTimeout(()=>c.textContent='copy',900);}catch{}}));

/* ---------- Pressure ---------- */
const KPA_PER_PSI=6.894757293168;
const P2PA={pa:1,kpa:1000,mpa:1e6,bar:100000,psi:6894.757293168,inh2o:249.08891,mmh2o:9.80665,inhg:3386.389,mmhg:133.322387415};
function convertP(v,from,to){if(!Number.isFinite(v))return'';const pa=v*P2PA[from];return pa/P2PA[to];}
document.getElementById('pc_convert').addEventListener('click',()=>{const v=parseFloat(val('pc_val_in')); if(isNaN(v)){alert('Enter a value');return;} const f=document.getElementById('pc_unit_in').value, t=document.getElementById('pc_unit_out').value; setVal('pc_val_out',fmt(convertP(v,f,t)));});
document.getElementById('pc_swap').addEventListener('click',()=>{const a=document.getElementById('pc_unit_in'),b=document.getElementById('pc_unit_out'); const tmp=a.value;a.value=b.value;b.value=tmp;});
function psigToPsia(){const a=parseFloat(val('atm')),g=parseFloat(val('psig')); if(isNaN(a)||isNaN(g)){alert('Enter atm and psig');return;} setVal('psia',fmt(a+g));}
function psiaToPsig(){const a=parseFloat(val('atm')),p=parseFloat(val('psia')); if(isNaN(a)||isNaN(p)){alert('Enter atm and psia');return;} setVal('psig',fmt(p-a));}
function fromPSI(){const p=parseFloat(val('u_psi')); if(isNaN(p)){alert('Enter psi');return;} setVal('u_kpa',fmt(p*KPA_PER_PSI)); setVal('u_bar',fmt(p*0.06894757));}
function fromKPA(){const k=parseFloat(val('u_kpa')); if(isNaN(k)){alert('Enter kPa');return;} const psi=k/KPA_PER_PSI; setVal('u_psi',fmt(psi)); setVal('u_bar',fmt(psi*0.06894757));}
function fromBAR(){const b=parseFloat(val('u_bar')); if(isNaN(b)){alert('Enter bar');return;} const psi=b/0.06894757; setVal('u_psi',fmt(psi)); setVal('u_kpa',fmt(psi*KPA_PER_PSI));}
function calcSwitch(){const sp=parseFloat(val('sw_set')),db=parseFloat(val('sw_db')),mode=document.getElementById('sw_mode').value; if(isNaN(sp)||isNaN(db)||db<0){alert('Enter setpoint & deadband');return;} const openOnRise=(mode==='nc'); const rows=[['Contact','Action','Pressure'],[openOnRise?'NC':'NO',openOnRise?'opens':'closes',fmt(sp)+' psig'],[openOnRise?'NC':'NO',openOnRise?'closes':'opens',fmt(sp-db)+' psig']]; const tb=document.querySelector('#sw_out tbody'); tb.innerHTML=''; rows.forEach((r,i)=>tb.insertAdjacentHTML('beforeend',`<tr>${r.map(c=>`<${i?'td':'th'}>${c}</${i?'td':'th'}>`).join('')}</tr>`));}
function fromInHg(){const inhg=parseFloat(val('vac_inhg')),atm=parseFloat(val('atm')); if(isNaN(inhg)||isNaN(atm)){alert('Enter inHg & atm');return;} const psia=atm-(inhg*atm/29.92); const psig=psia-atm; setVal('vac_psia',fmt(psia)); setVal('vac_psig',fmt(psig));}
function fromPSIA(){const psia=parseFloat(val('vac_psia')),atm=parseFloat(val('atm')); if(isNaN(psia)||isNaN(atm)){alert('Enter psia & atm');return;} const inhg=(atm-psia)*(29.92/atm); const psig=psia-atm; setVal('vac_inhg',fmt(inhg)); setVal('vac_psig',fmt(psig));}
function fromPSIG(){const psig=parseFloat(val('vac_psig')),atm=parseFloat(val('atm')); if(isNaN(psig)||isNaN(atm)){alert('Enter psig & atm');return;} const psia=psig+atm; const inhg=(atm-psia)*(29.92/atm); setVal('vac_psia',fmt(psia)); setVal('vac_inhg',fmt(inhg));}

/* ---------- Level ---------- */
const IN_PER_FT=12, IN_PER_M=39.37007874, INH2O_PER_PSI=27.679904842545, KPA_PER_PSI2=6.894757293168;
function pctToDP(p,LRV,URV){return LRV+(URV-LRV)*(p/100)} function pctToMA(p){return 4+16*(p/100)} function maToPct(ma){return (ma-4)/16*100;}
function LO_cfg(){const s=getS(); let span=parseFloat(val('lo_span')); const u=document.getElementById('lo_units').value||s.lunit; const sg=parseFloat(val('lo_sg')||'1'); const dpU=document.getElementById('lo_dpU').value; if(isNaN(span)||span<=0||isNaN(sg)||sg<=0){alert('Enter span & SG');return null;} let spanIn=span; if(u==='ft') spanIn*=IN_PER_FT; if(u==='m') spanIn*=IN_PER_M; const urv_inh2o=sg*spanIn; let LRV=parseFloat(val('lo_lrv')); if(isNaN(LRV)) LRV=0; let URV=parseFloat(val('lo_urv')); if(isNaN(URV)) URV=(dpU==='inh2o')?urv_inh2o:(dpU==='psi'? urv_inh2o/INH2O_PER_PSI : (urv_inh2o/INH2O_PER_PSI)*KPA_PER_PSI2 ); return {span,u,spanIn,sg,dpU,LRV,URV};}
function LO_levelToMa(){const c=LO_cfg(); if(!c)return; let lvl=parseFloat(val('lo_lvl')); if(isNaN(lvl)){alert('Enter level');return;} let lvlIn=lvl; if(c.u==='ft') lvlIn*=IN_PER_FT; if(c.u==='m') lvlIn*=IN_PER_M; const pct=Math.min(Math.max((lvlIn/c.spanIn)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct); document.getElementById('lo_result').innerText=`Level ${fmt(lvl)} ${c.u} → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → ${fmt(ma)} mA`; }
function LO_maToLevel(){const c=LO_cfg(); if(!c)return; const ma=parseFloat(val('lo_ma')); if(isNaN(ma)){alert('Enter mA');return;} const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV); let lvlIn=(pct/100)*c.spanIn; let lvl=lvlIn; if(c.u==='ft') lvl=lvlIn/IN_PER_FT; if(c.u==='m') lvl=lvlIn/IN_PER_M; document.getElementById('lo_result').innerText=`${fmt(ma)} mA → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → Level ${fmt(lvl)} ${c.u}`;}
function LO_buildSteps(){const c=LO_cfg(); if(!c)return; const tb=document.querySelector('#lo_steps tbody'); tb.innerHTML=''; [0,25,50,75,100].forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend',`<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`);});}

function LC_inches(v,u){if(u==='in')return v; if(u==='ft')return v*IN_PER_FT; if(u==='m')return v*IN_PER_M; return v;}
function LC_cfg(){const s=getS(); const span=parseFloat(val('lc_span')); const u=(document.getElementById('lc_units').value)||s.lunit; const sgL=parseFloat(val('lc_sgL')||'1'); const leg=document.getElementById('lc_leg').value; const wetH=parseFloat(val('lc_wetH')||'0'); const sgW=parseFloat(val('lc_sgW')||'1'); const dpU=document.getElementById('lc_dpU').value; if(isNaN(span)||span<=0||isNaN(sgL)||sgL<=0){alert('Enter span & liquid SG');return null;} const span_in=LC_inches(span,u); const dP0_inH2O=(leg==='wet')?(0 - sgW*(wetH||0)):0; const dP100_inH2O=(sgL*span_in) - (leg==='wet'? sgW*(wetH||0):0); let LRV=parseFloat(val('lc_lrv')); if(isNaN(LRV)) LRV=(dpU==='inh2o')?dP0_inH2O:(dpU==='psi'? dP0_inH2O/INH2O_PER_PSI : (dP0_inH2O/INH2O_PER_PSI)*KPA_PER_PSI2 ); let URV=parseFloat(val('lc_urv')); if(isNaN(URV)) URV=(dpU==='inh2o')?dP100_inH2O:(dpU==='psi'? dP100_inH2O/INH2O_PER_PSI : (dP100_inH2O/INH2O_PER_PSI)*KPA_PER_PSI2 ); return {span,u,span_in,sgL,leg,wetH,sgW,dpU,LRV,URV};}
function LC_levelToMa(){const c=LC_cfg(); if(!c)return; const lvl=parseFloat(val('lc_lvl')); if(isNaN(lvl)){alert('Enter level');return;} const lvl_in=LC_inches(lvl,c.u); const pct=Math.min(Math.max((lvl_in/c.span_in)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct); document.getElementById('lc_result').innerText=`Level ${fmt(lvl)} ${c.u} → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → ${fmt(ma)} mA`; }
function LC_maToLevel(){const c=LC_cfg(); if(!c)return; const ma=parseFloat(val('lc_ma')); if(isNaN(ma)){alert('Enter mA');return;} const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV); const lvl_in=(pct/100)*c.span_in; let lvl=lvl_in; if(c.u==='ft') lvl=lvl_in/IN_PER_FT; if(c.u==='m') lvl=lvl_in/IN_PER_M; document.getElementById('lc_result').innerText=`${fmt(ma)} mA → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → Level ${fmt(lvl)} ${c.u}`;}
function LC_buildSteps(){const c=LC_cfg(); if(!c)return; const tb=document.querySelector('#lc_steps tbody'); tb.innerHTML=''; [0,25,50,75,100].forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend',`<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`);});}

/* ---------- Temp ---------- */
function T_toK(v,u){if(u==='C')return v+273.15; if(u==='F')return (v-32)*5/9+273.15; return v;}
function K_to(v,u){if(u==='C')return v-273.15; if(u==='F')return (v-273.15)*9/5+32; return v;}
document.getElementById('tc_conv_btn').addEventListener('click',()=>{const v=parseFloat(val('tc_val')); if(isNaN(v)){alert('Enter temperature');return;} const k=T_toK(v,document.getElementById('tc_from').value); setVal('tc_out',fmt(K_to(k,document.getElementById('tc_to').value)));});
document.getElementById('td_conv_btn').addEventListener('click',()=>{const v=parseFloat(val('td_val')); if(isNaN(v)){alert('Enter ΔT');return;} const f=document.getElementById('td_from').value,t=document.getElementById('td_to').value; let c; if(f==='F') c=v*5/9; else if(f==='K') c=v; else c=v; let out; if(t==='F') out=c*9/5; else if(t==='K') out=c; else out=c; setVal('td_out',fmt(out));});

/* ---------- I/P ---------- */
function ip_fromPct(p){const psi=3+12*(p/100); setVal('ip_psi',fmt(psi)); document.getElementById('ip_read_pct').textContent=fmt(p)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi';}
function ip_fromPsi(psi){const p=(psi-3)/12*100; setVal('ip_pct',fmt(p)); document.getElementById('ip_read_pct').textContent=fmt(p)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi';}
document.getElementById('ip_from_pct').addEventListener('click',()=>{const p=parseFloat(val('ip_pct')); if(isNaN(p)){alert('Enter %');return;} ip_fromPct(p);});
document.getElementById('ip_from_psi').addEventListener('click',()=>{const x=parseFloat(val('ip_psi')); if(isNaN(x)){alert('Enter psi');return;} ip_fromPsi(x);});
document.querySelectorAll('.ipstep').forEach(b=>b.addEventListener('click',()=>ip_fromPct(parseFloat(b.dataset.p))));

/* ---------- Storage keys for logs ---------- */
const K_CAL='pocketech.cal', K_LOOP='pocketech.loop', K_TIX='pocketech.tix';
const load=(k)=>JSON.parse(localStorage.getItem(k)||'[]');
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ---------- Calibration ---------- */
function cal_render(){const rows=load(K_CAL); const tb=document.querySelector('#cal_tbl tbody'); tb.innerHTML=''; rows.forEach((r,i)=>{tb.insertAdjacentHTML('beforeend',`<tr><td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.dev||''}</td><td>${fmt(r.lrv)}</td><td>${fmt(r.urv)}</td><td>${r.af||''}</td><td>${r.al||''}</td><td>${r.tech||''}</td><td>${r.notes||''}</td><td><button class="btn danger" data-cal-del="${i}">✖</button></td></tr>`);});}
function cal_add(){const rec={date: val('cal_date') || new Date().toISOString().slice(0,10), tag: val('cal_tag'), dev: val('cal_dev'), lrv: parseFloat(val('cal_lrv')), urv: parseFloat(val('cal_urv')), af: val('cal_af'), al: val('cal_al'), tech: val('cal_tech'), notes: val('cal_notes')}; const rows=load(K_CAL); rows.push(rec); save(K_CAL,rows); cal_render();}
function cal_csv(){const rows=load(K_CAL); const out=[['Date','Tag','Device','LRV','URV','As-Found','As-Left','Tech','Notes']]; rows.forEach(r=>out.push([r.date,r.tag,r.dev,r.lrv,r.urv,r.af,r.al,r.tech,r.notes])); downloadCSV('calibration.csv',out);}
document.addEventListener('click',e=>{const d=e.target.getAttribute('data-cal-del'); if(d!==null){const rows=load(K_CAL); rows.splice(parseInt(d),1); save(K_CAL,rows); cal_render();}});
document.getElementById('cal_add').addEventListener('click',cal_add);
document.getElementById('cal_export').addEventListener('click',cal_csv);
document.getElementById('cal_clear').addEventListener('click',()=>{if(confirm('Clear all calibration records?')){save(K_CAL,[]); cal_render();}});
cal_render();

/* ---------- Loop Log ---------- */
function loop_render(){const rows=load(K_LOOP); const tb=document.querySelector('#lp_tbl tbody'); tb.innerHTML=''; rows.forEach((r,i)=>{tb.insertAdjacentHTML('beforeend',`<tr><td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.point||''}</td><td>${fmt(r.exp)}</td><td>${fmt(r.meas)}</td><td>${r.ok||''}</td><td>${r.notes||''}</td><td><button class="btn danger" data-lp-del="${i}">✖</button></td></tr>`);});}
function loop_add(){const rec={date: val('lp_date') || new Date().toISOString().slice(0,10), tag: val('lp_tag'), point: val('lp_point'), exp: parseFloat(val('lp_exp')), meas: parseFloat(val('lp_meas')), ok: document.getElementById('lp_ok').value, notes: val('lp_notes')}; const rows=load(K_LOOP); rows.push(rec); save(K_LOOP,rows); loop_render();}
function loop_csv(){const rows=load(K_LOOP); const out=[['Date','Tag','Point','Expected','Measured','OK','Notes']]; rows.forEach(r=>out.push([r.date,r.tag,r.point,r.exp,r.meas,r.ok,r.notes])); downloadCSV('loop_log.csv',out);}
document.addEventListener('click',e=>{const d=e.target.getAttribute('data-lp-del'); if(d!==null){const rows=load(K_LOOP); rows.splice(parseInt(d),1); save(K_LOOP,rows); loop_render();}});
document.getElementById('lp_add').addEventListener('click',loop_add);
document.getElementById('lp_export').addEventListener('click',loop_csv);
document.getElementById('lp_clear').addEventListener('click',()=>{if(confirm('Clear all loop rows?')){save(K_LOOP,[]); loop_render();}});
loop_render();

/* ---------- Tickets (photos embedded) ---------- */
async function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file);});}
function tix_render(){const rows=load(K_TIX); const tb=document.querySelector('#tk_tbl tbody'); tb.innerHTML=''; rows.forEach((r,i)=>{const img=r.photo?`<img src="${r.photo}" alt="photo" style="max-height:36px;border-radius:6px;border:1px solid var(--border)">`:''; tb.insertAdjacentHTML('beforeend',`<tr><td>${r.date||''}</td><td>${r.area||''}</td><td>${r.tag||''}</td><td>${r.sum||''}</td><td>${r.status||''}</td><td>${img}</td><td><button class="btn danger" data-tk-del="${i}">✖</button></td></tr>`);});}
async function tix_add(){const f=document.getElementById('tk_photo').files[0]; const photo=f?await fileToDataURL(f):''; const rec={date: val('tk_date')||new Date().toISOString().slice(0,10), area: val('tk_area'), tag: val('tk_tag'), sum: val('tk_sum'), status: document.getElementById('tk_status').value, photo}; const rows=load(K_TIX); rows.push(rec); save(K_TIX,rows); tix_render();}
function tix_csv(){const rows=load(K_TIX); const out=[['Date','Area','Tag','Summary','Status','Photo(dataURL)']]; rows.forEach(r=>out.push([r.date,r.area,r.tag,r.sum,r.status,r.photo?('[embedded]'):''])); downloadCSV('tickets.csv',out);}
document.addEventListener('click',e=>{const d=e.target.getAttribute('data-tk-del'); if(d!==null){const rows=load(K_TIX); rows.splice(parseInt(d),1); save(K_TIX,rows); tix_render();}});
document.getElementById('tk_add').addEventListener('click',tix_add);
document.getElementById('tk_export').addEventListener('click',tix_csv);
document.getElementById('tk_clear').addEventListener('click',()=>{if(confirm('Clear all tickets?')){save(K_TIX,[]); tix_render();}});
tix_render();

/* ---------- QR Scanner ---------- */
const qrVideo=document.getElementById('qr_video'), qrCanvas=document.getElementById('qr_canvas'), qrOut=document.getElementById('qr_out');
let qrStream=null, qrTimer=null;
async function startLiveQR(){
  if(!('BarcodeDetector' in window)){ alert('Live QR not supported in this browser. Use “Import Photo”.'); return; }
  try{
    qrVideo.style.display='block';
    qrStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    qrVideo.srcObject=qrStream; await qrVideo.play();
    const det=new BarcodeDetector({formats:['qr_code']});
    qrTimer=setInterval(async()=>{
      const w=qrVideo.videoWidth,h=qrVideo.videoHeight; if(!w||!h) return;
      qrCanvas.width=w; qrCanvas.height=h; const ctx=qrCanvas.getContext('2d'); ctx.drawImage(qrVideo,0,0,w,h);
      const bmp=await createImageBitmap(qrCanvas); const codes=await det.detect(bmp);
      if(codes&&codes[0]){ qrOut.textContent=codes[0].rawValue; navigator.clipboard?.writeText(codes[0].rawValue).catch(()=>{}); stopLiveQR(); document.getElementById('qr_live_btn').textContent='Start Live Scan'; }
    },300);
  }catch{ alert('Camera blocked or unavailable'); }
}
function stopLiveQR(){ if(qrTimer){clearInterval(qrTimer);qrTimer=null;} if(qrStream){qrStream.getTracks().forEach(t=>t.stop()); qrStream=null;} qrVideo.pause(); qrVideo.removeAttribute('src'); qrVideo.style.display='none'; }
document.getElementById('qr_live_btn').addEventListener('click',()=>{ if(qrStream){ stopLiveQR(); document.getElementById('qr_live_btn').textContent='Start Live Scan'; } else { startLiveQR(); document.getElementById('qr_live_btn').textContent='Stop Live Scan'; }});
document.getElementById('qr_file').addEventListener('change',async(e)=>{const f=e.target.files[0]; if(!f)return; if(!('BarcodeDetector' in window)){alert('QR not supported for images on this browser');return;} const det=new BarcodeDetector({formats:['qr_code']}); const img=await createImageBitmap(f); const codes=await det.detect(img); if(codes&&codes[0]){qrOut.textContent=codes[0].rawValue; navigator.clipboard?.writeText(codes[0].rawValue).catch(()=>{});} else alert('No QR found in image');});

/* ---------- Backup / Restore ---------- */
function snapshotAll(){ return {version:'0.82',settings:getS(),calibration:load(K_CAL),loop:load(K_LOOP),tickets:load(K_TIX)}; }
document.getElementById('bk_export').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(snapshotAll(),null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pocketech_backup.json'; a.click(); URL.revokeObjectURL(url);});
document.getElementById('bk_file').addEventListener('change',async(e)=>{const f=e.target.files[0]; if(!f)return; try{const txt=await f.text(); const data=JSON.parse(txt); if(data.settings) setS({...DEF,...data.settings}); if(Array.isArray(data.calibration)) save(K_CAL,data.calibration); if(Array.isArray(data.loop)) save(K_LOOP,data.loop); if(Array.isArray(data.tickets)) save(K_TIX,data.tickets); loadSettingsUI(); cal_render(); loop_render(); tix_render(); alert('Restore complete');}catch{alert('Invalid backup file');}});
document.getElementById('bk_wipe').addEventListener('click',()=>{if(!confirm('Wipe ALL app data (settings, logs, tickets)?')) return; localStorage.removeItem(SKEY); localStorage.removeItem(K_CAL); localStorage.removeItem(K_LOOP); localStorage.removeItem(K_TIX); loadSettingsUI(); cal_render(); loop_render(); tix_render(); alert('Wiped');});

/* ---------- Settings UI ---------- */
function loadSettingsUI(){const s=getS(); setVal('s_atm',s.atm); document.getElementById('s_punit').value=s.punit; document.getElementById('s_lunit').value=s.lunit; document.getElementById('s_haptics').checked=!!s.haptics; setVal('atm', s.atm);}
loadSettingsUI();
document.getElementById('s_save').addEventListener('click',()=>{const s=getS(); const a=parseFloat(val('s_atm')); if(!isNaN(a)) s.atm=a; s.punit=document.getElementById('s_punit').value; s.lunit=document.getElementById('s_lunit').value; s.haptics=document.getElementById('s_haptics').checked; setS(s); setVal('atm', s.atm); alert('Saved');});
document.getElementById('s_reset').addEventListener('click',()=>{setS(DEF); loadSettingsUI(); alert('Reset');});

/* ---------- Defaults ---------- */
document.getElementById('pct_slider').value=50; setVal('sh_pct',50); document.getElementById('read_pct').textContent='50%'; document.getElementById('read_ma').textContent='12'; setVal('atm', getS().atm);
</script>
</body></html>
