<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PockeTech ‚Äî Field Tools</title>
  <style>
    :root{
      --bg:#f5f5f5; --fg:#222; --muted:#777; --card:#fff; --border:#d0d0d0;
      --accent:#3a7afe; --btn:#444; --btn-fg:#fff;
    }
    @media (prefers-color-scheme: dark) {
      :root{ --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0; --card:#151922; --border:#2a2f3a; --btn:#2b3240; --btn-fg:#e8e8e8; }
    }
    [data-theme="light"]{ --bg:#f5f5f5; --fg:#222; --muted:#777; --card:#fff; --border:#d0d0d0; --btn:#444; --btn-fg:#fff; }
    [data-theme="dark"]{ --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0; --card:#151922; --border:#2a2f3a; --btn:#2b3240; --btn-fg:#e8e8e8; }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--fg); }
    header{ background:var(--card); padding:12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    header h1{ margin:0; font-size:18px; }
    .toggle{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:var(--card); cursor:pointer; }

    nav{ display:flex; flex-wrap:wrap; gap:6px; padding:10px; border-bottom:1px solid var(--border); background:var(--card); position:sticky; top:0; z-index:5; }
    nav button{ background:var(--btn); color:var(--btn-fg); border:none; padding:14px 16px; border-radius:10px; cursor:pointer; font-size:15px; }
    nav button.active{ outline:2px solid var(--accent); }

    main{ padding:12px; max-width:1100px; margin:0 auto; }
    section{ display:none; background:var(--card); padding:12px; border:1px solid var(--border); border-radius:10px; }
    section.active{ display:block; }

    input,select,button,textarea{ padding:.65em .75em; font-size:16px; border-radius:8px; }
    input,select,textarea{ width:100%; border:1px solid var(--border); background:transparent; color:var(--fg); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1 1 240px; min-width:240px; }
    .btn{ background:var(--btn); color:var(--btn-fg); border:1px solid var(--border); cursor:pointer; }
    .ok{ background:#166534; border-color:#166534; }
    .danger{ background:#8b1e1e; border-color:#8b1e1e; }
    .muted{ color:var(--muted); font-size:12px; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
    th,td{ border:1px solid var(--border); padding:8px; text-align:left; }
    th{ background:rgba(128,128,128,.08); }
    footer{ text-align:center; color:var(--muted); font-size:12px; padding:12px; }
    .hidden{ display:none; }
    .pill{ padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
    .pill.open{ background:#2f3646; } .pill.blocked{ background:#5a3a2f;} .pill.done{ background:#243a2f;}

    /* Number pad */
    .numpad {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--card); border-top: 1px solid var(--border);
      display: none; padding: 8px; z-index: 50;
      box-shadow: 0 -6px 20px rgba(0,0,0,.25);
    }
    .numpad.show { display: block; }
    .numpad-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
      max-width: 520px; margin: 0 auto;
    }
    .np-btn {
      padding: 16px; font-size: 18px; border-radius: 10px; border:1px solid var(--border);
      background: var(--btn); color: var(--btn-fg); text-align: center; user-select: none;
    }
    .np-wide { grid-column: span 2; }
  </style>
</head>
<body>
  <header>
    <h1>PockeTech ‚Äî Field Tools</h1>
    <button id="themeToggle" class="toggle" title="Toggle dark/light">üåì Theme</button>
  </header>

  <nav>
    <button data-target="percent" class="active">Percent</button>
    <button data-target="signal">Signal</button>
    <button data-target="level_open">Level ‚Äî Open</button>
    <button data-target="level_closed">Level ‚Äî Closed</button>
    <button data-target="pressure">Pressure</button>
    <button data-target="cal">Calibration</button>
    <button data-target="loop">Loop Log</button>
    <button data-target="tickets">Tickets</button>
    <button data-target="qr">QR Scan</button>
    <button data-target="backup">Backup</button>
  </nav>

  <main>
    <!-- Percent Steps -->
    <section id="percent" class="active">
      <h2>Percent Steps</h2>
      <div class="row">
        <div class="col"><label>LRV <input id="lrv" class="num" inputmode="decimal" placeholder="0"></label></div>
        <div class="col"><label>URV <input id="urv" class="num" inputmode="decimal" placeholder="200"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="calcPercent()">Calculate</button></div>
        <div class="col"><button class="btn" onclick="exportPercentCSV()">Export CSV</button></div>
      </div>
      <table id="percentTable"></table>
      <p class="muted">Outputs 0, 25, 50, 75, 100% of your range.</p>
    </section>

    <!-- Signal Helper -->
    <section id="signal">
      <h2>Signal Helper (4‚Äì20 mA)</h2>
      <div class="row">
        <div class="col"><label>LRV (EU) <input id="sh_lrv" class="num" inputmode="decimal" placeholder="0"></label></div>
        <div class="col"><label>URV (EU) <input id="sh_urv" class="num" inputmode="decimal" placeholder="200"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>mA <input id="ma" class="num" inputmode="decimal" placeholder="12"></label></div>
        <div class="col"><label>% <input id="percentInput" class="num" inputmode="decimal" placeholder="50"></label></div>
        <div class="col"><label>EU <input id="eu" class="num" inputmode="decimal" placeholder="100"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="maToPercent()">From mA</button></div>
        <div class="col"><button class="btn" onclick="percentToMa()">From %</button></div>
        <div class="col"><button class="btn" onclick="euToPercent()">From EU</button></div>
        <div class="col"><button class="btn" onclick="signalClear()">Clear</button></div>
      </div>
      <p id="signalResult" class="muted"></p>
    </section>

    <!-- Level ‚Äî Open (tap-to-tap) -->
    <section id="level_open">
      <h2>Level ‚Äî Open Tank (tap-to-tap)</h2>
      <div class="row">
        <div class="col"><label>Tap-to-tap span <input id="lo_span" class="num" inputmode="decimal" placeholder="e.g., 72"></label></div>
        <div class="col"><label>Units
          <select id="lo_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select>
        </label></div>
        <div class="col"><label>Specific Gravity (SG) <input id="lo_sg" class="num" inputmode="decimal" value="1.0"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>dP Units
          <select id="lo_dpU"><option value="inh2o">inH‚ÇÇO</option><option value="psi">psi</option><option value="kpa">kPa</option></select>
        </label></div>
        <div class="col"><label>LRV (optional) <input id="lo_lrv" class="num" inputmode="decimal" placeholder="blank = 0"></label></div>
        <div class="col"><label>URV (optional) <input id="lo_urv" class="num" inputmode="decimal" placeholder="blank = auto"></label></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col"><label>Level <input id="lo_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label></div>
        <div class="col"><button class="btn" onclick="LO_levelToMa()">Level ‚Üí mA</button></div>
        <div class="col"><label>mA <input id="lo_ma" class="num" inputmode="decimal" placeholder="e.g., 12"></label></div>
        <div class="col"><button class="btn" onclick="LO_maToLevel()">mA ‚Üí Level</button></div>
      </div>
      <p id="lo_result" class="muted"></p>
      <div class="row"><div class="col"><button class="btn" onclick="LO_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
      <table id="lo_steps"><thead><tr><th>%</th><th>Level (span units)</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
      <p class="muted">Open tank: ŒîP = œÅ g h ‚áí with SG, inH‚ÇÇO@100% ‚âà SG √ó span(in).</p>
    </section>

    <!-- Level ‚Äî Closed (tap-to-tap) -->
    <section id="level_closed">
      <h2>Level ‚Äî Closed Tank (tap-to-tap)</h2>
      <div class="row">
        <div class="col"><label>Tap-to-tap span <input id="lc_span" class="num" inputmode="decimal" placeholder="e.g., 72"></label></div>
        <div class="col"><label>Units
          <select id="lc_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select>
        </label></div>
        <div class="col"><label>Liquid SG <input id="lc_sgL" class="num" inputmode="decimal" value="1.0"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Leg Type
          <select id="lc_leg"><option value="dry">Dry leg (gas)</option><option value="wet">Wet leg (condensing)</option></select>
        </label></div>
        <div class="col"><label>Wet leg height (in) <input id="lc_wetH" class="num" inputmode="decimal" placeholder="if wet"></label></div>
        <div class="col"><label>Wet leg SG <input id="lc_sgW" class="num" inputmode="decimal" value="1.0"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>dP Units
          <select id="lc_dpU"><option value="inh2o">inH‚ÇÇO</option><option value="psi">psi</option><option value="kpa">kPa</option></select>
        </label></div>
        <div class="col"><label>LRV (optional) <input id="lc_lrv" class="num" inputmode="decimal" placeholder="auto"></label></div>
        <div class="col"><label>URV (optional) <input id="lc_urv" class="num" inputmode="decimal" placeholder="auto"></label></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col"><label>Level <input id="lc_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label></div>
        <div class="col"><button class="btn" onclick="LC_levelToMa()">Level ‚Üí mA</button></div>
        <div class="col"><label>mA <input id="lc_ma" class="num" inputmode="decimal" placeholder="e.g., 12"></label></div>
        <div class="col"><button class="btn" onclick="LC_maToLevel()">mA ‚Üí Level</button></div>
      </div>
      <p id="lc_result" class="muted"></p>
      <div class="row"><div class="col"><button class="btn" onclick="LC_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
      <table id="lc_steps"><thead><tr><th>%</th><th>Level (span units)</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
      <p class="muted">Dry leg: ŒîP = œÅ_l g h. Wet leg: ŒîP = œÅ_l g h ‚àí œÅ_w g H_w (constant offset).</p>
    </section>

    <!-- Pressure -->
    <section id="pressure">
      <h2>Pressure</h2>
      <h3>Gauge ‚Üî Absolute</h3>
      <div class="row">
        <div class="col"><label>Atmospheric (psia) <input id="atm" class="num" inputmode="decimal" value="14.7"></label></div>
        <div class="col"><label>Gauge (psig) <input id="psig" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>Absolute (psia) <input id="psia" class="num" inputmode="decimal"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="psigToPsia()">psig ‚Üí psia</button></div>
        <div class="col"><button class="btn" onclick="psiaToPsig()">psia ‚Üí psig</button></div>
      </div>

      <div class="hr"></div>
      <h3>psi ‚Üî kPa ‚Üî bar</h3>
      <div class="row">
        <div class="col"><label>psi <input id="u_psi" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>kPa <input id="u_kpa" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>bar <input id="u_bar" class="num" inputmode="decimal"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="fromPSI()">From psi</button></div>
        <div class="col"><button class="btn" onclick="fromKPA()">From kPa</button></div>
        <div class="col"><button class="btn" onclick="fromBAR()">From bar</button></div>
      </div>

      <div class="hr"></div>
      <h3>Pressure Switch</h3>
      <div class="row">
        <div class="col"><label>Setpoint (rising, psig) <input id="sw_set" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>Deadband (psig) <input id="sw_db" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>Mode
          <select id="sw_mode"><option value="nc">NC (opens on rise)</option><option value="no">NO (closes on rise)</option></select>
        </label></div>
      </div>
      <div class="row"><div class="col"><button class="btn" onclick="calcSwitch()">Calculate</button></div></div>
      <table id="sw_out"><tbody></tbody></table>

      <div class="hr"></div>
      <h3>Vacuum helpers</h3>
      <div class="row">
        <div class="col"><label>Vacuum (inHg) <input id="vac_inhg" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>psia <input id="vac_psia" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>psig <input id="vac_psig" class="num" inputmode="decimal"></label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="fromInHg()">From inHg</button></div>
        <div class="col"><button class="btn" onclick="fromPSIA()">From psia</button></div>
        <div class="col"><button class="btn" onclick="fromPSIG()">From psig</button></div>
      </div>
      <p class="muted">Assumes 29.92 inHg at 14.7 psia (sea level standard).</p>
    </section>

    <!-- Calibration -->
    <section id="cal">
      <h2>Calibration Tracker</h2>
      <div class="row">
        <div class="col"><label>Tag <input id="cal_tag" placeholder="PT-101"></label></div>
        <div class="col"><label>Make/Model <input id="cal_model" placeholder="Yokogawa EJA"></label></div>
        <div class="col"><label>Type <input id="cal_type" placeholder="PT/FT/LT/TT"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>LRV <input id="cal_lrv" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>URV <input id="cal_urv" class="num" inputmode="decimal"></label></div>
        <div class="col"><label>Method <input id="cal_method" placeholder="5-point, AF/AL"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>As-Found <input id="cal_af" placeholder="0.12%"></label></div>
        <div class="col"><label>As-Left <input id="cal_al" placeholder="0.05%"></label></div>
        <div class="col"><label>Date <input id="cal_date" type="date"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Interval <select id="cal_interval"><option value="">Select</option><option value="6">6 months</option><option value="12">12 months</option></select></label></div>
        <div class="col"><label>Next Due <input id="cal_due" readonly placeholder="auto"></label></div>
        <div class="col"><label>Tech <input id="cal_tech" placeholder="K. Calvillo"></label></div>
      </div>
      <div class="row"><div class="col" style="flex:1 1 100%"><label>Notes <input id="cal_notes" placeholder="‚Ä¶"></label></div></div>
      <div class="row">
        <div class="col"><button class="btn" id="cal_add">Add</button></div>
        <div class="col"><button class="btn" id="cal_export">Export CSV</button></div>
        <div class="col"><button class="btn" id="cal_tpl">CSV Template</button></div>
        <div class="col"><button class="btn" id="cal_import_btn" type="button">Import CSV</button><input id="cal_import" type="file" accept=".csv" class="hidden"></div>
        <div class="col"><button class="btn danger" id="cal_clear">Clear All (local)</button></div>
      </div>
      <div class="hr"></div>
      <table id="cal_table"><thead><tr><th>Tag</th><th>Make/Model</th><th>Type</th><th>LRV</th><th>URV</th><th>Method</th><th>As-Found</th><th>As-Left</th><th>Date</th><th>Interval</th><th>Next Due</th><th>Tech</th><th>Notes</th></tr></thead><tbody></tbody></table>
      <p class="muted">Stored locally on this device.</p>
    </section>

    <!-- Loop Check Log -->
    <section id="loop">
      <h2>Loop Check Log</h2>
      <form id="loopForm">
        <div class="row">
          <div class="col"><input id="tag" placeholder="Tag" required></div>
          <div class="col"><input id="service" placeholder="Service"></div>
          <div class="col"><select id="type"><option>AI</option><option>AO</option><option>DI</option><option>DO</option></select></div>
        </div>
        <div class="row">
          <div class="col"><input id="rangeLrv" class="num" inputmode="decimal" placeholder="LRV"></div>
          <div class="col"><input id="rangeUrv" class="num" inputmode="decimal" placeholder="URV"></div>
          <div class="col"><input id="date" type="date" placeholder="Date"></div>
        </div>
        <div class="row">
          <div class="col"><input id="asFound" placeholder="As-Found"></div>
          <div class="col"><input id="asLeft" placeholder="As-Left"></div>
          <div class="col"><input id="tech" placeholder="Technician"></div>
        </div>
        <div class="row">
          <div class="col" style="flex:1 1 100%"><input id="notes" placeholder="Notes"></div>
          <div class="col"><select id="status"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        </div>
        <div class="row">
          <div class="col"><button class="btn ok" type="submit">Add</button></div>
          <div class="col"><button class="btn" type="button" onclick="downloadLoopCSV()">Export CSV</button></div>
          <div class="col"><button class="btn" type="button" id="loop_tpl">CSV Template</button></div>
          <div class="col"><button class="btn" type="button" id="loop_import_btn">Import CSV</button><input id="loop_import" type="file" accept=".csv" class="hidden"></div>
          <div class="col"><button class="btn danger" type="button" onclick="clearLoop()">Clear All (local)</button></div>
        </div>
      </form>
      <div class="row">
        <div class="col"><input id="loop_filter_tag" placeholder="Filter by tag (optional)"></div>
        <div class="col"><button class="btn" type="button" onclick="applyLoopFilter()">Apply Filter</button></div>
      </div>
      <table id="loopTable"><thead><tr><th>Date</th><th>Tag</th><th>Service</th><th>Type</th><th>LRV</th><th>URV</th><th>As-Found</th><th>As-Left</th><th>Tech</th><th>Status</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- Tickets -->
    <section id="tickets">
      <h2>Tickets</h2>
      <div class="row">
        <div class="col"><input id="t_title" placeholder="Title"></div>
        <div class="col"><input id="t_system" placeholder="System/Tag"></div>
        <div class="col"><select id="t_sev"><option>Low</option><option>Med</option><option>High</option></select></div>
      </div>
      <div class="row">
        <div class="col"><select id="t_status"><option>Open</option><option>Blocked</option><option>Done</option></select></div>
        <div class="col"><input id="t_assignee" placeholder="Assignee"></div>
        <div class="col"><input id="t_date" type="date"></div>
      </div>
      <div class="row"><div class="col" style="flex:1 1 100%"><textarea id="t_notes" placeholder="Notes"></textarea></div></div>
      <div class="row"><div class="col"><input id="t_photos" type="file" accept="image/*" multiple capture="environment"></div></div>
      <div class="row">
        <div class="col"><button class="btn ok" id="t_add">Add Ticket</button></div>
        <div class="col"><button class="btn" id="t_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="t_clear">Clear All (local)</button></div>
      </div>
      <div class="hr"></div>
      <table id="t_table"><thead><tr><th>Title</th><th>System/Tag</th><th>Severity</th><th>Status</th><th>Assignee</th><th>Date</th><th>Notes</th><th>Photos</th><th>Actions</th></tr></thead><tbody></tbody></table>
      <p class="muted">Photos are stored locally as thumbnails; CSV lists counts.</p>
    </section>

    <!-- QR Scan -->
    <section id="qr">
      <h2>QR Scan</h2>
      <p class="muted">Scan a QR with a tag (or a URL query like <code>?tag=PT-101</code>) and we‚Äôll filter the Loop Log.</p>
      <div class="row">
        <div class="col"><button class="btn" id="qr_live_btn">Start Live Scan</button></div>
        <div class="col"><button class="btn" id="qr_photo_btn">Scan from Photo</button><input id="qr_photo" type="file" accept="image/*" capture="environment" class="hidden"></div>
      </div>
      <video id="qr_video" class="hidden" autoplay playsinline style="width:100%; max-width:420px; border-radius:8px; border:1px solid var(--border);"></video>
      <p id="qr_result" class="muted"></p>
    </section>

    <!-- Backup -->
    <section id="backup">
      <h2>Backup & Restore</h2>
      <p class="muted">Backup all (Calibration + Loop + Tickets) to JSON. Restore later on any device.</p>
      <div class="row">
        <div class="col"><button class="btn" id="bk_export">Export All (JSON)</button></div>
        <div class="col"><button class="btn" id="bk_import_btn">Import All (JSON)</button><input id="bk_import" type="file" accept=".json,application/json" class="hidden"></div>
        <div class="col"><button class="btn danger" id="bk_clear">Clear All (local)</button></div>
      </div>
    </section>
  </main>

  <!-- Number pad overlay -->
  <div id="numpad" class="numpad" aria-hidden="true">
    <div class="numpad-grid">
      <div class="np-btn">7</div><div class="np-btn">8</div><div class="np-btn">9</div><div class="np-btn" data-act="back">‚å´</div>
      <div class="np-btn">4</div><div class="np-btn">5</div><div class="np-btn">6</div><div class="np-btn" data-act="clear">C</div>
      <div class="np-btn">1</div><div class="np-btn">2</div><div class="np-btn">3</div><div class="np-btn" data-val="-">‚àí</div>
      <div class="np-btn np-wide">0</div><div class="np-btn">.</div><div class="np-btn np-wide" data-act="done">Done</div>
    </div>
  </div>

  <footer class="muted">PockeTech ‚Äî v0.7</footer>

  <script>
    // Theme toggle
    const themeBtn=document.getElementById('themeToggle');
    const root=document.documentElement;
    const THEME_KEY='pocketech.theme';
    function applyTheme(t){ root.setAttribute('data-theme',t); localStorage.setItem(THEME_KEY,t); }
    applyTheme(localStorage.getItem(THEME_KEY)||'auto');
    themeBtn.addEventListener('click',()=>{ const cur=root.getAttribute('data-theme')||'auto'; const next=cur==='auto'?'dark':(cur==='dark'?'light':'auto'); applyTheme(next); alert('Theme: '+next); });

    // Router
    document.querySelectorAll('nav button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // Helpers
    function toCSV(rows){return rows.map(r=>r.map(c=>{const s=(c??'').toString();return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n');}
    function downloadCSV(filename, rows){ const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
    const fmt=n=>{const x=Number(n); if(!Number.isFinite(x)) return ''; return (Math.abs(x)>=1000||x===0)?x.toFixed(2).replace(/\.00$/,''):x.toFixed(4).replace(/0+$/,'').replace(/\.$/,'');};
    function parseCSV(t){const rows=[];let i=0,cur='',row=[],q=false;while(i<t.length){const c=t[i];if(q){if(c==='"'&&t[i+1]==='"'){cur+='"';i+=2;continue}if(c==='"'){q=false;i++;continue}cur+=c;i++;continue}else{if(c==='"'){q=true;i++;continue}if(c===','){row.push(cur);cur='';i++;continue}if(c==='\n'||c==='\r'){if(c==='\r'&&t[i+1]==='\n')i++;row.push(cur);rows.push(row);row=[];cur='';i++;continue}cur+=c;i++;continue}}row.push(cur);rows.push(row);if(rows.length&&rows[rows.length-1].length===1&&rows[rows.length-1][0]==='')rows.pop();return rows;}
    function indexHeaders(h){const m={};h.forEach((x,i)=>{m[(x||'').toString().trim().toLowerCase()]=i});return m;}
    function val(id){return document.getElementById(id).value;}
    function setVal(id,v){document.getElementById(id).value=v;}

    // Global Number Pad
    const numpad = document.getElementById('numpad');
    let npTarget = null;
    function showPad(forInput){
      npTarget = forInput; numpad.classList.add('show'); numpad.setAttribute('aria-hidden','false');
      const v = npTarget.value; npTarget.focus(); try{ npTarget.setSelectionRange(v.length, v.length); }catch{}
      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    }
    function hidePad(){ numpad.classList.remove('show'); numpad.setAttribute('aria-hidden','true'); npTarget = null; }
    function insertVal(s){
      if(!npTarget) return;
      const el=npTarget;
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      let v = el.value;
      if(s==='.' && v.includes('.')) return;
      if(s==='-'){
        // toggle leading minus
        if(v.startsWith('-')) v = v.slice(1);
        else v = '-' + v;
        el.value = v; return;
      }
      el.value = v.slice(0,start) + s + v.slice(end);
      const pos = start + s.length;
      try{ el.setSelectionRange(pos,pos); }catch{}
    }
    function wireNumpad(){
      document.querySelectorAll('input.num').forEach(inp=>{
        inp.addEventListener('focus', ()=> showPad(inp));
        inp.addEventListener('blur', ()=> setTimeout(()=>{ if(document.activeElement !== inp) hidePad(); }, 120));
      });
    }
    numpad.addEventListener('click', (e)=>{
      const btn = e.target.closest('.np-btn'); if(!btn||!npTarget) return;
      const act = btn.dataset.act; const explicitVal = btn.dataset.val;
      if(act==='back'){
        const el=npTarget; const start=el.selectionStart??el.value.length; const end=el.selectionEnd??el.value.length;
        if(start!==end){ el.value = el.value.slice(0,start) + el.value.slice(end); try{ el.setSelectionRange(start,start); }catch{} return; }
        if(start>0){ el.value = el.value.slice(0,start-1) + el.value.slice(start); try{ el.setSelectionRange(start-1,start-1);}catch{} }
        return;
      }
      if(act==='clear'){ npTarget.value=''; return; }
      if(act==='done'){ hidePad(); return; }
      const text = explicitVal || btn.textContent.trim();
      insertVal(text);
      npTarget.dispatchEvent(new Event('input',{bubbles:true}));
    });

    // Percent
    function calcPercent(){const l=parseFloat(val('lrv')), u=parseFloat(val('urv')); if(isNaN(l)||isNaN(u)||l===u){alert('Enter numeric LRV/URV (not equal).');return;} const steps=[0,25,50,75,100]; let html="<tr><th>%</th><th>Value</th></tr>"; steps.forEach(p=>{const v=l+(u-l)*(p/100); html+=`<tr><td>${p}%</td><td>${fmt(v)}</td></tr>`;}); document.getElementById('percentTable').innerHTML=html;}
    function exportPercentCSV(){const t=document.getElementById('percentTable'); if(!t||!t.rows.length){alert('Calculate first.');return;} const rows=[['Percent','EngUnits']]; for(let i=1;i<t.rows.length;i++){rows.push([t.rows[i].cells[0].innerText,t.rows[i].cells[1].innerText])} downloadCSV('percent_steps.csv',rows);}

    // Signal helper
    function ensureRangeSH(){const l=parseFloat(val('sh_lrv')), u=parseFloat(val('sh_urv')); if(isNaN(l)||isNaN(u)||l===u){alert('Enter valid LRV/URV.');return null;} return {l,u};}
    function maToPercent(){const r=ensureRangeSH(); if(!r) return; const m=parseFloat(val('ma')); if(isNaN(m)){alert('Enter mA.');return;} const p=Math.min(Math.max((m-4)/16*100,0),100); const eu=r.l+(r.u-r.l)*(p/100); setVal('percentInput',fmt(p)); setVal('eu',fmt(eu)); document.getElementById('signalResult').innerText=`${m} mA ‚Üí ${fmt(p)}% ‚Üí ${fmt(eu)} EU`;}
    function percentToMa(){const r=ensureRangeSH(); if(!r) return; const p0=parseFloat(val('percentInput')); if(isNaN(p0)){alert('Enter %.');return;} const p=Math.min(Math.max(p0,0),100); const m=4+16*(p/100); const eu=r.l+(r.u-r.l)*(p/100); setVal('ma',fmt(m)); setVal('eu',fmt(eu)); document.getElementById('signalResult').innerText=`${fmt(p)}% ‚Üí ${fmt(m)} mA ‚Üí ${fmt(eu)} EU`;}
    function euToPercent(){const r=ensureRangeSH(); if(!r) return; const e=parseFloat(val('eu')); if(isNaN(e)){alert('Enter EU.');return;} const p=Math.min(Math.max((e-r.l)/(r.u-r.l)*100,0),100); const m=4+16*(p/100); setVal('percentInput',fmt(p)); setVal('ma',fmt(m)); document.getElementById('signalResult').innerText=`${fmt(e)} EU ‚Üí ${fmt(p)}% ‚Üí ${fmt(m)} mA`;}
    function signalClear(){['sh_lrv','sh_urv','ma','percentInput','eu'].forEach(id=>setVal(id,'')); document.getElementById('signalResult').innerText='';}

    // Unit constants
    const INH2O_PER_PSI=27.679904842545, KPA_PER_PSI=6.894757293168, IN_PER_FT=12, IN_PER_M=39.37007874;

    // Level ‚Äî Open
    function LO_cfg(){
      const span=parseFloat(val('lo_span')); const u=document.getElementById('lo_units').value; const sg=parseFloat(val('lo_sg')||'1'); const dpU=document.getElementById('lo_dpU').value;
      if(isNaN(span)||span<=0||isNaN(sg)||sg<=0){ alert('Enter span and SG'); return null; }
      let spanIn=span; if(u==='ft') spanIn*=IN_PER_FT; if(u==='m') spanIn*=IN_PER_M;
      const urv_inh2o = sg*spanIn;
      let LRV = parseFloat(val('lo_lrv')); if(isNaN(LRV)) LRV=0;
      let URV = parseFloat(val('lo_urv')); if(isNaN(URV)) URV = (dpU==='inh2o')?urv_inh2o:(dpU==='psi'? urv_inh2o/INH2O_PER_PSI : (urv_inh2o/INH2O_PER_PSI)*KPA_PER_PSI );
      return {span, u, spanIn, sg, dpU, LRV, URV};
    }
    function pctToDP(p, LRV, URV){ return LRV + (URV-LRV)*(p/100); }
    function pctToMA(p){ return 4 + 16*(p/100); }
    function maToPct(ma){ return (ma-4)/16*100; }
    function LO_levelToMa(){
      const c=LO_cfg(); if(!c) return; const lvl=parseFloat(val('lo_lvl')); if(isNaN(lvl)){alert('Enter level');return;}
      let lvlIn=lvl; if(c.u==='ft') lvlIn*=IN_PER_FT; if(c.u==='m') lvlIn*=IN_PER_M;
      const pct=Math.min(Math.max((lvlIn/c.spanIn)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct);
      document.getElementById('lo_result').innerText = `Level ${fmt(lvl)} ${c.u} ‚Üí ${fmt(pct)}% ‚Üí ${fmt(dp)} ${c.dpU} ‚Üí ${fmt(ma)} mA`;
    }
    function LO_maToLevel(){
      const c=LO_cfg(); if(!c) return; const ma=parseFloat(val('lo_ma')); if(isNaN(ma)){alert('Enter mA');return;}
      const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV);
      let lvlIn=(pct/100)*c.spanIn; let lvl=lvlIn; if(c.u==='ft') lvl=lvlIn/IN_PER_FT; if(c.u==='m') lvl=lvlIn/IN_PER_M;
      document.getElementById('lo_result').innerText = `${fmt(ma)} mA ‚Üí ${fmt(pct)}% ‚Üí ${fmt(dp)} ${c.dpU} ‚Üí Level ${fmt(lvl)} ${c.u}`;
    }
    function LO_buildSteps(){
      const c=LO_cfg(); if(!c) return; const steps=[0,25,50,75,100]; const tb=document.querySelector('#lo_steps tbody'); tb.innerHTML='';
      steps.forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend', `<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`); });
    }

    // Level ‚Äî Closed
    function LC_inches(valU, u){ if(u==='in') return valU; if(u==='ft') return valU*IN_PER_FT; if(u==='m') return valU*IN_PER_M; return valU; }
    function LC_cfg(){
      const span=parseFloat(val('lc_span')); const u=document.getElementById('lc_units').value;
      const sgL=parseFloat(val('lc_sgL')||'1'); const leg=document.getElementById('lc_leg').value;
      const wetH=parseFloat(val('lc_wetH')||'0'); const sgW=parseFloat(val('lc_sgW')||'1'); const dpU=document.getElementById('lc_dpU').value;
      if(isNaN(span)||span<=0||isNaN(sgL)||sgL<=0){ alert('Enter span and liquid SG'); return null; }
      const span_in = LC_inches(span, u);
      // ŒîP(h) in inH2O
      const dP0_inH2O = (leg==='wet') ? (0 - sgW*(wetH||0)) : 0;
      const dP100_inH2O = (sgL*span_in) - (leg==='wet' ? sgW*(wetH||0) : 0);
      let LRV=parseFloat(val('lc_lrv')); if(isNaN(LRV)) LRV = (dpU==='inh2o')?dP0_inH2O:(dpU==='psi'? dP0_inH2O/INH2O_PER_PSI : (dP0_inH2O/INH2O_PER_PSI)*KPA_PER_PSI);
      let URV=parseFloat(val('lc_urv')); if(isNaN(URV)) URV = (dpU==='inh2o')?dP100_inH2O:(dpU==='psi'? dP100_inH2O/INH2O_PER_PSI : (dP100_inH2O/INH2O_PER_PSI)*KPA_PER_PSI);
      return {span, u, span_in, sgL, leg, wetH, sgW, dpU, LRV, URV};
    }
    function LC_levelToMa(){
      const c=LC_cfg(); if(!c) return; const lvl=parseFloat(val('lc_lvl')); if(isNaN(lvl)){alert('Enter level');return;}
      const lvl_in = LC_inches(lvl, c.u);
      const pct=Math.min(Math.max((lvl_in/c.span_in)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct);
      document.getElementById('lc_result').innerText = `Level ${fmt(lvl)} ${c.u} ‚Üí ${fmt(pct)}% ‚Üí ${fmt(dp)} ${c.dpU} ‚Üí ${fmt(ma)} mA`;
    }
    function LC_maToLevel(){
      const c=LC_cfg(); if(!c) return; const ma=parseFloat(val('lc_ma')); if(isNaN(ma)){alert('Enter mA');return;}
      const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV);
      const lvl_in=(pct/100)*c.span_in; let lvl=lvl_in; if(c.u==='ft') lvl=lvl_in/IN_PER_FT; if(c.u==='m') lvl=lvl_in/IN_PER_M;
      document.getElementById('lc_result').innerText = `${fmt(ma)} mA ‚Üí ${fmt(pct)}% ‚Üí ${fmt(dp)} ${c.dpU} ‚Üí Level ${fmt(lvl)} ${c.u}`;
    }
    function LC_buildSteps(){
      const c=LC_cfg(); if(!c) return; const steps=[0,25,50,75,100]; const tb=document.querySelector('#lc_steps tbody'); tb.innerHTML='';
      steps.forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend', `<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`); });
    }

    // Pressure: gauge ‚Üî absolute
    function psigToPsia(){const a=parseFloat(val('atm')), g=parseFloat(val('psig')); if(isNaN(a)||isNaN(g)){alert('Enter atm and psig');return;} setVal('psia',fmt(a+g));}
    function psiaToPsig(){const a=parseFloat(val('atm')), p=parseFloat(val('psia')); if(isNaN(a)||isNaN(p)){alert('Enter atm and psia');return;} setVal('psig',fmt(p-a));}
    // Unit conv
    function fromPSI(){const p=parseFloat(val('u_psi')); if(isNaN(p)){alert('Enter psi');return;} setVal('u_kpa',fmt(p*KPA_PER_PSI)); setVal('u_bar',fmt(p*0.06894757));}
    function fromKPA(){const k=parseFloat(val('u_kpa')); if(isNaN(k)){alert('Enter kPa');return;} const psi=k/KPA_PER_PSI; setVal('u_psi',fmt(psi)); setVal('u_bar',fmt(psi*0.06894757));}
    function fromBAR(){const b=parseFloat(val('u_bar')); if(isNaN(b)){alert('Enter bar');return;} const psi=b/0.06894757; setVal('u_psi',fmt(psi)); setVal('u_kpa',fmt(psi*KPA_PER_PSI));}
    // Pressure switch
    function calcSwitch(){
      const sp=parseFloat(val('sw_set')); const db=parseFloat(val('sw_db')); const mode=document.getElementById('sw_mode').value;
      if(isNaN(sp)||isNaN(db)||db<0){ alert('Enter setpoint and deadband ‚â• 0'); return; }
      let openOnRise = (mode==='nc'); // NC opens on rise; NO closes on rise
      const risingOn  = openOnRise ? 'opens' : 'closes';
      const fallingOn = openOnRise ? 'closes' : 'opens';
      const high = sp;
      const low  = sp - db;
      const rows = [
        ['Contact', 'Action', 'Pressure'],
        [openOnRise?'NC':'NO', risingOn, fmt(high)+' psig'],
        [openOnRise?'NC':'NO', fallingOn, fmt(low)+' psig'],
      ];
      const tb=document.querySelector('#sw_out tbody'); tb.innerHTML='';
      rows.forEach((r,i)=>{ tb.insertAdjacentHTML('beforeend', `<tr>${r.map((c,j)=>`<${i? 'td':'th'}>${c}</${i? 'td':'th'}>`).join('')}</tr>`); });
    }
    // Vacuum helpers
    function fromInHg(){
      const inhg=parseFloat(val('vac_inhg')); const atmPsia=parseFloat(val('atm')); if(isNaN(inhg)||isNaN(atmPsia)){alert('Enter inHg and atm psia');return;}
      const psia = atmPsia - (inhg * atmPsia / 29.92);
      const psig = psia - atmPsia;
      setVal('vac_psia',fmt(psia)); setVal('vac_psig',fmt(psig));
    }
    function fromPSIA(){
      const psia=parseFloat(val('vac_psia')); const atmPsia=parseFloat(val('atm')); if(isNaN(psia)||isNaN(atmPsia)){alert('Enter psia and atm');return;}
      const inhg = (atmPsia-psia) * (29.92/atmPsia);
      const psig = psia - atmPsia;
      setVal('vac_inhg',fmt(inhg)); setVal('vac_psig',fmt(psig));
    }
    function fromPSIG(){
      const psig=parseFloat(val('vac_psig')); const atmPsia=parseFloat(val('atm')); if(isNaN(psig)||isNaN(atmPsia)){alert('Enter psig and atm');return;}
      const psia = psig + atmPsia;
      const inhg = (atmPsia-psia) * (29.92/atmPsia);
      setVal('vac_psia',fmt(psia)); setVal('vac_inhg',fmt(inhg));
    }

    // Calibration
    const CAL_KEY='pocketech.calibrations.v1'; const calTBody=document.querySelector('#cal_table tbody');
    function addMonths(d, m){ if(!d||!m) return ''; const x=new Date(d); if(isNaN(x)) return ''; x.setMonth(x.getMonth()+Number(m)); return x.toISOString().slice(0,10); }
    document.getElementById('cal_date').addEventListener('change',()=>setVal('cal_due',addMonths(val('cal_date'),val('cal_interval'))||'')); document.getElementById('cal_interval').addEventListener('change',()=>setVal('cal_due',addMonths(val('cal_date'),val('cal_interval'))||''));
    function loadCals(){ try{return JSON.parse(localStorage.getItem(CAL_KEY)||'[]');}catch{return [];} }
    function saveCals(r){ localStorage.setItem(CAL_KEY,JSON.stringify(r)); }
    function renderCals(){ const r=loadCals(); calTBody.innerHTML=''; r.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.tag||''}</td><td>${x.model||''}</td><td>${x.ctype||''}</td><td>${x.lrv??''}</td><td>${x.urv??''}</td><td>${x.method||''}</td><td>${x.af||''}</td><td>${x.al||''}</td><td>${x.date||''}</td><td>${x.interval||''}</td><td>${x.due||''}</td><td>${x.tech||''}</td><td>${x.notes||''}</td>`; calTBody.appendChild(tr); }); }
    document.getElementById('cal_add').addEventListener('click',()=>{ const row={tag:val('cal_tag').trim(),model:val('cal_model').trim(),ctype:val('cal_type').trim(),lrv:val('cal_lrv'),urv:val('cal_urv'),method:val('cal_method').trim(),af:val('cal_af').trim(),al:val('cal_al').trim(),date:val('cal_date'),interval:val('cal_interval'),due:val('cal_due'),tech:val('cal_tech').trim(),notes:val('cal_notes').trim()}; if(!row.tag){alert('Tag required');return;} const r=loadCals(); r.push(row); saveCals(r); renderCals(); ['cal_tag','cal_model','cal_type','cal_lrv','cal_urv','cal_method','cal_af','cal_al','cal_notes'].forEach(id=>setVal(id,'')); });
    document.getElementById('cal_export').addEventListener('click',()=>{ const r=loadCals(); if(!r.length){alert('Nothing to export.');return;} const header=['Tag','Make/Model','Type','LRV','URV','Method','As-Found','As-Left','Date','Interval(months)','Next Due','Tech','Notes']; const rows=[header,...r.map(x=>[x.tag,x.model,x.ctype,x.lrv,x.urv,x.method,x.af,x.al,x.date,x.interval,x.due,x.tech,x.notes])]; downloadCSV('calibration_tracker.csv',rows); });
    document.getElementById('cal_clear').addEventListener('click',()=>{ if(confirm('Clear ALL local calibration records?')){ saveCals([]); renderCals(); } });
    document.getElementById('cal_tpl').addEventListener('click',()=>{ const header=['Tag','Make/Model','Type','LRV','URV','Method','As-Found','As-Left','Date','Interval(months)','Next Due','Tech','Notes']; downloadCSV('calibration_tracker_template.csv',[header]); });
    document.getElementById('cal_import_btn').addEventListener('click',()=>document.getElementById('cal_import').click());
    document.getElementById('cal_import').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const rows=parseCSV(r.result); if(!rows.length){alert('Empty CSV');return;} const idx=indexHeaders(rows[0]); const need={tag:['tag'],model:['make/model','make','model','make model'],ctype:['type'],lrv:['lrv'],urv:['urv'],method:['method'],af:['as-found','as found'],al:['as-left','as left'],date:['date'],interval:['interval','interval(months)','interval months'],due:['next due','next_due','nextdue','due'],tech:['tech','technician'],notes:['notes','note']}; function pick(a){const g=ks=>{for(const k of ks){const i=idx[k]; if(i!=null) return a[i];} return ''}; return {tag:g(need.tag),model:g(need.model),ctype:g(need.ctype),lrv:g(need.lrv),urv:g(need.urv),method:g(need.method),af:g(need.af),al:g(need.al),date:g(need.date),interval:g(need.interval),due:g(need.due),tech:g(need.tech),notes:g(need.notes)} } const incoming=rows.slice(1).filter(r=>r.some(x=>String(x).trim()!=='')).map(pick); const cur=loadCals(); saveCals(cur.concat(incoming)); renderCals(); alert(`Imported ${incoming.length} calibration rows.`); e.target.value=''; }; r.readAsText(f); });

    // Loop Log
    const LOOP_KEY='pocketech.looplog.v1'; let loopData=JSON.parse(localStorage.getItem(LOOP_KEY)||'[]'); const loopTBody=document.querySelector('#loopTable tbody');
    function renderLoopTable(filterTag){ loopTBody.innerHTML=''; (loopData||[]).filter(r=>!filterTag||String(r.tag||'').toLowerCase().includes(filterTag.toLowerCase())).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.service||''}</td><td>${r.type||''}</td><td>${r.lrv??''}</td><td>${r.urv??''}</td><td>${r.asFound||''}</td><td>${r.asLeft||''}</td><td>${r.tech||''}</td><td>${r.status||''}</td><td>${r.notes||''}</td>`; loopTBody.appendChild(tr); }); }
    document.getElementById('loopForm').addEventListener('submit',e=>{ e.preventDefault(); const row={ date:val('date')||new Date().toISOString().slice(0,10), tag:val('tag').trim(), service:val('service').trim(), type:val('type'), lrv:val('rangeLrv'), urv:val('rangeUrv'), asFound:val('asFound').trim(), asLeft:val('asLeft').trim(), tech:val('tech').trim(), notes:val('notes').trim(), status:val('status') }; if(!row.tag){alert('Tag is required');return;} loopData.push(row); localStorage.setItem(LOOP_KEY,JSON.stringify(loopData)); renderLoopTable(); e.target.reset(); });
    function applyLoopFilter(){ const t=val('loop_filter_tag').trim(); renderLoopTable(t||undefined); }
    function downloadLoopCSV(){ const header=['Date','Tag','Service','Type','LRV','URV','As-Found','As-Left','Tech','Status','Notes']; const rows=[header,...loopData.map(r=>[r.date,r.tag,r.service,r.type,r.lrv,r.urv,r.asFound,r.asLeft,r.tech,r.status,r.notes])]; downloadCSV('loop_check_log.csv',rows); }
    function clearLoop(){ if(confirm('Clear ALL local loop entries?')){ loopData=[]; localStorage.setItem(LOOP_KEY,'[]'); renderLoopTable(); } }
    document.getElementById('loop_tpl').addEventListener('click',()=>{ const header=['Date','Tag','Service','Type','LRV','URV','As-Found','As-Left','Tech','Status','Notes']; downloadCSV('loop_check_log_template.csv',[header]); });
    document.getElementById('loop_import_btn').addEventListener('click',()=>document.getElementById('loop_import').click());
    document.getElementById('loop_import').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const rows=parseCSV(r.result); if(!rows.length){alert('Empty CSV');return;} const idx=indexHeaders(rows[0]); const need={date:['date'],tag:['tag'],service:['service'],type:['type'],lrv:['lrv'],urv:['urv'],asFound:['as-found','as found'],asLeft:['as-left','as left'],tech:['tech','technician'],status:['status'],notes:['notes','note']}; function pick(a){const g=ks=>{for(const k of ks){const i=idx[k]; if(i!=null) return a[i];} return ''}; return {date:g(need.date),tag:g(need.tag),service:g(need.service),type:g(need.type),lrv:g(need.lrv),urv:g(need.urv),asFound:g(need.asFound),asLeft:g(need.asLeft),tech:g(need.tech),status:g(need.status),notes:g(need.notes)} } const incoming=rows.slice(1).filter(r=>r.some(x=>String(x).trim()!=='')).map(pick); loopData=loopData.concat(incoming); localStorage.setItem(LOOP_KEY,JSON.stringify(loopData)); renderLoopTable(); alert(`Imported ${incoming.length} loop rows.`); e.target.value=''; }; r.readAsText(f); });

    // Tickets
    const TICKET_KEY='pocketech.tickets.v1'; const tBody=document.querySelector('#t_table tbody');
    function loadTickets(){ try{return JSON.parse(localStorage.getItem(TICKET_KEY)||'[]');}catch{return [];} }
    function saveTickets(r){ localStorage.setItem(TICKET_KEY,JSON.stringify(r)); }
    function renderTickets(){ const r=loadTickets(); tBody.innerHTML=''; r.forEach((x,i)=>{ const tr=document.createElement('tr'); const pill=x.status==='Open'?'open':(x.status==='Blocked'?'blocked':'done'); const thumbs=(x.photos||[]).map(s=>`<img src="${s}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`).join(''); tr.innerHTML=`<td>${x.title||''}</td><td>${x.system||''}</td><td>${x.sev||''}</td><td><span class="pill ${pill}">${x.status||''}</span></td><td>${x.assignee||''}</td><td>${x.date||''}</td><td>${(x.notes||'').replace(/,/g,';')}</td><td>${thumbs}</td><td><button class="btn" data-i="${i}" data-act="toggle">Toggle Done</button> <button class="btn danger" data-i="${i}" data-act="del">Delete</button></td>`; tBody.appendChild(tr); }); }
    document.getElementById('t_add').addEventListener('click',async()=>{ const files=[...(document.getElementById('t_photos').files||[])].slice(0,3); const photos=[]; for(const f of files){ photos.push(await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(f); })); } const row={ title:val('t_title'), system:val('t_system'), sev:val('t_sev'), status:val('t_status'), assignee:val('t_assignee'), date:val('t_date'), notes:val('t_notes'), photos }; if(!row.title){alert('Title required');return;} const r=loadTickets(); r.push(row); saveTickets(r); renderTickets(); ['t_title','t_system','t_notes','t_assignee','t_date'].forEach(id=>setVal(id,'')); document.getElementById('t_photos').value=''; });
    tBody.addEventListener('click',e=>{ const b=e.target.closest('button'); if(!b) return; const i=+b.dataset.i; const act=b.dataset.act; const r=loadTickets(); if(!r[i])return; if(act==='del'){ r.splice(i,1); } else if(act==='toggle'){ r[i].status = r[i].status==='Done' ? 'Open' : 'Done'; } saveTickets(r); renderTickets(); });
    document.getElementById('t_export').addEventListener('click',()=>{ const r=loadTickets(); if(!r.length){alert('Nothing to export.');return;} const header=['Title','System/Tag','Severity','Status','Assignee','Date','Notes','PhotoCount']; const data=r.map(x=>[x.title,x.system,x.sev,x.status,x.assignee,x.date,(x.notes||'').replace(/[\r\n,]/g,' '),(x.photos||[]).length]); downloadCSV('tickets.csv',[... [header], ...data]); });
    document.getElementById('t_clear').addEventListener('click',()=>{ if(confirm('Clear ALL local tickets?')){ saveTickets([]); renderTickets(); } });

    // QR scan
    const qrVideo=document.getElementById('qr_video'); const qrLiveBtn=document.getElementById('qr_live_btn'); const qrPhotoBtn=document.getElementById('qr_photo_btn'); const qrPhotoInp=document.getElementById('qr_photo'); const qrResult=document.getElementById('qr_result'); let mediaStream=null, detector=null, scanTimer=null;
    async function initBarcode(){ if('BarcodeDetector' in window){ try{ detector=new BarcodeDetector({formats:['qr_code']}); return true;}catch{ return false; } } return false; }
    function stopLive(){ if(scanTimer){clearInterval(scanTimer); scanTimer=null;} if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null;} qrVideo.classList.add('hidden'); }
    function handleQRText(text){ qrResult.textContent='Scanned: '+text; let tag=null; try{ const u=new URL(text); tag=u.searchParams.get('tag')||u.hash.replace(/^#tag=/,'')||null; }catch{} if(!tag){ tag=text.trim(); } if(tag){ setVal('loop_filter_tag',tag); document.querySelector('nav button[data-target="loop"]').click(); applyLoopFilter(); alert('Applied tag filter: '+tag); } }
    qrLiveBtn.addEventListener('click',async()=>{ stopLive(); const has=await initBarcode(); if(!has){alert('Live scan not supported here. Use "Scan from Photo".');return;} try{ mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); qrVideo.srcObject=mediaStream; qrVideo.classList.remove('hidden'); const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); scanTimer=setInterval(async()=>{ if(!qrVideo.videoWidth) return; canvas.width=qrVideo.videoWidth; canvas.height=qrVideo.videoHeight; ctx.drawImage(qrVideo,0,0); const bmp=await createImageBitmap(canvas); const codes=await detector.detect(bmp); if(codes&&codes.length){ stopLive(); handleQRText(codes[0].rawValue); } }, 600); }catch(err){ alert('Camera access failed. Try "Scan from Photo".'); } });
    qrPhotoBtn.addEventListener('click',()=>qrPhotoInp.click());
    qrPhotoInp.addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; const has=await initBarcode(); if(!has){alert('QR detection not supported here. Try Chrome.'); return;} const img=await createImageBitmap(f); const codes=await detector.detect(img); if(codes&&codes.length){ handleQRText(codes[0].rawValue); } else { alert('No QR found in image.'); } e.target.value=''; });

    // Backup
    const ALL_KEYS=['pocketech.calibrations.v1','pocketech.looplog.v1','pocketech.tickets.v1'];
    document.getElementById('bk_export').addEventListener('click',()=>{ const payload={}; ALL_KEYS.forEach(k=>payload[k]=localStorage.getItem(k)||'[]'); const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pocketech_backup.json'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('bk_import_btn').addEventListener('click',()=>document.getElementById('bk_import').click());
    document.getElementById('bk_import').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); let n=0; ALL_KEYS.forEach(k=>{ if(data[k]){ localStorage.setItem(k,data[k]); n++; }}); renderCals(); renderLoopTable(); renderTickets(); alert('Restore complete. Keys restored: '+n); }catch{ alert('Invalid JSON backup.'); } e.target.value=''; }; r.readAsText(f); });
    document.getElementById('bk_clear').addEventListener('click',()=>{ if(!confirm('Clear ALL local data (Cal + Loop + Tickets)?')) return; ALL_KEYS.forEach(k=>localStorage.removeItem(k)); renderCals(); renderLoopTable(); renderTickets(); alert('All local data cleared.'); });

    // Init
    wireNumpad();
    renderCals(); renderLoopTable(); renderTickets();
  </script>
</body>
</html>
