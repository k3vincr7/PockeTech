<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PockeTech — Field Tools</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> <!-- optional if you add icons -->

  <style>
    :root{
      --bg:#f5f5f5; --fg:#222; --muted:#777; --card:#fff; --border:#d0d0d0;
      --accent:#3a7afe; --btn:#444; --btn-fg:#fff;
    }
    @media (prefers-color-scheme: dark) {
      :root{ --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0; --card:#151922; --border:#2a2f3a; --btn:#2b3240; --btn-fg:#e8e8e8; }
    }
    [data-theme="light"]{ --bg:#f5f5f5; --fg:#222; --muted:#777; --card:#fff; --border:#d0d0d0; --btn:#444; --btn-fg:#fff; }
    [data-theme="dark"]{ --bg:#0f1115; --fg:#e8e8e8; --muted:#a0a0a0; --card:#151922; --border:#2a2f3a; --btn:#2b3240; --btn-fg:#e8e8e8; }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--fg); }
    header{ background:var(--card); padding:12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    header h1{ margin:0; font-size:18px; }
    .toggle{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:var(--card); cursor:pointer; }

    nav{ display:flex; flex-wrap:wrap; gap:6px; padding:10px; border-bottom:1px solid var(--border); background:var(--card); position:sticky; top:0; z-index:5; }
    nav button{ background:var(--btn); color:var(--btn-fg); border:none; padding:14px 16px; border-radius:10px; cursor:pointer; font-size:15px; }
    nav button.active{ outline:2px solid var(--accent); }

    main{ padding:12px; max-width:1100px; margin:0 auto; }
    section{ display:none; background:var(--card); padding:12px; border:1px solid var(--border); border-radius:10px; }
    section.active{ display:block; }

    input,select,button,textarea{ padding:.65em .75em; font-size:16px; border-radius:8px; }
    input,select,textarea{ width:100%; border:1px solid var(--border); background:transparent; color:var(--fg); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1 1 240px; min-width:240px; }
    .btn{ background:var(--btn); color:var(--btn-fg); border:1px solid var(--border); cursor:pointer; }
    .ok{ background:#166534; border-color:#166534; }
    .danger{ background:#8b1e1e; border-color:#8b1e1e; }
    .muted{ color:var(--muted); font-size:12px; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
    th,td{ border:1px solid var(--border); padding:8px; text-align:left; }
    th{ background:rgba(128,128,128,.08); }
    footer{ text-align:center; color:var(--muted); font-size:12px; padding:12px; }
    .hidden{ display:none; }
    .pill{ padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .big{font-size:28px;font-weight:600}

    /* Number pad */
    .numpad { position: fixed; left: 0; right: 0; bottom: 0; background: var(--card); border-top: 1px solid var(--border); display: none; padding: 8px; z-index: 50; box-shadow: 0 -6px 20px rgba(0,0,0,.25); }
    .numpad.show { display: block; }
    .numpad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 520px; margin: 0 auto; }
    .np-btn { padding: 16px; font-size: 18px; border-radius: 10px; border:1px solid var(--border); background: var(--btn); color: var(--btn-fg); text-align: center; user-select: none; }
    .np-wide { grid-column: span 2; }

    .rowline{display:flex;align-items:center;gap:8px}
    .copy{cursor:pointer;border:1px dashed var(--border);padding:4px 8px;border-radius:8px;font-size:12px;color:var(--muted)}
    .copy:hover{border-color:var(--accent)}
    input[type="range"]{width:100%}
    .steps button{padding:.55em .7em;border-radius:999px;margin-right:6px}
    .kbd-toggle{margin-top:6px;font-size:12px;border:1px dashed var(--border);background:transparent;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>PockeTech — Field Tools</h1>
    <div class="row" style="gap:6px">
      <button id="installBtn" class="toggle" title="Install app">⬇️ Install</button>
      <button id="themeToggle" class="toggle" title="Toggle dark/light">🌓 Theme</button>
    </div>
  </header>

  <nav>
  <button data-target="percent" class="active">🧮 Percent</button>
  <button data-target="signal">📈 Signal</button>
  <button data-target="level_open">🫙 Level — Open</button>
  <button data-target="level_closed">🔒 Level — Closed</button>
  <button data-target="pressure">⛽ Pressure</button>
  <button data-target="temp">🌡️ Temp</button>
  <button data-target="ip">🎛️ I/P 3–15</button>
  <button data-target="cal">📝 Calibration</button>
  <button data-target="loop">🔄 Loop Log</button>
  <button data-target="tickets">🎫 Tickets</button>
  <button data-target="qr">📷 QR Scan</button>
  <button data-target="backup">💾 Backup</button>
  <button data-target="settings">⚙️ Settings</button>
</nav>

  <main>
    <!-- Percent Steps -->
    <section id="percent" class="active">
      <h2>Percent Steps</h2>
      <div class="row">
        <div class="col"><label>LRV <input id="lrv" class="num" inputmode="decimal" placeholder="0"></label><button class="kbd-toggle" data-for="lrv">kbd</button></div>
        <div class="col"><label>URV <input id="urv" class="num" inputmode="decimal" placeholder="200"></label><button class="kbd-toggle" data-for="urv">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" onclick="calcPercent()">Calculate</button></div>
        <div class="col"><button class="btn" onclick="exportPercentCSV()">Export CSV</button></div>
      </div>
      <table id="percentTable"></table>
      <p class="muted">Outputs 0, 25, 50, 75, 100% of your range.</p>
    </section>

    <!-- Signal Helper (Pro) -->
    <section id="signal">
      <h2>4–20 mA Helper (Pro)</h2>
      <div class="row">
        <div class="col"><label>LRV (EU) <input id="sh_lrv" class="num" inputmode="decimal" placeholder="0"></label><button class="kbd-toggle" data-for="sh_lrv">kbd</button></div>
        <div class="col"><label>URV (EU) <input id="sh_urv" class="num" inputmode="decimal" placeholder="200"></label><button class="kbd-toggle" data-for="sh_urv">kbd</button></div>
        <div class="col"><label>EU Label (optional) <input id="sh_eulbl" placeholder="e.g., gpm, °F, psi"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>mA <input id="sh_ma" class="num" inputmode="decimal" placeholder="12"></label><button class="kbd-toggle" data-for="sh_ma">kbd</button></div>
        <div class="col"><label>% <input id="sh_pct" class="num" inputmode="decimal" placeholder="50"></label><button class="kbd-toggle" data-for="sh_pct">kbd</button></div>
        <div class="col"><label>EU <input id="sh_eu" class="num" inputmode="decimal" placeholder="100"></label><button class="kbd-toggle" data-for="sh_eu">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" id="sh_from_ma">From mA</button></div>
        <div class="col"><button class="btn" id="sh_from_pct">From %</button></div>
        <div class="col"><button class="btn" id="sh_from_eu">From EU</button></div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card"><div class="rowline"><div class="big" id="read_ma">—</div><span class="copy" data-copy="#read_ma">copy</span></div><div class="muted">mA</div></div>
        <div class="card">
          <div class="rowline"><div class="big" id="read_pct">—</div><span class="copy" data-copy="#read_pct">copy</span></div>
          <div class="muted">Percent</div>
          <div class="steps" style="margin-top:8px">
            <button class="btn step" data-p="0">0%</button><button class="btn step" data-p="25">25%</button>
            <button class="btn step" data-p="50">50%</button><button class="btn step" data-p="75">75%</button><button class="btn step" data-p="100">100%</button>
          </div>
        </div>
        <div class="card">
          <div class="rowline"><div class="big" id="read_eu">—</div><span class="copy" data-copy="#read_eu">copy</span></div>
          <div class="muted">Eng Units</div>
          <label class="rowline" style="margin-top:8px"><input type="checkbox" id="sqrt_mode"> square-root (flow)</label>
        </div>
      </div>
      <div class="row" style="margin-top:10px"><div class="col"><input id="pct_slider" type="range" min="0" max="100" step="0.1" value="50"></div></div>
      <p class="muted" id="sh_hint">Tip: slider drives % ⇄ mA ⇄ EU live.</p>
    </section>

    <!-- Level — Open -->
    <section id="level_open">
      <h2>Level — Open Tank (tap-to-tap)</h2>
      <div class="row">
        <div class="col"><label>Tap-to-tap span <input id="lo_span" class="num" inputmode="decimal" placeholder="e.g., 72"></label><button class="kbd-toggle" data-for="lo_span">kbd</button></div>
        <div class="col"><label>Units <select id="lo_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
        <div class="col"><label>Specific Gravity (SG) <input id="lo_sg" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lo_sg">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><label>dP Units <select id="lo_dpU"><option value="inh2o">inH₂O</option><option value="psi">psi</option><option value="kpa">kPa</option></select></label></div>
        <div class="col"><label>LRV (optional) <input id="lo_lrv" class="num" inputmode="decimal" placeholder="blank = 0"></label><button class="kbd-toggle" data-for="lo_lrv">kbd</button></div>
        <div class="col"><label>URV (optional) <input id="lo_urv" class="num" inputmode="decimal" placeholder="blank = auto"></label><button class="kbd-toggle" data-for="lo_urv">kbd</button></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col"><label>Level <input id="lo_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label><button class="kbd-toggle" data-for="lo_lvl">kbd</button></div>
        <div class="col"><button class="btn" onclick="LO_levelToMa()">Level → mA</button></div>
        <div class="col"><label>mA <input id="lo_ma" class="num" inputmode="decimal" placeholder="e.g., 12"></label><button class="kbd-toggle" data-for="lo_ma">kbd</button></div>
        <div class="col"><button class="btn" onclick="LO_maToLevel()">mA → Level</button></div>
      </div>
      <p id="lo_result" class="muted"></p>
      <div class="row"><div class="col"><button class="btn" onclick="LO_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
      <table id="lo_steps"><thead><tr><th>%</th><th>Level (span units)</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
      <p class="muted">Open tank: ΔP = ρ g h ⇒ inH₂O@100% ≈ SG × span(in).</p>
    </section>

    <!-- Level — Closed -->
    <section id="level_closed">
      <h2>Level — Closed Tank (tap-to-tap)</h2>
      <div class="row">
        <div class="col"><label>Tap-to-tap span <input id="lc_span" class="num" inputmode="decimal" placeholder="e.g., 72"></label><button class="kbd-toggle" data-for="lc_span">kbd</button></div>
        <div class="col"><label>Units <select id="lc_units"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
        <div class="col"><label>Liquid SG <input id="lc_sgL" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lc_sgL">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><label>Leg Type <select id="lc_leg"><option value="dry">Dry leg (gas)</option><option value="wet">Wet leg (condensing)</option></select></label></div>
        <div class="col"><label>Wet leg height (in) <input id="lc_wetH" class="num" inputmode="decimal" placeholder="if wet"></label><button class="kbd-toggle" data-for="lc_wetH">kbd</button></div>
        <div class="col"><label>Wet leg SG <input id="lc_sgW" class="num" inputmode="decimal" value="1.0"></label><button class="kbd-toggle" data-for="lc_sgW">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><label>dP Units <select id="lc_dpU"><option value="inh2o">inH₂O</option><option value="psi">psi</option><option value="kpa">kPa</option></select></label></div>
        <div class="col"><label>LRV (optional) <input id="lc_lrv" class="num" inputmode="decimal" placeholder="auto"></label><button class="kbd-toggle" data-for="lc_lrv">kbd</button></div>
        <div class="col"><label>URV (optional) <input id="lc_urv" class="num" inputmode="decimal" placeholder="auto"></label><button class="kbd-toggle" data-for="lc_urv">kbd</button></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col"><label>Level <input id="lc_lvl" class="num" inputmode="decimal" placeholder="same units as span"></label><button class="kbd-toggle" data-for="lc_lvl">kbd</button></div>
        <div class="col"><button class="btn" onclick="LC_levelToMa()">Level → mA</button></div>
        <div class="col"><label>mA <input id="lc_ma" class="num" inputmode="decimal" placeholder="e.g., 12"></label><button class="kbd-toggle" data-for="lc_ma">kbd</button></div>
        <div class="col"><button class="btn" onclick="LC_maToLevel()">mA → Level</button></div>
      </div>
      <p id="lc_result" class="muted"></p>
      <div class="row"><div class="col"><button class="btn" onclick="LC_buildSteps()">Build 0/25/50/75/100 Table</button></div></div>
      <table id="lc_steps"><thead><tr><th>%</th><th>Level (span units)</th><th>dP</th><th>mA</th></tr></thead><tbody></tbody></table>
      <p class="muted">Dry leg: ΔP = ρ_l g h. Wet leg: ΔP = ρ_l g h − ρ_w g H_w (offset).</p>
    </section>

    <!-- Pressure -->
    <section id="pressure">
      <h2>Pressure</h2>

      <h3>Quick Convert — “This → That”</h3>
      <div class="row">
        <div class="col">
          <label>Value <input id="pc_val_in" class="num" inputmode="decimal" placeholder="e.g., 15"></label>
          <button class="kbd-toggle" data-for="pc_val_in">kbd</button>
        </div>
        <div class="col">
          <label>From
            <select id="pc_unit_in">
              <option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option>
              <option value="pa">Pa</option><option value="mpa">MPa</option>
              <option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option>
              <option value="inhg">inHg</option><option value="mmhg">mmHg</option>
            </select>
          </label>
        </div>
        <div class="col">
          <label>To
            <select id="pc_unit_out">
              <option value="kpa">kPa</option><option value="psi">psi</option><option value="bar">bar</option>
              <option value="pa">Pa</option><option value="mpa">MPa</option>
              <option value="inh2o">inH₂O</option><option value="mmh2o">mmH₂O</option>
              <option value="inhg">inHg</option><option value="mmhg">mmHg</option>
            </select>
          </label>
        </div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" id="pc_convert">Convert</button></div>
        <div class="col"><button class="btn" id="pc_swap">Swap</button></div>
        <div class="col"><label>Result <input id="pc_val_out" readonly placeholder="—"></label></div>
      </div>
      <p class="muted">inH₂O/mmH₂O@4 °C; inHg/mmHg@0 °C (field-standard tables).</p>

      <div class="hr"></div>
      <h3>Gauge ↔ Absolute</h3>
      <div class="row">
        <div class="col"><label>Atmospheric (psia) <input id="atm" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="atm">kbd</button></div>
        <div class="col"><label>Gauge (psig) <input id="psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psig">kbd</button></div>
        <div class="col"><label>Absolute (psia) <input id="psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="psia">kbd</button></div>
      </div>
      <div class="row"><div class="col"><button class="btn" onclick="psigToPsia()">psig → psia</button></div><div class="col"><button class="btn" onclick="psiaToPsig()">psia → psig</button></div></div>

      <div class="hr"></div>
      <h3>psi ↔ kPa ↔ bar</h3>
      <div class="row">
        <div class="col"><label>psi <input id="u_psi" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_psi">kbd</button></div>
        <div class="col"><label>kPa <input id="u_kpa" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_kpa">kbd</button></div>
        <div class="col"><label>bar <input id="u_bar" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="u_bar">kbd</button></div>
      </div>
      <div class="row"><div class="col"><button class="btn" onclick="fromPSI()">From psi</button></div><div class="col"><button class="btn" onclick="fromKPA()">From kPa</button></div><div class="col"><button class="btn" onclick="fromBAR()">From bar</button></div></div>

      <div class="hr"></div>
      <h3>Pressure Switch</h3>
      <div class="row">
        <div class="col"><label>Setpoint (rising, psig) <input id="sw_set" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_set">kbd</button></div>
        <div class="col"><label>Deadband (psig) <input id="sw_db" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="sw_db">kbd</button></div>
        <div class="col"><label>Mode <select id="sw_mode"><option value="nc">NC (opens on rise)</option><option value="no">NO (closes on rise)</option></select></label></div>
      </div>
      <div class="row"><div class="col"><button class="btn" onclick="calcSwitch()">Calculate</button></div></div>
      <table id="sw_out"><tbody></tbody></table>

      <div class="hr"></div>
      <h3>Vacuum helpers</h3>
      <div class="row">
        <div class="col"><label>Vacuum (inHg) <input id="vac_inhg" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_inhg">kbd</button></div>
        <div class="col"><label>psia <input id="vac_psia" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psia">kbd</button></div>
        <div class="col"><label>psig <input id="vac_psig" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="vac_psig">kbd</button></div>
      </div>
      <div class="row"><div class="col"><button class="btn" onclick="fromInHg()">From inHg</button></div><div class="col"><button class="btn" onclick="fromPSIA()">From psia</button></div><div class="col"><button class="btn" onclick="fromPSIG()">From psig</button></div></div>
      <p class="muted">Assumes 29.92 inHg at 14.7 psia (sea level standard).</p>
    </section>

    <!-- Temp Converter -->
    <section id="temp">
      <h2>Temperature</h2>
      <h3>Convert — “This → That”</h3>
      <div class="row">
        <div class="col">
          <label>Value <input id="tc_val" class="num" inputmode="decimal" placeholder="e.g., 68"></label>
          <button class="kbd-toggle" data-for="tc_val">kbd</button>
        </div>
        <div class="col">
          <label>From <select id="tc_from"><option value="F">°F</option><option value="C">°C</option><option value="K">K</option></select></label>
        </div>
        <div class="col">
          <label>To <select id="tc_to"><option value="C">°C</option><option value="F">°F</option><option value="K">K</option></select></label>
        </div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" id="tc_conv_btn">Convert</button></div>
        <div class="col"><label>Result <input id="tc_out" readonly placeholder="—"></label></div>
      </div>

      <div class="hr"></div>
      <h3>Delta T</h3>
      <div class="row">
        <div class="col">
          <label>ΔValue <input id="td_val" class="num" inputmode="decimal" placeholder="e.g., 10"></label>
          <button class="kbd-toggle" data-for="td_val">kbd</button>
        </div>
        <div class="col"><label>From <select id="td_from"><option value="F">Δ°F</option><option value="C">Δ°C</option><option value="K">ΔK</option></select></label></div>
        <div class="col"><label>To <select id="td_to"><option value="C">Δ°C</option><option value="F">Δ°F</option><option value="K">ΔK</option></select></label></div>
      </div>
      <div class="row"><div class="col"><button class="btn" id="td_conv_btn">Convert Δ</button></div><div class="col"><label>Result <input id="td_out" readonly placeholder="—"></label></div></div>
      <p class="muted">Δ°F = Δ°C × 9/5. ΔK = Δ°C.</p>
    </section>

    <!-- I/P 3–15 psi Helper -->
    <section id="ip">
      <h2>I/P 3–15 psi Helper</h2>
      <div class="row">
        <div class="col"><label>% <input id="ip_pct" class="num" inputmode="decimal" placeholder="50"></label><button class="kbd-toggle" data-for="ip_pct">kbd</button></div>
        <div class="col"><label>psi <input id="ip_psi" class="num" inputmode="decimal" placeholder="9"></label><button class="kbd-toggle" data-for="ip_psi">kbd</button></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn" id="ip_from_pct">From %</button></div>
        <div class="col"><button class="btn" id="ip_from_psi">From psi</button></div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card">
          <div class="rowline"><div class="big" id="ip_read_pct">—</div><span class="copy" data-copy="#ip_read_pct">copy</span></div>
          <div class="muted">Percent</div>
          <div class="steps" style="margin-top:8px">
            <button class="btn ipstep" data-p="0">0%</button><button class="btn ipstep" data-p="25">25%</button>
            <button class="btn ipstep" data-p="50">50%</button><button class="btn ipstep" data-p="75">75%</button><button class="btn ipstep" data-p="100">100%</button>
          </div>
        </div>
        <div class="card"><div class="rowline"><div class="big" id="ip_read_psi">—</div><span class="copy" data-copy="#ip_read_psi">copy</span></div><div class="muted">psi (3–15)</div></div>
      </div>
      <p class="muted">Linear: psi = 3 + 12×(%/100). % = (psi−3)/12×100.</p>
    </section>

    <!-- Calibration -->
    <section id="cal">
      <h2>Calibration Tracker</h2>
      <div class="row">
        <div class="col"><label>Tag <input id="cal_tag" placeholder="PT-101"></label></div>
        <div class="col"><label>Make/Model <input id="cal_model" placeholder="Yokogawa EJA"></label></div>
        <div class="col"><label>Type <input id="cal_type" placeholder="PT/FT/LT/TT"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>LRV <input id="cal_lrv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_lrv">kbd</button></div>
        <div class="col"><label>URV <input id="cal_urv" class="num" inputmode="decimal"></label><button class="kbd-toggle" data-for="cal_urv">kbd</button></div>
        <div class="col"><label>Method <input id="cal_method" placeholder="5-point, AF/AL"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>As-Found <input id="cal_af" placeholder="0.12%"></label></div>
        <div class="col"><label>As-Left <input id="cal_al" placeholder="0.05%"></label></div>
        <div class="col"><label>Date <input id="cal_date" type="date"></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Interval <select id="cal_interval"><option value="">Select</option><option value="6">6 months</option><option value="12">12 months</option></select></label></div>
        <div class="col"><label>Next Due <input id="cal_due" readonly placeholder="auto"></label></div>
        <div class="col"><label>Tech <input id="cal_tech" placeholder="K. Calvillo"></label></div>
      </div>
      <div class="row"><div class="col" style="flex:1 1 100%"><label>Notes <input id="cal_notes" placeholder="…"></label></div></div>
      <div class="row">
        <div class="col"><button class="btn" id="cal_add">Add</button></div>
        <div class="col"><button class="btn" id="cal_export">Export CSV</button></div>
        <div class="col"><button class="btn" id="cal_tpl">CSV Template</button></div>
        <div class="col"><button class="btn" id="cal_import_btn" type="button">Import CSV</button><input id="cal_import" type="file" accept=".csv" class="hidden"></div>
        <div class="col"><button class="btn danger" id="cal_clear">Clear All (local)</button></div>
      </div>
      <div class="hr"></div>
      <table id="cal_table"><thead><tr><th>Tag</th><th>Make/Model</th><th>Type</th><th>LRV</th><th>URV</th><th>Method</th><th>As-Found</th><th>As-Left</th><th>Date</th><th>Interval</th><th>Next Due</th><th>Tech</th><th>Notes</th></tr></thead><tbody></tbody></table>
      <p class="muted">Stored locally on this device.</p>
    </section>

    <!-- Loop Check Log -->
    <section id="loop">
      <h2>Loop Check Log</h2>
      <form id="loopForm">
        <div class="row">
          <div class="col"><input id="tag" placeholder="Tag" required></div>
          <div class="col"><input id="service" placeholder="Service"></div>
          <div class="col"><select id="type"><option>AI</option><option>AO</option><option>DI</option><option>DO</option></select></div>
        </div>
        <div class="row">
          <div class="col"><input id="rangeLrv" class="num" inputmode="decimal" placeholder="LRV"></div>
          <div class="col"><input id="rangeUrv" class="num" inputmode="decimal" placeholder="URV"></div>
          <div class="col"><input id="date" type="date" placeholder="Date"></div>
        </div>
        <div class="row">
          <div class="col"><input id="asFound" placeholder="As-Found"></div>
          <div class="col"><input id="asLeft" placeholder="As-Left"></div>
          <div class="col"><input id="tech" placeholder="Technician"></div>
        </div>
        <div class="row">
          <div class="col" style="flex:1 1 100%"><input id="notes" placeholder="Notes"></div>
          <div class="col"><select id="status"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        </div>
        <div class="row">
          <div class="col"><button class="btn ok" type="submit">Add</button></div>
          <div class="col"><button class="btn" type="button" onclick="downloadLoopCSV()">Export CSV</button></div>
          <div class="col"><button class="btn" type="button" id="loop_tpl">CSV Template</button></div>
          <div class="col"><button class="btn" type="button" id="loop_import_btn">Import CSV</button><input id="loop_import" type="file" accept=".csv" class="hidden"></div>
          <div class="col"><button class="btn danger" type="button" onclick="clearLoop()">Clear All (local)</button></div>
        </div>
      </form>
      <div class="row">
        <div class="col"><input id="loop_filter_tag" placeholder="Filter by tag (optional)"></div>
        <div class="col"><button class="btn" type="button" onclick="applyLoopFilter()">Apply Filter</button></div>
      </div>
      <table id="loopTable"><thead><tr><th>Date</th><th>Tag</th><th>Service</th><th>Type</th><th>LRV</th><th>URV</th><th>As-Found</th><th>As-Left</th><th>Tech</th><th>Status</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- Tickets -->
    <section id="tickets">
      <h2>Tickets</h2>
      <div class="row">
        <div class="col"><input id="t_title" placeholder="Title"></div>
        <div class="col"><input id="t_system" placeholder="System/Tag"></div>
        <div class="col"><select id="t_sev"><option>Low</option><option>Med</option><option>High</option></select></div>
      </div>
      <div class="row">
        <div class="col"><select id="t_status"><option>Open</option><option>Blocked</option><option>Done</option></select></div>
        <div class="col"><input id="t_assignee" placeholder="Assignee"></div>
        <div class="col"><input id="t_date" type="date"></div>
      </div>
      <div class="row"><div class="col" style="flex:1 1 100%"><textarea id="t_notes" placeholder="Notes"></textarea></div></div>
      <div class="row"><div class="col"><input id="t_photos" type="file" accept="image/*" multiple capture="environment"></div></div>
      <div class="row">
        <div class="col"><button class="btn ok" id="t_add">Add Ticket</button></div>
        <div class="col"><button class="btn" id="t_export">Export CSV</button></div>
        <div class="col"><button class="btn danger" id="t_clear">Clear All (local)</button></div>
      </div>
      <div class="hr"></div>
      <table id="t_table"><thead><tr><th>Title</th><th>System/Tag</th><th>Severity</th><th>Status</th><th>Assignee</th><th>Date</th><th>Notes</th><th>Photos</th><th>Actions</th></tr></thead><tbody></tbody></table>
      <p class="muted">Photos are stored locally as thumbnails; CSV lists counts.</p>
    </section>

    <!-- QR Scan -->
    <section id="qr">
      <h2>QR Scan</h2>
      <p class="muted">Scan a QR with a tag (or a URL query like <code>?tag=PT-101</code>) and we’ll filter the Loop Log.</p>
      <div class="row">
        <div class="col"><button class="btn" id="qr_live_btn">Start Live Scan</button></div>
        <div class="col"><button class="btn" id="qr_photo_btn">Scan from Photo</button><input id="qr_photo" type="file" accept="image/*" capture="environment" class="hidden"></div>
      </div>
      <video id="qr_video" class="hidden" autoplay playsinline style="width:100%; max-width:420px; border-radius:8px; border:1px solid var(--border);"></video>
      <p id="qr_result" class="muted"></p>
    </section>

    <!-- Backup -->
    <section id="backup">
      <h2>Backup & Restore</h2>
      <p class="muted">Backup all (Calibration + Loop + Tickets) to JSON. Restore later on any device.</p>
      <div class="row">
        <div class="col"><button class="btn" id="bk_export">Export All (JSON)</button></div>
        <div class="col"><button class="btn" id="bk_import_btn">Import All (JSON)</button><input id="bk_import" type="file" accept=".json,application/json" class="hidden"></div>
        <div class="col"><button class="btn danger" id="bk_clear">Clear All (local)</button></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings">
      <h2>Settings</h2>
      <div class="row">
        <div class="col"><label>Default Atmosphere (psia) <input id="s_atm" class="num" inputmode="decimal" placeholder="14.7"></label><button class="kbd-toggle" data-for="s_atm">kbd</button></div>
        <div class="col"><label>Default Pressure Unit <select id="s_punit"><option value="psi">psi</option><option value="kpa">kPa</option><option value="bar">bar</option></select></label></div>
        <div class="col"><label>Default Level Unit <select id="s_lunit"><option value="in">in</option><option value="ft">ft</option><option value="m">m</option></select></label></div>
      </div>
      <div class="row">
        <div class="col"><label class="rowline"><input type="checkbox" id="s_haptics"> Haptics on keypad taps</label></div>
        <div class="col"><label class="rowline"><input type="checkbox" id="s_dark"> Force dark mode</label></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn ok" id="s_save">Save</button></div>
        <div class="col"><button class="btn danger" id="s_reset">Reset to defaults</button></div>
      </div>
      <p class="muted">Settings are stored locally on this device.</p>
    </section>
  </main>

  <script>
  // ---------- Number Pad (floating + auto-docking) ----------
  const numpad = document.getElementById('numpad');
  let npTarget = null, npFlip = false;

  function buzz(ms=10){ try{ if(getS().haptics && navigator.vibrate) navigator.vibrate(ms); }catch{} }

  function padDims(){ // approximate height from grid rows; safer to measure
    const rect = numpad.getBoundingClientRect();
    return { w: rect.width || 320, h: rect.height || 260 };
  }

  function computePadPosition(inputEl){
    const r = inputEl.getBoundingClientRect();
    const pad = padDims();
    const gap = 8;
    const vw = window.innerWidth, vh = window.innerHeight;

    let left = Math.max(8, Math.min(r.left, vw - pad.w - 8));
    // prefer same width as input (but clamp to pad max)
    const idealW = Math.min(Math.max(r.width, 260), Math.min(520, vw - 16));
    numpad.style.width = idealW + 'px';

    // default: below
    let top = r.bottom + gap;
    npFlip = false;
    if (top + pad.h + 12 > vh) { // not enough space below -> flip above
      top = r.top - pad.h - gap;
      npFlip = true;
    }

    // caret
    const caret = 10;
    numpad.style.left = Math.round(left) + 'px';
    numpad.style.top  = Math.round(top)  + 'px';
    numpad.style.setProperty('--caret-offset', Math.round(Math.min(Math.max(16, (r.left - left) + Math.min(r.width, idealW)/2), idealW - 16)) + 'px');

    // place caret triangle
    const after = numpad.style;
    const caretPos = parseInt(getComputedStyle(numpad).getPropertyValue('--caret-offset') || '24');
    after.setProperty('--caret-left', caretPos + 'px');
    numpad.style.setProperty('clip-path',''); // reset any old hacks

    // style the ::after triangle location
    numpad.style.setProperty('--caret-left', caretPos + 'px');
    // position caret depending on flip
    numpad.style.setProperty('--caret-top', npFlip ? (pad.h - caret/2 - 1) + 'px' : (-caret/2) + 'px');
    numpad.style.setProperty('--caret-rotate', npFlip ? '225deg' : '45deg');
    numpad.style.setProperty('--caret-display', 'block');
    numpad.style.setProperty('--caret-size', caret + 'px');
  }

  // Inject caret positioning via inline style (works across browsers)
  const numpadStyle = document.createElement('style');
  numpadStyle.textContent = `
    #numpad::after {
      left: var(--caret-left, 24px);
      top: var(--caret-top, -7px);
      transform: rotate(var(--caret-rotate, 45deg));
      display: var(--caret-display, block);
      width: var(--caret-size, 14px); height: var(--caret-size, 14px);
    }
  `;
  document.head.appendChild(numpadStyle);

  function showPad(forInput){
    npTarget = forInput;
    // prevent iOS auto-scroll by focusing first, then positioning
    try { npTarget.focus({ preventScroll: true }); } catch {}
    numpad.classList.add('show'); numpad.setAttribute('aria-hidden','false');
    // size may change once visible, then position
    requestAnimationFrame(()=> computePadPosition(npTarget));
    // keep caret at end
    const v = npTarget.value; try{ npTarget.setSelectionRange(v.length, v.length); }catch{}
  }

  function hidePad(){
    numpad.classList.remove('show'); numpad.setAttribute('aria-hidden','true');
    npTarget = null;
  }

  function insertVal(s){
    if(!npTarget) return;
    buzz(8);
    const el=npTarget;
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    let v = el.value;
    if(s==='.' && v.includes('.')) return;
    if(s==='-'){ v = v.startsWith('-') ? v.slice(1) : ('-'+v); el.value=v; el.dispatchEvent(new Event('input',{bubbles:true})); return; }
    el.value = v.slice(0,start) + s + v.slice(end);
    const pos = start + s.length;
    try{ el.setSelectionRange(pos,pos); }catch{}
    el.dispatchEvent(new Event('input',{bubbles:true}));
  }

  function wireNumpadFloating(){
    // make .num fields readOnly and attach handlers
    document.querySelectorAll('input.num').forEach(inp=>{
      inp.readOnly = true;
      inp.addEventListener('focus', ()=> showPad(inp));
      inp.addEventListener('click', ()=> showPad(inp));
      // reposition while typing via hardware keyboard (if toggled)
      inp.addEventListener('input', ()=> { if(numpad.classList.contains('show')) computePadPosition(inp); });
    });

    // optional keyboard toggle buttons
    document.querySelectorAll('.kbd-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-for'); const el = document.getElementById(id);
        if(!el) return;
        el.readOnly = !el.readOnly;
        if(!el.readOnly){ hidePad(); el.focus(); } else { el.blur(); }
        btn.textContent = el.readOnly ? 'kbd' : 'done';
      });
    });

    // outside tap closes pad
    document.addEventListener('pointerdown', (e)=>{
      if(!numpad.classList.contains('show')) return;
      const withinPad = e.target.closest('#numpad');
      const withinNum = e.target.closest('input.num');
      if(!withinPad && !withinNum){ hidePad(); }
    });

    // reposition on scroll/resize
    window.addEventListener('scroll', ()=> { if(npTarget && numpad.classList.contains('show')) computePadPosition(npTarget); }, {passive:true});
    window.addEventListener('resize', ()=> { if(npTarget && numpad.classList.contains('show')) computePadPosition(npTarget); });
  }

  // keypad button clicks
  numpad.addEventListener('click', (e)=>{
    const btn = e.target.closest('.np-btn'); if(!btn||!npTarget) return;
    const act = btn.dataset.act; const explicitVal = btn.dataset.val;
    if(act==='back'){
      const el=npTarget; const start=el.selectionStart??el.value.length; const end=el.selectionEnd??el.value.length;
      if(start!==end){ el.value = el.value.slice(0,start) + el.value.slice(end); try{ el.setSelectionRange(start,start); }catch{} el.dispatchEvent(new Event('input',{bubbles:true})); return; }
      if(start>0){ el.value = el.value.slice(0,start-1) + el.value.slice(start); try{ el.setSelectionRange(start-1,start-1);}catch{} el.dispatchEvent(new Event('input',{bubbles:true})); }
      return;
    }
    if(act==='clear'){ npTarget.value=''; npTarget.dispatchEvent(new Event('input',{bubbles:true})); return; }
    if(act==='done'){ hidePad(); return; }
    const text = explicitVal || btn.textContent.trim();
    insertVal(text);
  });

  // call this instead of the old wireNumpad()
  wireNumpadFloating();
</script>
  
    // ------- Settings store -------
    const SKEY='pocketech.settings';
    const DEF={atm:14.7,punit:'psi',lunit:'in',haptics:false,theme:'auto'};
    const getS=()=>({...DEF, ...(JSON.parse(localStorage.getItem(SKEY)||'{}'))});
    const setS=(o)=>localStorage.setItem(SKEY, JSON.stringify(o));

    // ------- Theme toggle -------
    const themeBtn=document.getElementById('themeToggle');
    const root=document.documentElement;
    function applyTheme(t){ root.setAttribute('data-theme',t); }
    function syncThemeFromSettings(){ const s=getS(); applyTheme(s.theme); }
    syncThemeFromSettings();
    themeBtn.addEventListener('click',()=>{
      const s=getS(); s.theme = s.theme==='auto'?'dark':(s.theme==='dark'?'light':'auto'); setS(s); applyTheme(s.theme); alert('Theme: '+s.theme);
    });

    // PWA: install
    let deferredPrompt=null;
    const installBtn=document.getElementById('installBtn');
    installBtn.disabled=true;
    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.disabled=false; });
    installBtn.addEventListener('click', async ()=>{
      if(!deferredPrompt) return alert('Install not available here. Try from Chrome mobile.');
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.disabled=true;
    });
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

    // Router
    document.querySelectorAll('nav button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
        btn.classList.add('active'); document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // Helpers
    function toCSV(rows){return rows.map(r=>r.map(c=>{const s=(c??'').toString();return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n');}
    function downloadCSV(filename, rows){ const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
    const fmt=n=>{const x=Number(n); if(!Number.isFinite(x)) return ''; return (Math.abs(x)>=1000||x===0)?x.toFixed(2).replace(/\.00$/,''):x.toFixed(4).replace(/0+$/,'').replace(/\.$/,'');};
    function val(id){return document.getElementById(id).value;}
    function setVal(id,v){document.getElementById(id).value=v;}

    // Haptics
    function buzz(ms=10){ try{ if(getS().haptics && navigator.vibrate) navigator.vibrate(ms); }catch{} }

    // ---------- Number Pad (sticky) ----------
    const numpad = document.getElementById('numpad');
    let npTarget = null;
    function showPad(forInput){
      npTarget = forInput;
      document.body.style.paddingBottom = '280px';
      numpad.classList.add('show'); numpad.setAttribute('aria-hidden','false');
      setTimeout(()=>{ try{ npTarget.scrollIntoView({block:'center', behavior:'smooth'}); }catch{} }, 10);
      const v = npTarget.value; try{ npTarget.setSelectionRange(v.length, v.length); }catch{}
    }
    function hidePad(){
      numpad.classList.remove('show'); numpad.setAttribute('aria-hidden','true');
      document.body.style.paddingBottom = '';
      npTarget = null;
    }
    function insertVal(s){
      if(!npTarget) return;
      buzz(8);
      const el=npTarget;
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      let v = el.value;
      if(s==='.' && v.includes('.')) return;
      if(s==='-'){ v = v.startsWith('-') ? v.slice(1) : ('-'+v); el.value=v; return; }
      el.value = v.slice(0,start) + s + v.slice(end);
      const pos = start + s.length;
      try{ el.setSelectionRange(pos,pos); }catch{}
    }
    function wireNumpad(){
      document.querySelectorAll('input.num').forEach(inp=>{
        inp.readOnly = true;
        inp.addEventListener('focus', ()=> showPad(inp));
        inp.addEventListener('click', ()=> showPad(inp));
      });
      document.querySelectorAll('.kbd-toggle').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-for'); const el = document.getElementById(id);
          if(!el) return;
          el.readOnly = !el.readOnly;
          if(!el.readOnly){ hidePad(); el.focus(); } else { el.blur(); }
          btn.textContent = el.readOnly ? 'kbd' : 'done';
        });
      });
      document.addEventListener('click', (e)=>{
        if(!numpad.classList.contains('show')) return;
        const withinPad = e.target.closest('#numpad');
        const withinNum = e.target.closest('input.num');
        if(!withinPad && !withinNum){ hidePad(); }
      });
    }
    numpad.addEventListener('click', (e)=>{
      const btn = e.target.closest('.np-btn'); if(!btn||!npTarget) return;
      const act = btn.dataset.act; const explicitVal = btn.dataset.val;
      if(act==='back'){
        const el=npTarget; const start=el.selectionStart??el.value.length; const end=el.selectionEnd??el.value.length;
        if(start!==end){ el.value = el.value.slice(0,start) + el.value.slice(end); try{ el.setSelectionRange(start,start); }catch{} return; }
        if(start>0){ el.value = el.value.slice(0,start-1) + el.value.slice(start); try{ el.setSelectionRange(start-1,start-1);}catch{} }
        return;
      }
      if(act==='clear'){ npTarget.value=''; return; }
      if(act==='done'){ hidePad(); return; }
      const text = explicitVal || btn.textContent.trim();
      insertVal(text);
      npTarget.dispatchEvent(new Event('input',{bubbles:true}));
    });

    // ---------- Percent ----------
    function calcPercent(){
      const L=parseFloat(val('lrv')); const U=parseFloat(val('urv'));
      if(isNaN(L)||isNaN(U)||L===U){ alert('Enter valid LRV/URV'); return; }
      const steps=[0,25,50,75,100];
      const rows=[['%','EU']];
      steps.forEach(p=> rows.push([p+'%', fmt(L+(U-L)*(p/100))]));
      const t=document.getElementById('percentTable');
      t.innerHTML = rows.map((r,i)=>`<tr>${r.map(c=>`<${i?'td':'th'}>${c}</${i?'td':'th'}>`).join('')}</tr>`).join('');
    }
    function exportPercentCSV(){
      const L=parseFloat(val('lrv')); const U=parseFloat(val('urv')); if(isNaN(L)||isNaN(U)||L===U){ alert('Enter valid LRV/URV'); return; }
      const rows=[['%','EU'],['0%',L],['25%',L+(U-L)*.25],['50%',L+(U-L)*.5],['75%',L+(U-L)*.75],['100%',U]];
      downloadCSV('percent_steps.csv', rows);
    }

    // ---------- Signal (nice) ----------
    function sh_getRange(){ const l=parseFloat(val('sh_lrv')), u=parseFloat(val('sh_urv')); if(isNaN(l)||isNaN(u)||l===u){ alert('Enter valid LRV/URV'); return null; } return {l,u}; }
    function fmtEUlabel(){ const lbl = document.getElementById('sh_eulbl').value.trim(); return lbl?(' '+lbl):''; }
    function sh_updateFromPct(p){
      const r=sh_getRange(); if(!r) return;
      const sqrt = document.getElementById('sqrt_mode').checked;
      const pct = Math.min(Math.max(Number(p),0),100);
      const ma = 4 + 16*(pct/100);
      let eu;
      if(!sqrt){ eu = r.l + (r.u - r.l)*(pct/100); }
      else { const euNorm = Math.sqrt(pct/100); eu = r.l + (r.u - r.l)*euNorm; }
      setVal('sh_pct', fmt(pct));
      setVal('sh_ma', fmt(ma));
      setVal('sh_eu', fmt(eu));
      document.getElementById('read_ma').textContent = fmt(ma);
      document.getElementById('read_pct').textContent = fmt(pct)+'%';
      document.getElementById('read_eu').textContent = fmt(eu)+fmtEUlabel();
      document.getElementById('pct_slider').value = pct;
    }
    function sh_fromMA(){ const r=sh_getRange(); if(!r) return; const m=parseFloat(val('sh_ma')); if(isNaN(m)){alert('Enter mA');return;} const pct = Math.min(Math.max((m-4)/16*100,0),100); sh_updateFromPct(pct); }
    function sh_fromPct(){ const p=parseFloat(val('sh_pct')); if(isNaN(p)){alert('Enter %');return;} sh_updateFromPct(p); }
    function sh_fromEU(){ const r=sh_getRange(); if(!r) return; const e=parseFloat(val('sh_eu')); if(isNaN(e)){alert('Enter EU');return;} const sqrt=document.getElementById('sqrt_mode').checked; let pct; if(!sqrt){ pct = (e - r.l)/(r.u - r.l)*100; } else { const euNorm=(e - r.l)/(r.u - r.l); pct = Math.pow(Math.max(euNorm,0),2)*100; } sh_updateFromPct(pct); }
    document.getElementById('sh_from_ma').addEventListener('click', sh_fromMA);
    document.getElementById('sh_from_pct').addEventListener('click', sh_fromPct);
    document.getElementById('sh_from_eu').addEventListener('click', sh_fromEU);
    document.getElementById('pct_slider').addEventListener('input', e=> sh_updateFromPct(e.target.value));
    document.getElementById('sqrt_mode').addEventListener('change', ()=> { const p = parseFloat(document.getElementById('pct_slider').value||'0'); sh_updateFromPct(p); });
    document.querySelectorAll('.step').forEach(b=> b.addEventListener('click',()=> sh_updateFromPct(b.dataset.p)));
    document.querySelectorAll('.copy').forEach(c=>{
      c.addEventListener('click', async ()=>{
        const sel = c.getAttribute('data-copy'); const el = document.querySelector(sel);
        if(!el) return; try{ await navigator.clipboard.writeText(el.textContent.trim()); c.textContent='copied'; setTimeout(()=>c.textContent='copy', 900);}catch{}
      });
    });

    // ---------- Pressure ----------
    const INH2O_PER_PSI=27.679904842545, KPA_PER_PSI=6.894757293168;
    const P2PA = { pa:1, kpa:1000, mpa:1_000_000, bar:100000, psi:6894.757293168, inh2o:249.08891, mmh2o:9.80665, inhg:3386.389, mmhg:133.322387415 };
    function convertPressure(valV, from, to){ if(!Number.isFinite(valV)) return ''; const pa = valV * P2PA[from]; return pa / P2PA[to]; }
    document.getElementById('pc_convert').addEventListener('click', ()=>{
      const v=parseFloat(val('pc_val_in')); if(isNaN(v)){ alert('Enter a value to convert'); return; }
      const from=document.getElementById('pc_unit_in').value; const to=document.getElementById('pc_unit_out').value;
      setVal('pc_val_out', fmt(convertPressure(v, from, to)));
    });
    document.getElementById('pc_swap').addEventListener('click', ()=>{
      const a=document.getElementById('pc_unit_in'); const b=document.getElementById('pc_unit_out'); const tmp=a.value; a.value=b.value; b.value=tmp;
    });
    function psigToPsia(){const a=parseFloat(val('atm')), g=parseFloat(val('psig')); if(isNaN(a)||isNaN(g)){alert('Enter atm and psig');return;} setVal('psia',fmt(a+g));}
    function psiaToPsig(){const a=parseFloat(val('atm')), p=parseFloat(val('psia')); if(isNaN(a)||isNaN(p)){alert('Enter atm and psia');return;} setVal('psig',fmt(p-a));}
    function fromPSI(){const p=parseFloat(val('u_psi')); if(isNaN(p)){alert('Enter psi');return;} setVal('u_kpa',fmt(p*KPA_PER_PSI)); setVal('u_bar',fmt(p*0.06894757));}
    function fromKPA(){const k=parseFloat(val('u_kpa')); if(isNaN(k)){alert('Enter kPa');return;} const psi=k/KPA_PER_PSI; setVal('u_psi',fmt(psi)); setVal('u_bar',fmt(psi*0.06894757));}
    function fromBAR(){const b=parseFloat(val('u_bar')); if(isNaN(b)){alert('Enter bar');return;} const psi=b/0.06894757; setVal('u_psi',fmt(psi)); setVal('u_kpa',fmt(psi*KPA_PER_PSI));}
    function calcSwitch(){
      const sp=parseFloat(val('sw_set')); const db=parseFloat(val('sw_db')); const mode=document.getElementById('sw_mode').value;
      if(isNaN(sp)||isNaN(db)||db<0){ alert('Enter setpoint and deadband ≥ 0'); return; }
      const openOnRise = (mode==='nc');
      const rows = [['Contact','Action','Pressure'],[openOnRise?'NC':'NO',openOnRise?'opens':'closes',fmt(sp)+' psig'],[openOnRise?'NC':'NO',openOnRise?'closes':'opens',fmt(sp-db)+' psig']];
      const tb=document.querySelector('#sw_out tbody'); tb.innerHTML=''; rows.forEach((r,i)=> tb.insertAdjacentHTML('beforeend', `<tr>${r.map(c=>`<${i?'td':'th'}>${c}</${i?'td':'th'}>`).join('')}</tr>`));
    }
    function fromInHg(){ const inhg=parseFloat(val('vac_inhg')); const atmPsia=parseFloat(val('atm')); if(isNaN(inhg)||isNaN(atmPsia)){alert('Enter inHg and atm psia');return;} const psia = atmPsia - (inhg * atmPsia / 29.92); const psig = psia - atmPsia; setVal('vac_psia',fmt(psia)); setVal('vac_psig',fmt(psig)); }
    function fromPSIA(){ const psia=parseFloat(val('vac_psia')); const atmPsia=parseFloat(val('atm')); if(isNaN(psia)||isNaN(atmPsia)){alert('Enter psia and atm');return;} const inhg = (atmPsia-psia) * (29.92/atmPsia); const psig = psia - atmPsia; setVal('vac_inhg',fmt(inhg)); setVal('vac_psig',fmt(psig)); }
    function fromPSIG(){ const psig=parseFloat(val('vac_psig')); const atmPsia=parseFloat(val('atm')); if(isNaN(psig)||isNaN(atmPsia)){alert('Enter psig and atm');return;} const psia = psig + atmPsia; const inhg = (atmPsia-psia) * (29.92/atmPsia); setVal('vac_psia',fmt(psia)); setVal('vac_inhg',fmt(inhg)); }

    // ---------- Level ----------
    function pctToDP(p, LRV, URV){ return LRV + (URV-LRV)*(p/100); }
    function pctToMA(p){ return 4 + 16*(p/100); }
    function maToPct(ma){ return (ma-4)/16*100; }

    // Open
    const IN_PER_FT=12, IN_PER_M=39.37007874;
    function LO_cfg(){
      const s=getS();
      const span=parseFloat(val('lo_span')); const u=document.getElementById('lo_units').value||s.lunit; const sg=parseFloat(val('lo_sg')||'1'); const dpU=document.getElementById('lo_dpU').value;
      if(isNaN(span)||span<=0||isNaN(sg)||sg<=0){ alert('Enter span and SG'); return null; }
      let spanIn=span; if(u==='ft') spanIn*=IN_PER_FT; if(u==='m') spanIn*=IN_PER_M;
      const urv_inh2o = sg*spanIn;
      let LRV = parseFloat(val('lo_lrv')); if(isNaN(LRV)) LRV=0;
      let URV = parseFloat(val('lo_urv'));
      if(isNaN(URV)) URV = (dpU==='inh2o')?urv_inh2o:(dpU==='psi'? urv_inh2o/27.679904842545 : (urv_inh2o/27.679904842545)*6.894757293168 );
      return {span, u, spanIn, sg, dpU, LRV, URV};
    }
    function LO_levelToMa(){ const c=LO_cfg(); if(!c) return; const lvl=parseFloat(val('lo_lvl')); if(isNaN(lvl)){alert('Enter level');return;} let lvlIn=lvl; if(c.u==='ft') lvlIn*=IN_PER_FT; if(c.u==='m') lvlIn*=IN_PER_M; const pct=Math.min(Math.max((lvlIn/c.spanIn)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct); document.getElementById('lo_result').innerText = `Level ${fmt(lvl)} ${c.u} → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → ${fmt(ma)} mA`; }
    function LO_maToLevel(){ const c=LO_cfg(); if(!c) return; const ma=parseFloat(val('lo_ma')); if(isNaN(ma)){alert('Enter mA');return;} const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV); let lvlIn=(pct/100)*c.spanIn; let lvl=lvlIn; if(c.u==='ft') lvl=lvlIn/IN_PER_FT; if(c.u==='m') lvl=lvlIn/IN_PER_M; document.getElementById('lo_result').innerText = `${fmt(ma)} mA → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → Level ${fmt(lvl)} ${c.u}`; }
    function LO_buildSteps(){ const c=LO_cfg(); if(!c) return; const steps=[0,25,50,75,100]; const tb=document.querySelector('#lo_steps tbody'); tb.innerHTML=''; steps.forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend', `<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`); }); }

    // Closed
    function LC_inches(valU, u){ if(u==='in') return valU; if(u==='ft') return valU*IN_PER_FT; if(u==='m') return valU*IN_PER_M; return valU; }
    function LC_cfg(){
      const s=getS();
      const span=parseFloat(val('lc_span')); const u=(document.getElementById('lc_units').value)||s.lunit;
      const sgL=parseFloat(val('lc_sgL')||'1'); const leg=document.getElementById('lc_leg').value;
      const wetH=parseFloat(val('lc_wetH')||'0'); const sgW=parseFloat(val('lc_sgW')||'1'); const dpU=document.getElementById('lc_dpU').value;
      if(isNaN(span)||span<=0||isNaN(sgL)||sgL<=0){ alert('Enter span and liquid SG'); return null; }
      const span_in = LC_inches(span, u);
      const dP0_inH2O = (leg==='wet') ? (0 - sgW*(wetH||0)) : 0;
      const dP100_inH2O = (sgL*span_in) - (leg==='wet' ? sgW*(wetH||0) : 0);
      let LRV=parseFloat(val('lc_lrv')); if(isNaN(LRV)) LRV = (dpU==='inh2o')?dP0_inH2O:(dpU==='psi'? dP0_inH2O/27.679904842545 : (dP0_inH2O/27.679904842545)*6.894757293168);
      let URV=parseFloat(val('lc_urv')); if(isNaN(URV)) URV = (dpU==='inh2o')?dP100_inH2O:(dpU==='psi'? dP100_inH2O/27.679904842545 : (dP100_inH2O/27.679904842545)*6.894757293168);
      return {span, u, span_in, sgL, leg, wetH, sgW, dpU, LRV, URV};
    }
    function LC_levelToMa(){ const c=LC_cfg(); if(!c) return; const lvl=parseFloat(val('lc_lvl')); if(isNaN(lvl)){alert('Enter level');return;} const lvl_in = LC_inches(lvl, c.u); const pct=Math.min(Math.max((lvl_in/c.span_in)*100,0),100); const dp=pctToDP(pct,c.LRV,c.URV); const ma=pctToMA(pct); document.getElementById('lc_result').innerText = `Level ${fmt(lvl)} ${c.u} → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → ${fmt(ma)} mA`; }
    function LC_maToLevel(){ const c=LC_cfg(); if(!c) return; const ma=parseFloat(val('lc_ma')); if(isNaN(ma)){alert('Enter mA');return;} const pct=Math.min(Math.max(maToPct(ma),0),100); const dp=pctToDP(pct,c.LRV,c.URV); const lvl_in=(pct/100)*c.span_in; let lvl=lvl_in; if(c.u==='ft') lvl=lvl_in/IN_PER_FT; if(c.u==='m') lvl=lvl_in/IN_PER_M; document.getElementById('lc_result').innerText = `${fmt(ma)} mA → ${fmt(pct)}% → ${fmt(dp)} ${c.dpU} → Level ${fmt(lvl)} ${c.u}`; }
    function LC_buildSteps(){ const c=LC_cfg(); if(!c) return; const steps=[0,25,50,75,100]; const tb=document.querySelector('#lc_steps tbody'); tb.innerHTML=''; steps.forEach(p=>{ const dp=pctToDP(p,c.LRV,c.URV); const lvl=(p/100)*c.span; tb.insertAdjacentHTML('beforeend', `<tr><td>${p}%</td><td>${fmt(lvl)} ${c.u}</td><td>${fmt(dp)} ${c.dpU}</td><td>${fmt(pctToMA(p))} mA</td></tr>`); }); }

    // ---------- Temp ----------
    function T_toK(v,unit){ if(unit==='C') return v+273.15; if(unit==='F') return (v-32)*5/9+273.15; return v; }
    function K_to(v,unit){ if(unit==='C') return v-273.15; if(unit==='F') return (v-273.15)*9/5+32; return v; }
    document.getElementById('tc_conv_btn').addEventListener('click', ()=>{
      const v=parseFloat(val('tc_val')); if(isNaN(v)){ alert('Enter a temperature'); return; }
      const from=document.getElementById('tc_from').value, to=document.getElementById('tc_to').value;
      const k=T_toK(v, from); setVal('tc_out', fmt(K_to(k, to)));
    });
    document.getElementById('td_conv_btn').addEventListener('click', ()=>{
      const v=parseFloat(val('td_val')); if(isNaN(v)){ alert('Enter ΔT'); return; }
      const from=document.getElementById('td_from').value, to=document.getElementById('td_to').value;
      let c; if(from==='F') c=v*5/9; else if(from==='K') c=v; else c=v;
      let out; if(to==='F') out=c*9/5; else if(to==='K') out=c; else out=c;
      setVal('td_out', fmt(out));
    });

    // ---------- I/P 3–15 ----------
    function ip_fromPct(p){ const psi=3+12*(p/100); setVal('ip_psi', fmt(psi)); document.getElementById('ip_read_pct').textContent=fmt(p)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi'; }
    function ip_fromPsi(psi){ const pct=(psi-3)/12*100; setVal('ip_pct', fmt(pct)); document.getElementById('ip_read_pct').textContent=fmt(pct)+'%'; document.getElementById('ip_read_psi').textContent=fmt(psi)+' psi'; }
    document.getElementById('ip_from_pct').addEventListener('click', ()=>{ const p=parseFloat(val('ip_pct')); if(isNaN(p)){alert('Enter %');return;} ip_fromPct(p); });
    document.getElementById('ip_from_psi').addEventListener('click', ()=>{ const psi=parseFloat(val('ip_psi')); if(isNaN(psi)){alert('Enter psi');return;} ip_fromPsi(psi); });
    document.querySelectorAll('.ipstep').forEach(b=> b.addEventListener('click', ()=> ip_fromPct(parseFloat(b.dataset.p))));

    // ---------- Calibration / Loop / Tickets / Backup (unchanged logic placeholders) ----------
    // (Left as in previous versions — your existing CSV and storage handlers remain)

    // ---------- Settings wiring ----------
    function loadSettingsUI(){
      const s=getS();
      setVal('s_atm', s.atm); document.getElementById('s_punit').value=s.punit; document.getElementById('s_lunit').value=s.lunit;
      document.getElementById('s_haptics').checked=!!s.haptics; document.getElementById('s_dark').checked=(s.theme==='dark');
      // apply to Pressure defaults
      setVal('atm', s.atm);
    }
    loadSettingsUI();
    document.getElementById('s_save').addEventListener('click', ()=>{
      const s=getS();
      const atm=parseFloat(val('s_atm')); if(!isNaN(atm)) s.atm=atm;
      s.punit=document.getElementById('s_punit').value;
      s.lunit=document.getElementById('s_lunit').value;
      s.haptics=document.getElementById('s_haptics').checked;
      s.theme=document.getElementById('s_dark').checked?'dark':'auto';
      setS(s); syncThemeFromSettings(); setVal('atm', s.atm); alert('Saved.');
    });
    document.getElementById('s_reset').addEventListener('click', ()=>{ setS(DEF); loadSettingsUI(); syncThemeFromSettings(); alert('Settings reset.'); });

    // ---------- Init ----------
    wireNumpad();
    // Signal defaults
    document.getElementById('pct_slider').value = 50;
    document.getElementById('sh_pct').value = 50;
    document.getElementById('read_pct').textContent = '50%';
    document.getElementById('read_ma').textContent = '12';
    // Pressure default atm
    setVal('atm', getS().atm);
  </script>
</body>
</html>
